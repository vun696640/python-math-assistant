<!DOCTYPE html>
<html lang="vi">
<head>
  <script>
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$', '$$']]
    },
    svg: { fontCache: 'global' }
  };
</script>
<script id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

  <meta charset="UTF-8">
  <title>K9 Math AI Assistant ‚Äì Chat</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root {
      --bg-main: #050816;
      --bg-chat: #0b1020;
      --bg-msg-user: #1f2937;
      --bg-msg-assistant: #111827;
      --accent: #10b981;
      --accent-soft: rgba(16,185,129,0.15);
      --border-subtle: #374151;
      --text-main: #e5e7eb;
      --text-soft: #9ca3af;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text-main);
      background: radial-gradient(circle at top, #1f2937 0, #020617 55%, #000 100%);
    }
    .layout {
      display: flex;
      width: 100%;
      height: 100%;
    }
    /* Sidebar */
    .sidebar {
      width: 260px;
      background: #020617;
      border-right: 1px solid #111827;
      padding: 12px 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .sidebar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 4px 6px 0;
    }
    .logo {
      font-size: 14px;
      font-weight: 600;
      color: #f9fafb;
    }
    .subtitle {
      font-size: 11px;
      color: var(--text-soft);
    }
    .new-chat-btn {
      margin-top: 8px;
      width: 100%;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #374151;
      background: linear-gradient(to right, #111827, #020617);
      color: #e5e7eb;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }
    .new-chat-btn span.icon {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: var(--accent-soft);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }
    .new-chat-btn:hover {
      border-color: var(--accent);
    }
    .chat-list {
      flex: 1;
      margin-top: 4px;
      overflow-y: auto;
      padding-right: 2px;
    }
    .chat-item {
      padding: 8px 10px;
      border-radius: 8px;
      margin-bottom: 4px;
      font-size: 13px;
      color: var(--text-soft);
      display: flex;
      flex-direction: column;
      gap: 2px;
      cursor: pointer;
    }
    .chat-item.active {
      background: linear-gradient(to right, rgba(16,185,129,0.18), rgba(15,23,42,0.9));
      color: #f9fafb;
    }
    .chat-item-title {
      font-weight: 500;
    }
    .chat-item-sub {
      font-size: 11px;
    }
    .sidebar-footer {
      padding: 8px 6px;
      border-top: 1px solid #111827;
      font-size: 11px;
      color: #6b7280;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      padding: 2px 7px;
      font-size: 10px;
      background: rgba(31,41,55,0.9);
      margin-right: 4px;
      margin-bottom: 2px;
    }
    .badge span.dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      margin-right: 4px;
      background: var(--accent);
    }

    /* Main */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .main-header {
      padding: 10px 16px;
      border-bottom: 1px solid #111827;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(15,23,42,0.9);
      backdrop-filter: blur(10px);
      gap: 8px;
    }
    .main-header-title {
      font-size: 13px;
      font-weight: 500;
      display: flex;
      flex-direction: column;
    }
    .main-header-title span.sub {
      font-size: 11px;
      color: var(--text-soft);
    }
    .header-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
      max-width: 55%;
    }
    .tag-list {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      justify-content: flex-end;
    }
    .tag-chip {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(16,185,129,0.15);
      color: #a7f3d0;
      border: 1px solid rgba(16,185,129,0.35);
    }
    .header-actions {
      display: flex;
      gap: 6px;
    }
    .header-btn {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #374151;
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .header-btn span.icon {
      font-size: 12px;
    }
    .header-btn:hover {
      border-color: var(--accent);
    }
    .header-btn:disabled {
      opacity: 0.5;
      cursor: default;
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px 18px 8px;
      background: radial-gradient(circle at top, #111827 0, #020617 45%, #000 100%);
    }
    .message-row {
      margin-bottom: 12px;
      display: flex;
    }
    .message-row.assistant { justify-content: flex-start; }
    .message-row.user { justify-content: flex-end; }

    .message-bubble {
      max-width: 70%;
      padding: 10px 12px;
      border-radius: 16px;
      font-size: 14px;
      line-height: 1.45;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .assistant .message-bubble {
      background: var(--bg-msg-assistant);
      border: 1px solid #1f2937;
    }
    .user .message-bubble {
      background: var(--bg-msg-user);
      border: 1px solid #374151;
    }
    .message-meta {
      font-size: 10px;
      color: var(--text-soft);
      margin-bottom: 2px;
      padding: 0 4px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .avatar {
      width: 20px;
      height: 20px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-right: 6px;
      font-size: 12px;
    }
    .avatar.assistant {
      background: rgba(16,185,129,0.15);
      color: #6ee7b7;
    }
    .avatar.user {
      background: rgba(59,130,246,0.15);
      color: #bfdbfe;
    }

    .input-bar {
      padding: 10px 16px 14px;
      border-top: 1px solid #111827;
      background: radial-gradient(circle at top, #020617 0, #000 100%);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .input-top {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: var(--text-soft);
      gap: 8px;
      flex-wrap: wrap;
    }
    .input-row {
      display: flex;
      align-items: flex-end;
      gap: 8px;
    }
    .input-box-wrap {
      flex: 1;
      position: relative;
    }
    .input-box {
      width: 100%;
      padding: 10px 40px 10px 12px;
      border-radius: 999px;
      border: 1px solid #374151;
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      font-size: 14px;
      resize: none;
      max-height: 100px;
      min-height: 40px;
      outline: none;
    }
    .input-box::placeholder {
      color: #6b7280;
    }
    .input-actions-right {
      position: absolute;
      right: 6px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .icon-btn {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      border: none;
      background: transparent;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #9ca3af;
      font-size: 14px;
    }
    .icon-btn:hover {
      background: rgba(31,41,55,0.9);
      color: #e5e7eb;
    }
    .send-btn {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      border: none;
      background: var(--accent);
      color: #022c22;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 16px;
    }
    .send-btn:disabled {
      opacity: 0.4;
      cursor: default;
    }
    .status-line {
      font-size: 11px;
      color: var(--text-soft);
      min-height: 14px;
    }
    .status-line.error {
      color: #fca5a5;
    }

    #file-input {
      display: none;
    }

    /* Test panel */
    .test-panel {
      border-top: 1px solid #111827;
      background: #020617;
      padding: 8px 16px 10px;
      font-size: 12px;
    }
    .test-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      gap: 8px;
    }
    .test-panel-header-title {
      font-weight: 500;
      color: #e5e7eb;
    }
    .test-summary {
      font-size: 11px;
      color: var(--text-soft);
      text-align: right;
    }
    .test-table-wrapper {
      max-height: 200px;
      overflow-y: auto;
      border-radius: 8px;
      border: 1px solid #111827;
      background: #020617;
    }
    table.test-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }
    .test-table th,
    .test-table td {
      padding: 4px 6px;
      border-bottom: 1px solid #111827;
      vertical-align: top;
    }
    .test-table th {
      position: sticky;
      top: 0;
      background: #020617;
      z-index: 1;
    }
    .badge-pass {
      display: inline-flex;
      padding: 1px 5px;
      border-radius: 999px;
      background: rgba(16,185,129,0.15);
      color: #6ee7b7;
      border: 1px solid rgba(16,185,129,0.5);
      font-size: 10px;
    }
    .badge-fail {
      display: inline-flex;
      padding: 1px 5px;
      border-radius: 999px;
      background: rgba(239,68,68,0.12);
      color: #fecaca;
      border: 1px solid rgba(248,113,113,0.7);
      font-size: 10px;
    }

    @media (max-width: 800px) {
      .sidebar {
        display: none;
      }
      .header-right {
        max-width: 60%;
      }
    }
  </style>

  <!-- jsPDF d√πng ƒë·ªÉ xu·∫•t PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"
          integrity="sha512-3cWrdYkRjakGugHgdGXNq35p3xNmPR9U1FVLtZL1YI7DiIP9N6byN1Nsx3Rp3XIanFkFJxuxMxDPZLIFLZhoUw=="
          crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
  <div class="layout">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div>
          <div class="logo">K9 Math AI</div>
          <div class="subtitle">Tr·ª£ l√Ω To√°n 9 ‚Äì AI for Good</div>
        </div>
      </div>
      <button class="new-chat-btn" id="btn-new-chat">
        <span class="icon">+</span>
        <span>Cu·ªôc tr√≤ chuy·ªán m·ªõi</span>
      </button>

      <div class="chat-list" id="chat-list"></div>

      <div class="sidebar-footer">
        <div>Chu·∫©n ƒë·∫ßu ra (T1‚ÄìT15)</div>
        <div style="margin-top:4px;">
          <div class="badge"><span class="dot"></span>T1 ‚Äì S·ªë &amp; l≈©y th·ª´a</div>
          <div class="badge"><span class="dot"></span>T2 ‚Äì T·ªâ l·ªá &amp; ph·∫ßn trƒÉm</div>
          <div class="badge"><span class="dot"></span>T3 ‚Äì G√≥c &amp; tam gi√°c</div>
          <!-- C√≥ th·ªÉ b·ªï sung th√™m T4..T15 sau -->
        </div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <header class="main-header">
        <div class="main-header-title">
          <span>Chat v·ªõi Tr·ª£ l√Ω To√°n AI</span>
          <span class="sub">ƒê·∫∑t c√¢u h·ªèi, t·∫£i b√†i t·∫≠p, nh·ªù AI ph√¢n t√≠ch &amp; ph√¢n lo·∫°i theo chu·∫©n T1‚ÄìT15.</span>
        </div>
        <div class="header-right">
        <div class="header-actions">
  <button class="header-btn" id="btn-run-tests">
    <span class="icon">üß™</span>
    <span>Ch·∫°y test T1‚ÄìT15</span>
  </button>

  <!-- üîπ N√∫t m·ªõi: T·∫°o quiz luy·ªán t·∫≠p -->
  <button class="header-btn" id="btn-create-quiz">
    <span class="icon">‚ùì</span>
    <span>T·∫°o quiz luy·ªán t·∫≠p</span>
  </button>

  <button class="header-btn" id="btn-export-pdf" disabled>
    <span class="icon">üìÑ</span>
    <span>Xu·∫•t PDF b√°o c√°o</span>
  </button>
</div>
      </header>

      <section class="messages" id="messages"></section>

      <!-- PANEL K·∫æT QU·∫¢ TEST -->
      <section class="test-panel" id="test-panel" style="display:none;">
        <div class="test-panel-header">
          <div class="test-panel-header-title">B√°o c√°o ki·ªÉm th·ª≠ chu·∫©n T1‚ÄìT15</div>
          <div class="test-summary" id="test-summary"></div>
        </div>
        <div class="test-table-wrapper">
          <table class="test-table">
            <thead>
              <tr>
                <th>#</th>
                <th>Input</th>
                <th>Expected</th>
                <th>Detected</th>
                <th>K·∫øt qu·∫£</th>
              </tr>
            </thead>
            <tbody id="test-table-body"></tbody>
          </table>
        </div>
      </section>

      <section class="input-bar">
        <div class="input-top">
          <span>Tip: B·∫°n c√≥ th·ªÉ t·∫£i file PDF/TXT b√†i t·∫≠p, h·ªá th·ªëng s·∫Ω ƒë·ªçc &amp; ph√¢n t√≠ch t·ª± ƒë·ªông.</span>
          <span id="status-text"></span>
        </div>
        <div class="input-row">
          <div class="input-box-wrap">
            <textarea id="chat-input" class="input-box" rows="1"
                      placeholder="ƒê·∫∑t c√¢u h·ªèi To√°n 9 ho·∫∑c d√°n ƒë·ªÅ b√†i ·ªü ƒë√¢y..."></textarea>
            <div class="input-actions-right">
              <button class="icon-btn" id="btn-upload" title="T·∫£i file b√†i t·∫≠p">
                üìé
              </button>
            </div>
          </div>
          <button class="send-btn" id="btn-send" title="G·ª≠i">
            ‚û§
          </button>
          <input type="file" id="file-input" accept=".txt,.pdf,.md,.json">
        </div>
        <div class="status-line" id="status-line"></div>
      </section>
    </main>
  </div>

<script>
  // ======= C·∫§U H√åNH BACKEND (c√πng domain Render) =======
  const API_BASE = "";

  // ======= STATE FRONTEND =======
  let conversations = {};
  let currentId = null;
  let chatCounter = 1;

  const chatListEl = document.getElementById("chat-list");
  const messagesEl = document.getElementById("messages");
  const headerTagsEl = document.getElementById("header-tags");
  const inputEl = document.getElementById("chat-input");
  const sendBtn = document.getElementById("btn-send");
  const statusLine = document.getElementById("status-line");
  const fileInput = document.getElementById("file-input");
  const uploadBtn = document.getElementById("btn-upload");
  const newChatBtn = document.getElementById("btn-new-chat");
  const statusText = document.getElementById("status-text");

  const runTestsBtn = document.getElementById("btn-run-tests");
  const exportPdfBtn = document.getElementById("btn-export-pdf");
  const testPanel = document.getElementById("test-panel");
  const testTableBody = document.getElementById("test-table-body");
  const testSummary = document.getElementById("test-summary");

  // n√∫t t·∫°o quiz m·ªõi
  const createQuizBtn = document.getElementById("btn-create-quiz");

  let lastTestResults = null; // l∆∞u ƒë·ªÉ xu·∫•t PDF

  function createNewConversation() {
    const id = "chat-" + Date.now();
    conversations[id] = {
      id,
      title: "Cu·ªôc tr√≤ chuy·ªán " + chatCounter++,
      messages: [],
      standards: [],
    };
    currentId = id;
    renderChatList();
    renderMessages();
    updateHeaderTags();
    inputEl.focus();
  }

  function getCurrentConversation() {
    if (!currentId || !conversations[currentId]) {
      createNewConversation();
    }
    return conversations[currentId];
  }

  function renderChatList() {
    chatListEl.innerHTML = "";
    Object.values(conversations).forEach((conv) => {
      const div = document.createElement("div");
      div.className = "chat-item" + (conv.id === currentId ? " active" : "");
      div.onclick = () => {
        currentId = conv.id;
        renderChatList();
        renderMessages();
        updateHeaderTags();
      };
      const title = document.createElement("div");
      title.className = "chat-item-title";
      title.textContent = conv.title;
      const sub = document.createElement("div");
      sub.className = "chat-item-sub";
      if (conv.messages.length) {
        sub.textContent =
          conv.messages[0].content.slice(0, 32) +
          (conv.messages[0].content.length > 32 ? "‚Ä¶" : "");
      } else {
        sub.textContent = "Ch∆∞a c√≥ n·ªôi dung";
      }
      div.appendChild(title);
      div.appendChild(sub);
      chatListEl.appendChild(div);
    });
  }

  function renderMessages() {
    const conv = getCurrentConversation();
    messagesEl.innerHTML = "";

    if (!conv.messages.length) {
      const intro = document.createElement("div");
      intro.style.color = "#9ca3af";
      intro.style.fontSize = "13px";
      intro.style.maxWidth = "480px";
      intro.style.margin = "40px auto 0";
      intro.style.textAlign = "center";
      intro.innerHTML =
        "Ch√†o b·∫°n üëã<br>ƒê√¢y l√† tr·ª£ l√Ω To√°n 9 AI: gi·∫£i b√†i, g·ª£i √Ω c√°ch h·ªçc, v√† c√≥ th·ªÉ t·∫°o quiz luy·ªán t·∫≠p theo chu·∫©n T1‚ÄìT15.";
      messagesEl.appendChild(intro);

      if (window.MathJax && window.MathJax.typesetPromise) {
        window.MathJax.typesetPromise();
      }
      return;
    }

    conv.messages.forEach((msg) => {
      const row = document.createElement("div");
      row.className = "message-row " + msg.role;

      const wrapper = document.createElement("div");
      const meta = document.createElement("div");
      meta.className = "message-meta";

      const avatar = document.createElement("span");
      avatar.className = "avatar " + msg.role;
      avatar.textContent = msg.role === "assistant" ? "AI" : "You";

      const metaText = document.createElement("span");
      metaText.textContent =
        msg.role === "assistant" ? "Tr·ª£ l√Ω To√°n AI" : "B·∫°n";

      meta.appendChild(avatar);
      meta.appendChild(metaText);

      const bubble = document.createElement("div");
      bubble.className = "message-bubble";

      // ---- Markdown bold ‚Üí HTML bold ----
      let html = msg.content.replace(
        /\*\*(.*?)\*\*/g,
        "<strong>$1</strong>"
      );
      bubble.innerHTML = html;

      wrapper.appendChild(meta);
      wrapper.appendChild(bubble);
      row.appendChild(wrapper);
      messagesEl.appendChild(row);
    });

    messagesEl.scrollTop = messagesEl.scrollHeight;

    // Render MathJax sau khi DOM ƒë√£ c·∫≠p nh·∫≠t
    if (window.MathJax && window.MathJax.typesetPromise) {
      window.MathJax.typesetPromise();
    }
  }

  function updateHeaderTags() {
    const conv = getCurrentConversation();
    headerTagsEl.innerHTML = "";
    if (!conv.standards || !conv.standards.length) return;
    conv.standards.forEach((code) => {
      const div = document.createElement("div");
      div.className = "tag-chip";
      div.textContent = code;
      headerTagsEl.appendChild(div);
    });
  }

  async function sendMessage() {
    const text = inputEl.value.trim();
    if (!text) return;
    const conv = getCurrentConversation();

    conv.messages.push({ role: "user", content: text });
    inputEl.value = "";
    renderMessages();
    statusLine.textContent = "ƒêang suy nghƒ©‚Ä¶";
    statusLine.classList.remove("error");
    sendBtn.disabled = true;

    try {
      const payload = {
        messages: conv.messages.map((m) => ({
          role: m.role,
          content: m.content,
        })),
      };
      const res = await fetch(API_BASE + "/chat/message", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      if (!res.ok) throw new Error("HTTP " + res.status);
      const data = await res.json();
      conv.messages.push({ role: "assistant", content: data.reply });
      conv.standards = data.standards || [];
      renderMessages();
      updateHeaderTags();
      renderChatList();
      statusLine.textContent = "";
    } catch (err) {
      console.error(err);
      statusLine.textContent = "Kh√¥ng g·ªçi ƒë∆∞·ª£c API /chat/message. Ki·ªÉm tra server.";
      statusLine.classList.add("error");
    } finally {
      sendBtn.disabled = false;
    }
  }

  // G·ª≠i l·∫°i to√†n b·ªô l·ªãch s·ª≠ h·ªôi tho·∫°i hi·ªán t·∫°i
  async function sendHistoryOnly() {
    const conv = getCurrentConversation();
    if (!conv.messages.length) return;
    statusLine.textContent = "ƒêang ph√¢n t√≠ch‚Ä¶";
    statusLine.classList.remove("error");
    sendBtn.disabled = true;

    try {
      const payload = {
        messages: conv.messages.map((m) => ({
          role: m.role,
          content: m.content,
        })),
      };
      const res = await fetch(API_BASE + "/chat/message", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      if (!res.ok) throw new Error("HTTP " + res.status);
      const data = await res.json();
      conv.messages.push({ role: "assistant", content: data.reply });
      conv.standards = data.standards || [];
      renderMessages();
      updateHeaderTags();
      renderChatList();
      statusLine.textContent = "";
    } catch (err) {
      console.error(err);
      statusLine.textContent = "Kh√¥ng g·ªçi ƒë∆∞·ª£c API /chat/message. Ki·ªÉm tra server.";
      statusLine.classList.add("error");
    } finally {
      sendBtn.disabled = false;
    }
  }

  // Upload file ‚Üí /file/parse ‚Üí th√™m v√†o chat ‚Üí g·ªçi AI
  uploadBtn.addEventListener("click", () => fileInput.click());
  fileInput.addEventListener("change", async () => {
    const file = fileInput.files[0];
    if (!file) return;

    const conv = getCurrentConversation();
    statusLine.textContent = "ƒêang ƒë·ªçc file " + file.name + "‚Ä¶";
    statusLine.classList.remove("error");

    const formData = new FormData();
    formData.append("file", file);

    try {
      const res = await fetch(API_BASE + "/file/parse", {
        method: "POST",
        body: formData,
      });
      if (!res.ok) throw new Error("HTTP " + res.status);
      const data = await res.json();
      const snippet =
        data.content.length > 600
          ? data.content.slice(0, 600) + "\n[...ƒë√£ c·∫Øt b·ªõt...]"
          : data.content;
      const text =
        `N·ªôi dung tr√≠ch t·ª´ file "${data.filename}":\n\n` + snippet;

      conv.messages.push({ role: "user", content: text });
      renderMessages();

      await sendHistoryOnly();
    } catch (err) {
      console.error(err);
      statusLine.textContent = "Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c file. Ki·ªÉm tra /file/parse.";
      statusLine.classList.add("error");
    } finally {
      fileInput.value = "";
    }
  });

  // ==== CH·∫†Y B·ªò TEST T1‚ÄìT15 ====
  async function runTests() {
    testPanel.style.display = "block";
    testSummary.textContent = "ƒêang l·∫•y b·ªô test‚Ä¶";
    testTableBody.innerHTML = "";
    runTestsBtn.disabled = true;
    exportPdfBtn.disabled = true;
    lastTestResults = null;

    try {
      const res = await fetch(API_BASE + "/api/generate_tests");
      if (!res.ok) throw new Error("HTTP " + res.status);
      const data = await res.json();
      const tests = data.tests || [];
      if (!tests.length) throw new Error("Kh√¥ng nh·∫≠n ƒë∆∞·ª£c test n√†o t·ª´ API.");

      let results = [];
      let passed = 0;

      for (let i = 0; i < tests.length; i++) {
        const t = tests[i];
        testSummary.textContent = `ƒêang ch·∫°y test ${i + 1}/${tests.length}‚Ä¶`;

        const payload = {
          messages: [{ role: "user", content: t.input }],
        };
        const r = await fetch(API_BASE + "/chat/message", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        let detected = [];
        if (r.ok) {
          const d = await r.json();
          detected = d.standards || [];
        } else {
          detected = ["<error " + r.status + ">"];
        }

        const expSorted = [...t.expected_standards].sort().join(",");
        const detSorted = [...detected].sort().join(",");
        const ok = expSorted === detSorted;

        if (ok) passed++;

        results.push({
          index: i + 1,
          input: t.input,
          expected: t.expected_standards,
          detected,
          ok,
        });
      }

      // Render b·∫£ng
      testTableBody.innerHTML = "";
      results.forEach((r) => {
        const tr = document.createElement("tr");

        const tdIndex = document.createElement("td");
        tdIndex.textContent = r.index;

        const tdInput = document.createElement("td");
        tdInput.textContent =
          r.input.length > 150 ? r.input.slice(0, 150) + "‚Ä¶" : r.input;

        const tdExpected = document.createElement("td");
        tdExpected.textContent = r.expected.join(", ");

        const tdDetected = document.createElement("td");
        tdDetected.textContent = r.detected.join(", ");

        const tdResult = document.createElement("td");
        const badge = document.createElement("span");
        badge.className = r.ok ? "badge-pass" : "badge-fail";
        badge.textContent = r.ok ? "PASS" : "FAIL";
        tdResult.appendChild(badge);

        tr.appendChild(tdIndex);
        tr.appendChild(tdInput);
        tr.appendChild(tdExpected);
        tr.appendChild(tdDetected);
        tr.appendChild(tdResult);

        testTableBody.appendChild(tr);
      });

      const total = results.length;
      const failed = total - passed;
      testSummary.textContent = `T·ªïng: ${total} test ‚Ä¢ PASS: ${passed} ‚Ä¢ FAIL: ${failed}`;
      lastTestResults = { total, passed, failed, results };
      exportPdfBtn.disabled = total === 0;
    } catch (err) {
      console.error(err);
      testSummary.textContent = "L·ªói khi ch·∫°y test: " + err.message;
      lastTestResults = null;
    } finally {
      runTestsBtn.disabled = false;
    }
  }

  // ==== XU·∫§T PDF B√ÅO C√ÅO ====
  function exportPdfReport() {
    if (!lastTestResults) return;
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: "pt", format: "a4" });

    let y = 40;
    doc.setFontSize(14);
    doc.text(
      "B√°o c√°o ki·ªÉm th·ª≠ chu·∫©n T1‚ÄìT15 ‚Äì K9 Math AI Assistant",
      40,
      y
    );

    y += 20;
    doc.setFontSize(11);
    doc.text("Th·ªùi gian: " + new Date().toLocaleString(), 40, y);

    y += 16;
    const s = lastTestResults;
    doc.text(
      `T·ªïng s·ªë test: ${s.total}   PASS: ${s.passed}   FAIL: ${s.failed}`,
      40,
      y
    );

    y += 24;
    doc.setFontSize(11);
    doc.text("Chi ti·∫øt:", 40, y);
    y += 14;

    const maxWidth = 500;

    s.results.forEach((r) => {
      if (y > 760) {
        doc.addPage();
        y = 40;
      }
      doc.setFontSize(11);
      doc.text(`#${r.index} ‚Äì ${r.ok ? "PASS" : "FAIL"}`, 40, y);
      y += 12;

      doc.setFontSize(9);
      doc.text("Input:", 40, y);
      y += 10;
      const inputLines = doc.splitTextToSize(r.input, maxWidth);
      doc.text(inputLines, 60, y);
      y += inputLines.length * 10;

      doc.text("Expected: " + r.expected.join(", "), 60, y);
      y += 10;
      doc.text("Detected: " + r.detected.join(", "), 60, y);
      y += 16;
    });

    doc.save("Bao_cao_test_T1-T15.pdf");
  }

  // ==== T·∫†O QUIZ LUY·ªÜN T·∫¨P T·ª™ H·ªòI THO·∫†I HI·ªÜN T·∫†I ====
  async function createQuizFromConversation() {
    const conv = getCurrentConversation();
    if (!conv.messages.length) {
      statusLine.textContent = "H√£y h·ªèi m·ªôt b√†i tr∆∞·ªõc r·ªìi m√¨nh m·ªõi t·∫°o quiz ƒë∆∞·ª£c nh√©.";
      return;
    }

    const promptQuiz =
      "T·ª´ l·ªùi gi·∫£i v√† c√°c trao ƒë·ªïi ·ªü tr√™n, h√£y t·∫°o cho m√¨nh 5 c√¢u h·ªèi tr·∫Øc nghi·ªám luy·ªán t·∫≠p To√°n 9, " +
      "m·ªói c√¢u 4 ƒë√°p √°n A‚ÄìD, ghi r√µ ƒë√°p √°n ƒë√∫ng v√† gi·∫£i th√≠ch ng·∫Øn. " +
      "Tr√¨nh b√†y r√µ r√†ng, d·ªÖ ƒë·ªçc cho h·ªçc sinh l·ªõp 9.";

    conv.messages.push({ role: "user", content: promptQuiz });
    renderMessages();
    await sendHistoryOnly();
  }

  // ====== S·ª± ki·ªán ======
  inputEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });
  sendBtn.addEventListener("click", sendMessage);
  newChatBtn.addEventListener("click", () => {
    createNewConversation();
    renderChatList();
    renderMessages();
    updateHeaderTags();
    statusLine.textContent = "";
  });

  runTestsBtn.addEventListener("click", runTests);
  exportPdfBtn.addEventListener("click", exportPdfReport);
  createQuizBtn.addEventListener("click", createQuizFromConversation);

  // Init
  createNewConversation();
  statusText.textContent = "Server: " + window.location.origin;
</script>

</body>
</html>

