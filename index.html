<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>K9 Math AI Assistant ‚Äì Chat</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root {
      --bg-main: #050816;
      --bg-chat: #0b1020;
      --bg-msg-user: #1f2937;
      --bg-msg-assistant: #111827;
      --accent: #10b981;
      --accent-soft: rgba(16,185,129,0.15);
      --border-subtle: #374151;
      --text-main: #e5e7eb;
      --text-soft: #9ca3af;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text-main);
      background: radial-gradient(circle at top, #1f2937 0, #020617 55%, #000 100%);
    }
    .layout {
      display: flex;
      width: 100%;
      height: 100%;
    }
    /* Sidebar */
    .sidebar {
      width: 260px;
      background: #020617;
      border-right: 1px solid #111827;
      padding: 12px 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .sidebar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 4px 6px 0;
    }
    .logo {
      font-size: 14px;
      font-weight: 600;
      color: #f9fafb;
    }
    .subtitle {
      font-size: 11px;
      color: var(--text-soft);
    }
    .new-chat-btn {
      margin-top: 8px;
      width: 100%;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #374151;
      background: linear-gradient(to right, #111827, #020617);
      color: #e5e7eb;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }
    .new-chat-btn span.icon {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: var(--accent-soft);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }
    .new-chat-btn:hover {
      border-color: var(--accent);
    }
    .chat-list {
      flex: 1;
      margin-top: 4px;
      overflow-y: auto;
      padding-right: 2px;
    }
    .chat-item {
      padding: 8px 10px;
      border-radius: 8px;
      margin-bottom: 4px;
      font-size: 13px;
      color: var(--text-soft);
      display: flex;
      flex-direction: column;
      gap: 2px;
      cursor: pointer;
    }
    .chat-item.active {
      background: linear-gradient(to right, rgba(16,185,129,0.18), rgba(15,23,42,0.9));
      color: #f9fafb;
    }
    .chat-item-title {
      font-weight: 500;
    }
    .chat-item-sub {
      font-size: 11px;
    }
    .sidebar-footer {
      padding: 8px 6px;
      border-top: 1px solid #111827;
      font-size: 11px;
      color: #6b7280;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      padding: 2px 7px;
      font-size: 10px;
      background: rgba(31,41,55,0.9);
      margin-right: 4px;
      margin-bottom: 2px;
    }
    .badge span.dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      margin-right: 4px;
      background: var(--accent);
    }

    /* Main */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .main-header {
      padding: 10px 16px;
      border-bottom: 1px solid #111827;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(15,23,42,0.9);
      backdrop-filter: blur(10px);
      gap: 8px;
    }
    .main-header-title {
      font-size: 13px;
      font-weight: 500;
      display: flex;
      flex-direction: column;
    }
    .main-header-title span.sub {
      font-size: 11px;
      color: var(--text-soft);
    }
    .header-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
      max-width: 55%;
    }
    .header-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    .header-btn {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #374151;
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .header-btn span.icon {
      font-size: 12px;
    }
    .header-btn:hover {
      border-color: var(--accent);
    }
    .header-btn:disabled {
      opacity: 0.5;
      cursor: default;
    }
    .tag-list {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      justify-content: flex-end;
    }
    .tag-chip {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(16,185,129,0.15);
      color: #a7f3d0;
      border: 1px solid rgba(16,185,129,0.35);
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px 18px 8px;
      background: radial-gradient(circle at top, #111827 0, #020617 45%, #000 100%);
    }
    .message-row {
      margin-bottom: 12px;
      display: flex;
    }
    .message-row.assistant { justify-content: flex-start; }
    .message-row.user { justify-content: flex-end; }

    .message-bubble {
      max-width: 70%;
      padding: 10px 12px;
      border-radius: 16px;
      font-size: 14px;
      line-height: 1.45;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .assistant .message-bubble {
      background: var(--bg-msg-assistant);
      border: 1px solid #1f2937;
    }
    .user .message-bubble {
      background: var(--bg-msg-user);
      border: 1px solid #374151;
    }
    .message-meta {
      font-size: 10px;
      color: var(--text-soft);
      margin-bottom: 2px;
      padding: 0 4px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .avatar {
      width: 20px;
      height: 20px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-right: 6px;
      font-size: 12px;
    }
    .avatar.assistant {
      background: rgba(16,185,129,0.15);
      color: #6ee7b7;
    }
    .avatar.user {
      background: rgba(59,130,246,0.15);
      color: #bfdbfe;
    }

    .input-bar {
      padding: 10px 16px 14px;
      border-top: 1px solid #111827;
      background: radial-gradient(circle at top, #020617 0, #000 100%);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .input-top {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: var(--text-soft);
      gap: 8px;
      flex-wrap: wrap;
    }
    .input-row {
      display: flex;
      align-items: flex-end;
      gap: 8px;
    }
    .input-box-wrap {
      flex: 1;
      position: relative;
    }
    .input-box {
      width: 100%;
      padding: 10px 40px 10px 12px;
      border-radius: 999px;
      border: 1px solid #374151;
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      font-size: 14px;
      resize: none;
      max-height: 100px;
      min-height: 40px;
      outline: none;
    }
    .input-box::placeholder {
      color: #6b7280;
    }
    .input-actions-right {
      position: absolute;
      right: 6px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .icon-btn {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      border: none;
      background: transparent;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #9ca3af;
      font-size: 14px;
    }
    .icon-btn:hover {
      background: rgba(31,41,55,0.9);
      color: #e5e7eb;
    }
    .send-btn {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      border: none;
      background: var(--accent);
      color: #022c22;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 16px;
    }
    .send-btn:disabled {
      opacity: 0.4;
      cursor: default;
    }
    .status-line {
      font-size: 11px;
      color: var(--text-soft);
      min-height: 14px;
    }
    .status-line.error {
      color: #fca5a5;
    }

    #file-input {
      display: none;
    }

    /* Test panel overlay */
    .test-panel {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.65);
      z-index: 40;
      font-size: 12px;
    }
    .test-panel-inner {
      width: min(960px, 95vw);
      max-height: 85vh;
      background: #020617;
      border-radius: 16px;
      border: 1px solid #111827;
      padding: 12px 16px 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .test-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      gap: 8px;
    }
    .test-panel-title-group {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .test-summary {
      font-size: 11px;
      color: var(--text-soft);
    }
    .test-panel-switch {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .test-body {
      border: 1px solid #111827;
      border-radius: 10px;
      padding: 10px;
      background: #020617;
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 55vh;
      overflow-y: auto;
    }
    .test-progress {
      font-size: 11px;
      color: #9ca3af;
    }
    .test-question {
      font-size: 13px;
      font-weight: 500;
    }
    .test-standards {
      font-size: 11px;
      color: #9ca3af;
    }
    .test-options label {
      display: block;
      margin-bottom: 4px;
      cursor: pointer;
    }
    .test-options input[type="radio"] {
      margin-right: 6px;
    }
    .test-explain-block label {
      font-size: 11px;
      color: #9ca3af;
      display: block;
      margin-bottom: 4px;
    }
    .test-explain-block textarea {
      width: 100%;
      min-height: 80px;
      max-height: 160px;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 12px;
      resize: vertical;
    }
    .test-feedback {
      font-size: 11px;
      color: #e5e7eb;
      min-height: 16px;
    }

    .test-panel-footer {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      margin-top: 6px;
      flex-wrap: wrap;
    }

    @media (max-width: 800px) {
      .sidebar {
        display: none;
      }
      .header-right {
        max-width: 60%;
      }
    }
  </style>

  <!-- pdfmake ƒë·ªÉ xu·∫•t PDF (Unicode, c√≥ d·∫•u) -->
  <script src="/static/js/pdfmake.min.js"></script>
  <script src="/static/js/vfs_fonts.js"></script>

  <!-- MathJax -->
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']]
      },
      svg: { fontCache: 'global' }
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" async></script>
</head>
<body>
  <div class="layout">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div>
          <div class="logo">K9 Math AI</div>
          <div class="subtitle">Tr·ª£ l√Ω To√°n 9 ‚Äì AI for Good</div>
        </div>
      </div>
      <button class="new-chat-btn" id="btn-new-chat">
        <span class="icon">+</span>
        <span>Cu·ªôc tr√≤ chuy·ªán m·ªõi</span>
      </button>

      <div class="chat-list" id="chat-list"></div>

      <div class="sidebar-footer">
        <div>Chu·∫©n ƒë·∫ßu ra (T1‚ÄìT15)</div>
        <div style="margin-top:4px;">
          <div class="badge"><span class="dot"></span>T1 ‚Äì S·ªë &amp; l≈©y th·ª´a</div>
          <div class="badge"><span class="dot"></span>T2 ‚Äì T·ªâ l·ªá &amp; ph·∫ßn trƒÉm</div>
          <div class="badge"><span class="dot"></span>T3 ‚Äì G√≥c &amp; tam gi√°c</div>
          <!-- C√≥ th·ªÉ b·ªï sung th√™m T4..T15 sau -->
        </div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <header class="main-header">
        <div class="main-header-title">
          <span>Chat v·ªõi Tr·ª£ l√Ω To√°n AI</span>
          <span class="sub">
            ƒê·∫∑t c√¢u h·ªèi, t·∫£i b√†i t·∫≠p, nh·ªù AI ph√¢n t√≠ch &amp; ph√¢n lo·∫°i theo chu·∫©n T1‚ÄìT15.
          </span>
        </div>
        <div class="header-right">
          <div class="header-actions">
            <button class="header-btn" id="btn-run-tests">
              <span class="icon">üß™</span>
              <span>L√†m b√†i ki·ªÉm tra ƒë·∫ßu v√†o / ƒë·∫ßu ra</span>
            </button>

            <button class="header-btn" id="btn-create-quiz">
              <span class="icon">‚ùì</span>
              <span>Quiz luy·ªán t·∫≠p</span>
            </button>

            <button class="header-btn" id="btn-export-pdf-global" disabled>
              <span class="icon">üìÑ</span>
              <span>Xu·∫•t PDF b√°o c√°o</span>
            </button>
          </div>
          <div class="tag-list" id="header-tags">
            <!-- Dynamic tags -->
          </div>
        </div>
      </header>

      <section class="messages" id="messages"></section>

      <!-- TEST PANEL OVERLAY -->
      <section class="test-panel" id="test-panel">
        <div class="test-panel-inner">
          <div class="test-panel-header">
            <div class="test-panel-title-group">
              <div class="test-panel-header-title" id="test-panel-title">
                B√†i ki·ªÉm tra ƒë·∫ßu v√†o T1‚ÄìT15
              </div>
              <div class="test-summary" id="test-summary"></div>
            </div>
            <div class="test-panel-switch">
              <button class="header-btn" id="btn-switch-input">ƒê·∫ßu v√†o</button>
              <button class="header-btn" id="btn-switch-output">ƒê·∫ßu ra</button>
              <button class="header-btn" id="btn-close-test">‚úï</button>
            </div>
          </div>

          <div class="test-body">
            <div class="test-progress" id="test-progress"></div>
            <div class="test-question" id="test-question"></div>
            <div class="test-standards" id="test-standards"></div>
            <div class="test-options" id="test-options"></div>
            <div class="test-explain-block">
              <label for="test-explanation">Tr√¨nh b√†y l·ªùi gi·∫£i / c√°ch nghƒ© c·ªßa b·∫°n:</label>
              <textarea id="test-explanation"></textarea>
            </div>
            <div class="test-feedback" id="test-feedback"></div>
          </div>

          <div class="test-panel-footer">
            <div style="display:flex; gap:6px; flex-wrap:wrap;">
              <button class="header-btn" id="btn-prev-question">
                ‚óÄ Tr∆∞·ªõc
              </button>
              <button class="header-btn" id="btn-next-question">
                Ti·∫øp ‚ñ∂
              </button>
            </div>
            <div style="display:flex; gap:6px; flex-wrap:wrap;">
              <button class="header-btn" id="btn-grade-test">
                <span class="icon">‚úî</span>
                <span>Ch·∫•m b√†i &amp; g·ª£i √Ω k·∫ø ho·∫°ch</span>
              </button>
              <button class="header-btn" id="btn-export-pdf" disabled>
                <span class="icon">üìÑ</span>
                <span>Xu·∫•t PDF b√°o c√°o</span>
              </button>
            </div>
          </div>
        </div>
      </section>

      <section class="input-bar">
        <div class="input-top">
          <span>Tip: B·∫°n c√≥ th·ªÉ t·∫£i file PDF/TXT b√†i t·∫≠p, h·ªá th·ªëng s·∫Ω ƒë·ªçc &amp; ph√¢n t√≠ch t·ª± ƒë·ªông.</span>
          <span id="status-text"></span>
        </div>
        <div class="input-row">
          <div class="input-box-wrap">
            <textarea id="chat-input" class="input-box" rows="1"
                      placeholder="ƒê·∫∑t c√¢u h·ªèi To√°n 9 ho·∫∑c d√°n ƒë·ªÅ b√†i ·ªü ƒë√¢y..."></textarea>
            <div class="input-actions-right">
              <button class="icon-btn" id="btn-upload" title="T·∫£i file b√†i t·∫≠p">
                üìé
              </button>
            </div>
          </div>
          <button class="send-btn" id="btn-send" title="G·ª≠i">
            ‚û§
          </button>
          <input type="file" id="file-input" accept=".txt,.pdf,.md,.json">
        </div>
        <div class="status-line" id="status-line"></div>
      </section>
    </main>
  </div>

  <script>
    const API_BASE = "";

    const STANDARD_LABELS = {
      T1: "S·ªë & l≈©y th·ª´a",
      T2: "T·ªâ l·ªá & ph·∫ßn trƒÉm",
      T3: "G√≥c & tam gi√°c",
      T4: "CƒÉn b·∫≠c hai",
      T5: "Ph∆∞∆°ng tr√¨nh b·∫≠c nh·∫•t",
      T6: "H·ªá ph∆∞∆°ng tr√¨nh",
      T7: "B·∫•t ph∆∞∆°ng tr√¨nh",
      T8: "H√†m s·ªë & ƒë·ªì th·ªã",
      T9: "Tam gi√°c vu√¥ng & ƒë·ªãnh l√Ω Pytago",
      T10: "ƒê∆∞·ªùng tr√≤n",
      T11: "Ti·∫øp tuy·∫øn",
      T12: "H√¨nh tr·ª•, n√≥n, c·∫ßu",
      T13: "Th·ªëng k√™",
      T14: "X√°c su·∫•t",
      T15: "B√†i to√°n th·ª±c t·∫ø"
    };

    // === STATE CHAT ===
    let conversations = {};
    let currentId = null;
    let chatCounter = 1;

    const chatListEl = document.getElementById("chat-list");
    const messagesEl = document.getElementById("messages");
    const headerTagsEl = document.getElementById("header-tags");
    const inputEl = document.getElementById("chat-input");
    const sendBtn = document.getElementById("btn-send");
    const statusLine = document.getElementById("status-line");
    const fileInput = document.getElementById("file-input");
    const uploadBtn = document.getElementById("btn-upload");
    const newChatBtn = document.getElementById("btn-new-chat");
    const statusText = document.getElementById("status-text");

    const runTestsBtn = document.getElementById("btn-run-tests");
    const createQuizBtn = document.getElementById("btn-create-quiz");
    const exportPdfGlobalBtn = document.getElementById("btn-export-pdf-global");

    // === STATE TEST/QUIZ ===
    const testPanel = document.getElementById("test-panel");
    const testPanelTitle = document.getElementById("test-panel-title");
    const testSummary = document.getElementById("test-summary");
    const testProgress = document.getElementById("test-progress");
    const testQuestionEl = document.getElementById("test-question");
    const testStandardsEl = document.getElementById("test-standards");
    const testOptionsEl = document.getElementById("test-options");
    const testExplainEl = document.getElementById("test-explanation");
    const testFeedbackEl = document.getElementById("test-feedback");

    const btnSwitchInput = document.getElementById("btn-switch-input");
    const btnSwitchOutput = document.getElementById("btn-switch-output");
    const btnCloseTest = document.getElementById("btn-close-test");
    const btnPrevQuestion = document.getElementById("btn-prev-question");
    const btnNextQuestion = document.getElementById("btn-next-question");
    const btnGradeTest = document.getElementById("btn-grade-test");
    const exportPdfBtn = document.getElementById("btn-export-pdf");

    let testMode = "input"; // input | output | quiz
    let testQuestions = [];
    let testSession = null;
    let lastTestResults = null;

    // ===== CHAT =====
    function createNewConversation() {
      const id = "chat-" + Date.now();
      conversations[id] = {
        id,
        title: "Cu·ªôc tr√≤ chuy·ªán " + chatCounter++,
        messages: [],
        standards: []
      };
      currentId = id;
      renderChatList();
      renderMessages();
      updateHeaderTags();
      inputEl.focus();
    }

    function getCurrentConversation() {
      if (!currentId || !conversations[currentId]) {
        createNewConversation();
      }
      return conversations[currentId];
    }

    function renderChatList() {
      chatListEl.innerHTML = "";
      Object.values(conversations).forEach(conv => {
        const div = document.createElement("div");
        div.className = "chat-item" + (conv.id === currentId ? " active" : "");
        div.onclick = () => {
          currentId = conv.id;
          renderChatList();
          renderMessages();
          updateHeaderTags();
        };
        const title = document.createElement("div");
        title.className = "chat-item-title";
        title.textContent = conv.title;
        const sub = document.createElement("div");
        sub.className = "chat-item-sub";
        if (conv.messages.length) {
          const first = conv.messages[0].content || "";
          sub.textContent = first.slice(0, 32) + (first.length > 32 ? "‚Ä¶" : "");
        } else {
          sub.textContent = "Ch∆∞a c√≥ n·ªôi dung";
        }
        div.appendChild(title);
        div.appendChild(sub);
        chatListEl.appendChild(div);
      });
    }

    function renderMessages() {
      const conv = getCurrentConversation();
      messagesEl.innerHTML = "";
      if (!conv.messages.length) {
        const intro = document.createElement("div");
        intro.style.color = "#9ca3af";
        intro.style.fontSize = "13px";
        intro.style.maxWidth = "480px";
        intro.style.margin = "40px auto 0";
        intro.style.textAlign = "center";
        intro.innerHTML = "Ch√†o b·∫°n üëã<br>H√£y ƒë·∫∑t c√¢u h·ªèi To√°n 9, t·∫£i file b√†i t·∫≠p, ho·∫∑c nh·ªù m√¨nh ph√¢n t√≠ch l·ªói sai theo chu·∫©n T1‚ÄìT15.";
        messagesEl.appendChild(intro);
      } else {
        conv.messages.forEach(msg => {
          const row = document.createElement("div");
          row.className = "message-row " + msg.role;

          const wrapper = document.createElement("div");
          const meta = document.createElement("div");
          meta.className = "message-meta";

          const avatar = document.createElement("span");
          avatar.className = "avatar " + msg.role;
          avatar.textContent = msg.role === "assistant" ? "AI" : "You";

          const metaText = document.createElement("span");
          metaText.textContent = msg.role === "assistant" ? "Tr·ª£ l√Ω To√°n AI" : "B·∫°n";

          meta.appendChild(avatar);
          meta.appendChild(metaText);

          const bubble = document.createElement("div");
          bubble.className = "message-bubble";
          bubble.textContent = msg.content;

          wrapper.appendChild(meta);
          wrapper.appendChild(bubble);
          row.appendChild(wrapper);
          messagesEl.appendChild(row);
        });
      }

      messagesEl.scrollTop = messagesEl.scrollHeight;

      if (window.MathJax && window.MathJax.typesetPromise) {
        window.MathJax.typesetPromise();
      }
    }

    function updateHeaderTags() {
      const conv = getCurrentConversation();
      headerTagsEl.innerHTML = "";
      if (!conv.standards || !conv.standards.length) return;
      conv.standards.forEach(code => {
        const div = document.createElement("div");
        div.className = "tag-chip";
        div.textContent = code;
        headerTagsEl.appendChild(div);
      });
    }

    async function sendMessage() {
      const text = inputEl.value.trim();
      if (!text) return;
      const conv = getCurrentConversation();

      conv.messages.push({ role: "user", content: text });
      inputEl.value = "";
      renderMessages();
      statusLine.textContent = "ƒêang suy nghƒ©‚Ä¶";
      statusLine.classList.remove("error");
      sendBtn.disabled = true;

      try {
        const payload = {
          messages: conv.messages.map(m => ({ role: m.role, content: m.content }))
        };
        const res = await fetch(API_BASE + "/chat/message", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        conv.messages.push({ role: "assistant", content: data.reply });
        conv.standards = data.standards || [];
        renderMessages();
        updateHeaderTags();
        renderChatList();
        statusLine.textContent = "";
      } catch (err) {
        console.error(err);
        statusLine.textContent = "Kh√¥ng g·ªçi ƒë∆∞·ª£c API /chat/message. Ki·ªÉm tra server.";
        statusLine.classList.add("error");
      } finally {
        sendBtn.disabled = false;
      }
    }

    async function sendHistoryOnly() {
      const conv = getCurrentConversation();
      if (!conv.messages.length) return;
      statusLine.textContent = "ƒêang ph√¢n t√≠ch‚Ä¶";
      statusLine.classList.remove("error");
      sendBtn.disabled = true;

      try {
        const payload = {
          messages: conv.messages.map(m => ({ role: m.role, content: m.content }))
        };
        const res = await fetch(API_BASE + "/chat/message", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        conv.messages.push({ role: "assistant", content: data.reply });
        conv.standards = data.standards || [];
        renderMessages();
        updateHeaderTags();
        renderChatList();
        statusLine.textContent = "";
      } catch (err) {
        console.error(err);
        statusLine.textContent = "Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c file. Ki·ªÉm tra /file/parse.";
        statusLine.classList.add("error");
      } finally {
        sendBtn.disabled = false;
      }
    }

    // Upload file -> parse
    uploadBtn.addEventListener("click", () => fileInput.click());
    fileInput.addEventListener("change", async () => {
      const file = fileInput.files[0];
      if (!file) return;

      const conv = getCurrentConversation();
      statusLine.textContent = "ƒêang ƒë·ªçc file " + file.name + "‚Ä¶";
      statusLine.classList.remove("error");

      const formData = new FormData();
      formData.append("file", file);

      try {
        const res = await fetch(API_BASE + "/file/parse", {
          method: "POST",
          body: formData
        });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        const snippet = data.content.length > 600
          ? data.content.slice(0, 600) + "\n[...ƒë√£ c·∫Øt b·ªõt...]"
          : data.content;
        const text = `N·ªôi dung tr√≠ch t·ª´ file "${data.filename}":\n\n` + snippet;

        conv.messages.push({ role: "user", content: text });
        renderMessages();

        await sendHistoryOnly();
      } catch (err) {
        console.error(err);
        statusLine.textContent = "Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c file. Ki·ªÉm tra /file/parse.";
        statusLine.classList.add("error");
      } finally {
        fileInput.value = "";
      }
    });

    // ===== TEST / QUIZ (tr√¨nh ri√™ng) =====
    function openTestPanel(mode) {
      testMode = mode || "input";
      testPanel.style.display = "flex";
      testSummary.textContent = "ƒêang t·∫£i c√¢u h·ªèi‚Ä¶";
      exportPdfBtn.disabled = true;
      exportPdfGlobalBtn.disabled = true;
      testQuestions = [];
      testSession = null;
      lastTestResults = null;
      loadTestQuestions();
    }

    function closeTestPanel() {
      testPanel.style.display = "none";
    }

    async function loadTestQuestions() {
      let endpoint = "/api/input_quiz";
      if (testMode === "output" || testMode === "quiz") {
        endpoint = "/api/output_quiz";
      }

      try {
        const res = await fetch(API_BASE + endpoint);
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        testQuestions = data.questions || [];
        if (!testQuestions.length) throw new Error("Kh√¥ng c√≥ c√¢u h·ªèi.");

        if (testMode === "quiz") {
          testPanelTitle.textContent = "Quiz luy·ªán t·∫≠p T1‚ÄìT15";
        } else if (testMode === "input") {
          testPanelTitle.textContent = "B√†i ki·ªÉm tra ƒë·∫ßu v√†o T1‚ÄìT15";
        } else {
          testPanelTitle.textContent = "B√†i ki·ªÉm tra ƒë·∫ßu ra T1‚ÄìT15";
        }

        testSummary.textContent = "Tr·∫£ l·ªùi t·ª´ng c√¢u, ch·ªçn ƒë√°p √°n A‚ÄìD v√† tr√¨nh b√†y ng·∫Øn g·ªçn c√°ch l√†m.";

        testSession = {
          mode: testMode,
          questions: testQuestions,
          currentIndex: 0,
          answers: testQuestions.map(() => ({ choice: null, explanation: "" })),
          graded: false,
          perStandard: {},
          correctCount: 0,
          total: testQuestions.length
        };

        renderCurrentTestQuestion();
      } catch (err) {
        console.error(err);
        testSummary.textContent = "L·ªói t·∫£i c√¢u h·ªèi: " + err.message;
      }
    }

    function renderCurrentTestQuestion() {
      if (!testSession) return;
      const idx = testSession.currentIndex;
      const q = testSession.questions[idx];

      testProgress.textContent = `C√¢u ${idx + 1} / ${testSession.questions.length}`;
      testQuestionEl.textContent = q.text;
      testStandardsEl.textContent = "Chu·∫©n li√™n quan: " + (q.standards || []).join(", ");

      testOptionsEl.innerHTML = "";
      const ans = testSession.answers[idx];
      (q.options || []).forEach((opt, i) => {
        const label = document.createElement("label");
        const radio = document.createElement("input");
        radio.type = "radio";
        radio.name = "test-option";
        radio.value = String(i);
        if (ans.choice === i) radio.checked = true;
        label.appendChild(radio);
        label.appendChild(document.createTextNode(
          " " + String.fromCharCode(65 + i) + ". " + opt
        ));
        testOptionsEl.appendChild(label);
      });

      testExplainEl.value = ans.explanation || "";

      if (testSession.graded && ans.hasOwnProperty("isCorrect")) {
        if (ans.isCorrect) {
          testFeedbackEl.textContent = "K·∫øt qu·∫£: ƒê√∫ng. Ti·∫øp t·ª•c duy tr√¨ c√°ch l√†m n√†y üëå";
        } else {
          testFeedbackEl.textContent =
            "K·∫øt qu·∫£: Sai. ƒê√°p √°n ƒë√∫ng l√† " +
            String.fromCharCode(65 + (q.correct_index ?? 0)) +
            ". H√£y xem l·∫°i h∆∞·ªõng d·∫´n ho·∫∑c nh·ªù tr·ª£ l√Ω To√°n gi·∫£i chi ti·∫øt.";
        }
      } else {
        testFeedbackEl.textContent = "";
      }

      btnPrevQuestion.disabled = idx === 0;
      btnNextQuestion.disabled = idx === testSession.questions.length - 1;
    }

    function saveCurrentAnswer() {
      if (!testSession) return;
      const idx = testSession.currentIndex;
      const ans = testSession.answers[idx];

      const selected = document.querySelector('input[name="test-option"]:checked');
      ans.choice = selected ? parseInt(selected.value, 10) : null;
      ans.explanation = testExplainEl.value.trim();
    }

    function goToPrevQuestion() {
      if (!testSession) return;
      saveCurrentAnswer();
      if (testSession.currentIndex > 0) {
        testSession.currentIndex -= 1;
        renderCurrentTestQuestion();
      }
    }

    function goToNextQuestion() {
      if (!testSession) return;
      saveCurrentAnswer();
      if (testSession.currentIndex < testSession.questions.length - 1) {
        testSession.currentIndex += 1;
        renderCurrentTestQuestion();
      }
    }

    function describeStandardLevel(total, correct) {
      if (!total) return "Ch∆∞a c√≥ c√¢u h·ªèi thu·ªôc nh√≥m n√†y trong b√†i ki·ªÉm tra.";
      const ratio = correct / total;
      if (ratio >= 0.8) {
        return "M·∫°nh ‚Äì em l√†m t·ªët h·∫ßu h·∫øt c√¢u h·ªèi thu·ªôc nh√≥m chu·∫©n n√†y.";
      } else if (ratio >= 0.5) {
        return "Trung b√¨nh ‚Äì em ƒë√£ n·∫Øm ƒë∆∞·ª£c m·ªôt ph·∫ßn, n√™n luy·ªán th√™m ƒë·ªÉ v·ªØng h∆°n.";
      }
      return "Y·∫øu ‚Äì c·∫ßn √¥n l·∫°i l√Ω thuy·∫øt c∆° b·∫£n v√† l√†m th√™m b√†i t·∫≠p m·∫´u.";
    }

    function overallText(total, correct) {
      if (!total) {
        return "Ch∆∞a c√≥ ƒë·ªß d·ªØ li·ªáu ƒë·ªÉ ƒë√°nh gi√°.";
      }
      const ratio = correct / total;
      if (ratio >= 0.8) {
        return "K·∫øt qu·∫£ cho th·∫•y em ƒëang l√†m kh√° t·ªët b√†i ki·ªÉm tra n√†y. Em c√≥ th·ªÉ b·∫Øt ƒë·∫ßu luy·ªán c√°c d·∫°ng b√†i n√¢ng cao v√† duy tr√¨ √¥n t·∫≠p c√°c ch·ªß ƒë·ªÅ ƒë√£ v·ªØng.";
      } else if (ratio >= 0.5) {
        return "K·∫øt qu·∫£ ·ªü m·ª©c trung b√¨nh. Em ƒë√£ n·∫Øm ƒë∆∞·ª£c m·ªôt ph·∫ßn ki·∫øn th·ª©c nh∆∞ng v·∫´n c·∫ßn luy·ªán th√™m m·ªôt s·ªë d·∫°ng b√†i ƒë·ªÉ ch·∫Øc h∆°n.";
      }
      return "K·∫øt qu·∫£ cho th·∫•y em c·∫ßn t·∫≠p trung c·ªßng c·ªë l·∫°i c√°c ki·∫øn th·ª©c c∆° b·∫£n, n√™n xem l·∫°i l√Ω thuy·∫øt v√† l√†m th√™m b√†i t·∫≠p m·∫´u cho t·ª´ng chu·∫©n.";
    }

    function gradeCurrentTest() {
      if (!testSession) return;
      saveCurrentAnswer();

      const { questions, answers } = testSession;
      let correct = 0;
      const perStandard = {};
      const results = [];

      questions.forEach((q, idx) => {
        const ans = answers[idx];
        const isCorrect = ans.choice === q.correct_index;
        ans.isCorrect = isCorrect;

        if (isCorrect) correct++;

        (q.standards || []).forEach(code => {
          if (!perStandard[code]) perStandard[code] = { total: 0, correct: 0 };
          perStandard[code].total += 1;
          if (isCorrect) perStandard[code].correct += 1;
        });

        results.push({
          index: idx + 1,
          question: q.text,
          choice: ans.choice,
          explanation: ans.explanation,
          standards: q.standards || [],
          isCorrect
        });
      });

      testSession.graded = true;
      testSession.perStandard = perStandard;
      testSession.correctCount = correct;

      const modeLabel =
        testSession.mode === "input" ? "ƒë·∫ßu v√†o"
          : testSession.mode === "output" ? "ƒë·∫ßu ra"
          : "quiz luy·ªán t·∫≠p";

      testSummary.textContent =
        `ƒê√£ ch·∫•m xong b√†i ${modeLabel}. H√£y xem l·∫°i t·ª´ng c√¢u, sau ƒë√≥ xu·∫•t PDF ƒë·ªÉ l·∫•y b√°o c√°o v√† k·∫ø ho·∫°ch h·ªçc 1 qu√Ω.`;

      lastTestResults = {
        mode: testSession.mode,
        totalQuestions: questions.length,
        correct,
        perStandard,
        results
      };

      exportPdfBtn.disabled = questions.length === 0;
      exportPdfGlobalBtn.disabled = questions.length === 0;

      renderCurrentTestQuestion();

      const conv = getCurrentConversation();
      const summaryLine = `T√≥m t·∫Øt ${modeLabel}: em l√†m ƒë√∫ng kho·∫£ng ${correct}/${questions.length} c√¢u. M·ªôt s·ªë chu·∫©n c·∫ßn ch√∫ √Ω th√™m: ${
        Object.keys(perStandard).filter(c => {
          const info = perStandard[c];
          return info.total && info.correct / info.total < 0.8;
        }).join(", ") || "ch∆∞a r√µ"
      }.`;
      conv.messages.push({
        role: "assistant",
        content: summaryLine
      });
      renderMessages();
    }

    // === L·∫¨P 3 B·∫¢NG / 3 TH√ÅNG ===
    function buildQuarterCalendar(perStandard) {
      const entries = Object.entries(perStandard || {});

      if (!entries.length) {
        return [
          {
            text: "Ch∆∞a c√≥ d·ªØ li·ªáu r√µ ƒë·ªÉ l·∫≠p l·ªãch chi ti·∫øt. Em c√≥ th·ªÉ b·∫Øt ƒë·∫ßu t·ª´ c√°c ch·ªß ƒë·ªÅ c∆° b·∫£n (T1‚ÄìT5), m·ªói tu·∫ßn ch·ªçn 1‚Äì2 ch·ªß ƒë·ªÅ ƒë·ªÉ √¥n l·∫°i v√† l√†m b√†i t·∫≠p.",
            margin: [0, 4, 0, 0]
          }
        ];
      }

      const weakCodes = [];
      const midCodes = [];
      const strongCodes = [];

      entries.forEach(([code, info]) => {
        const ratio = info.total ? info.correct / info.total : 0;
        if (ratio < 0.5) weakCodes.push(code);
        else if (ratio < 0.8) midCodes.push(code);
        else strongCodes.push(code);
      });

      const weakStr = weakCodes.length ? weakCodes.join(", ") : "c√°c chu·∫©n c∆° b·∫£n (T1‚ÄìT5)";
      const midStr  = midCodes.length  ? midCodes.join(", ")  : weakStr;
      const strongStr = strongCodes.length ? strongCodes.join(", ") : midStr;

      const headerRow = ["T2", "T3", "T4", "T5", "T6", "T7", "CN"];

      function buildMonth(title, weekTexts) {
        const body = [ headerRow ];
        weekTexts.forEach(text => {
          body.push(new Array(7).fill(text));
        });
        return [
          { text: title, style: "sectionTitle" },
          {
            table: {
              headerRows: 1,
              widths: ["*", "*", "*", "*", "*", "*", "*"],
              body
            },
            layout: "lightHorizontalLines",
            margin: [0, 4, 0, 12]
          }
        ];
      }

      const month1Texts = [
        `Tu·∫ßn 1: √în c√°c chu·∫©n y·∫øu ${weakStr}; m·ªói ng√†y 3‚Äì5 b√†i c∆° b·∫£n.`,
        `Tu·∫ßn 2: Ti·∫øp t·ª•c ${weakStr}, t·∫≠p trung v√†o d·∫°ng em l√†m sai trong b√†i ki·ªÉm tra.`,
        `Tu·∫ßn 3: K·∫øt h·ª£p ${weakStr} v·ªõi ${midStr} trong c√°c b√†i t·ªïng h·ª£p ng·∫Øn.`,
        `Tu·∫ßn 4: L√†m 1‚Äì2 ƒë·ªÅ ng·∫Øn bao ph·ªß ${weakStr} v√† ${midStr}.`
      ];

      const month2Texts = [
        `Tu·∫ßn 5: √în nhanh ${weakStr}, b·∫Øt ƒë·∫ßu tƒÉng s·ªë b√†i v·∫≠n d·ª•ng.`,
        `Tu·∫ßn 6: T·∫≠p trung ${midStr} ‚Äì m·ªói ng√†y ph·ªëi h·ª£p 2‚Äì3 d·∫°ng b√†i.`,
        `Tu·∫ßn 7: Xen k·∫Ω b√†i to√°n th·ª±c t·∫ø (T15) v·ªõi ${weakStr}/${midStr}.`,
        `Tu·∫ßn 8: L√†m 1 ƒë·ªÅ m√¥ ph·ªèng ki·ªÉm tra tr√™n l·ªõp, t·ª± ch·∫•m v√† r√∫t kinh nghi·ªám.`
      ];

      const month3Texts = [
        `Tu·∫ßn 9: √în l·∫°i to√†n b·ªô ${weakStr} + ${midStr}; t·ªïng h·ª£p c√¥ng th·ª©c & l·ªói sai hay g·∫∑p.`,
        `Tu·∫ßn 10: M·ªói ng√†y ch·ªçn 1 chu·∫©n b·∫•t k·ª≥ l√†m 3‚Äì5 b√†i, ghi l·∫°i l·ªói sai.`,
        `Tu·∫ßn 11: L√†m 2 ƒë·ªÅ t·ªïng h·ª£p 45 ph√∫t, b·∫•m gi·ªù nh∆∞ ki·ªÉm tra th·∫≠t.`,
        `Tu·∫ßn 12: √în nh·∫π, xem l·∫°i ‚Äúcheat sheet‚Äù c√¥ng th·ª©c v√† nh·ªØng c√¢u sai tr∆∞·ªõc ƒë√≥.`
      ];

      let blocks = [];
      blocks = blocks
        .concat(buildMonth("Th√°ng 1 ‚Äì C·ªßng c·ªë n·ªÅn t·∫£ng", month1Texts))
        .concat(buildMonth("Th√°ng 2 ‚Äì M·ªü r·ªông & v·∫≠n d·ª•ng", month2Texts))
        .concat(buildMonth("Th√°ng 3 ‚Äì √în t·∫≠p & ki·ªÉm tra", month3Texts));

      return blocks;
    }

    function exportPdfReport() {
      if (!lastTestResults) return;
      if (!window.pdfMake) {
        alert("Kh√¥ng t·∫£i ƒë∆∞·ª£c th∆∞ vi·ªán pdfMake. Ki·ªÉm tra /static/js/pdfmake.min.js v√† vfs_fonts.js.");
        return;
      }

      const s = lastTestResults;
      const modeLabel =
        s.mode === "input" ? "ƒë·∫ßu v√†o"
          : s.mode === "output" ? "ƒë·∫ßu ra"
          : "quiz luy·ªán t·∫≠p";

      const overall = overallText(s.totalQuestions, s.correct);
      const perStandard = s.perStandard || {};
      const entries = Object.entries(perStandard).sort((a, b) => a[0].localeCompare(b[0]));

      const tableBody = [
        [
          { text: "Chu·∫©n", bold: true },
          { text: "N·ªôi dung", bold: true },
          { text: "ƒê√∫ng/S·ªë c√¢u", bold: true },
          { text: "Nh·∫≠n x√©t", bold: true }
        ]
      ];

      if (!entries.length) {
        tableBody.push([
          { text: "‚Äî", italics: true },
          { text: "‚Äî", italics: true },
          { text: "‚Äî", italics: true },
          { text: "Ch∆∞a c√≥ ƒë·ªß d·ªØ li·ªáu ƒë·ªÉ th·ªëng k√™ theo chu·∫©n.", italics: true }
        ]);
      } else {
        entries.forEach(([code, info]) => {
          const label = STANDARD_LABELS[code] || ("Chu·∫©n " + code);
          const correct = info.correct || 0;
          const total = info.total || 0;
          const rate = total ? Math.round((correct / total) * 100) : 0;
          tableBody.push([
            code,
            label,
            `${correct}/${total} (${rate}%)`,
            describeStandardLevel(total, correct)
          ]);
        });
      }

      const calendarBlocks = buildQuarterCalendar(perStandard);

      const docDefinition = {
        content: [
          {
            text: `B√°o c√°o & k·∫ø ho·∫°ch h·ªçc 1 qu√Ω ‚Äì B√†i ${modeLabel} T1‚ÄìT15 ‚Äì K9 Math AI Assistant`,
            style: "header"
          },
          {
            text: "Th·ªùi gian: " + new Date().toLocaleString(),
            style: "subheader",
            margin: [0, 4, 0, 12]
          },
          { text: "1. ƒê√°nh gi√° t·ªïng quan", style: "sectionTitle" },
          {
            text: overall,
            margin: [0, 4, 0, 12]
          },

          { text: "2. ƒê√°nh gi√° theo t·ª´ng nh√≥m chu·∫©n", style: "sectionTitle" },
          {
            table: {
              widths: ["auto", "*", "auto", "*"],
              body: tableBody
            },
            layout: "lightHorizontalLines",
            margin: [0, 6, 0, 12]
          },

          { text: "3. K·∫ø ho·∫°ch h·ªçc t·∫≠p trong 1 qu√Ω (3 th√°ng, ~12 tu·∫ßn)", style: "sectionTitle" },
          ...calendarBlocks
        ],
        styles: {
          header: {
            fontSize: 16,
            bold: true
          },
          subheader: {
            fontSize: 10,
            italics: true
          },
          sectionTitle: {
            fontSize: 12,
            bold: true,
            margin: [0, 8, 0, 4]
          }
        },
        defaultStyle: {
          font: "Roboto",
          fontSize: 11
        }
      };

      const fileName = `Bao_cao_ke_hoach_quy_${modeLabel.replace(" ", "_")}_T1-T15.pdf`;
      pdfMake.createPdf(docDefinition).download(fileName);
    }

    // ===== EVT =====
    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
    sendBtn.addEventListener("click", sendMessage);

    newChatBtn.addEventListener("click", () => {
      createNewConversation();
      renderChatList();
      renderMessages();
      updateHeaderTags();
      statusLine.textContent = "";
    });

    runTestsBtn.addEventListener("click", () => openTestPanel("input"));
    createQuizBtn.addEventListener("click", () => openTestPanel("quiz"));

    btnSwitchInput.addEventListener("click", () => openTestPanel("input"));
    btnSwitchOutput.addEventListener("click", () => openTestPanel("output"));
    btnCloseTest.addEventListener("click", closeTestPanel);

    btnPrevQuestion.addEventListener("click", goToPrevQuestion);
    btnNextQuestion.addEventListener("click", goToNextQuestion);
    btnGradeTest.addEventListener("click", gradeCurrentTest);

    exportPdfBtn.addEventListener("click", exportPdfReport);
    exportPdfGlobalBtn.addEventListener("click", exportPdfReport);

    // Init
    createNewConversation();
    statusText.textContent = "Server: " + window.location.origin;
  </script>
</body>
</html>

