<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>K9 Math AI Assistant ‚Äì Chat</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root {
      --bg-main: #050816;
      --bg-chat: #0b1020;
      --bg-msg-user: #1f2937;
      --bg-msg-assistant: #111827;
      --accent: #10b981;
      --accent-soft: rgba(16,185,129,0.15);
      --border-subtle: #374151;
      --text-main: #e5e7eb;
      --text-soft: #9ca3af;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text-main);
      background: radial-gradient(circle at top, #1f2937 0, #020617 55%, #000 100%);
    }
    .layout {
      display: flex;
      width: 100%;
      height: 100%;
    }
    /* Sidebar */
    .sidebar {
      width: 260px;
      background: #020617;
      border-right: 1px solid #111827;
      padding: 12px 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .sidebar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 4px 6px 0;
    }
    .logo {
      font-size: 14px;
      font-weight: 600;
      color: #f9fafb;
    }
    .subtitle {
      font-size: 11px;
      color: var(--text-soft);
    }
    .new-chat-btn {
      margin-top: 8px;
      width: 100%;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #374151;
      background: linear-gradient(to right, #111827, #020617);
      color: #e5e7eb;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }
    .new-chat-btn span.icon {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: var(--accent-soft);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }
    .new-chat-btn:hover {
      border-color: var(--accent);
    }
    .chat-list {
      flex: 1;
      margin-top: 4px;
      overflow-y: auto;
      padding-right: 2px;
    }
    .chat-item {
      padding: 8px 10px;
      border-radius: 8px;
      margin-bottom: 4px;
      font-size: 13px;
      color: var(--text-soft);
      display: flex;
      flex-direction: column;
      gap: 2px;
      cursor: pointer;
    }
    .chat-item.active {
      background: linear-gradient(to right, rgba(16,185,129,0.18), rgba(15,23,42,0.9));
      color: #f9fafb;
    }
    .chat-item-title {
      font-weight: 500;
    }
    .chat-item-sub {
      font-size: 11px;
    }
    .sidebar-footer {
      padding: 8px 6px;
      border-top: 1px solid #111827;
      font-size: 11px;
      color: #6b7280;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      padding: 2px 7px;
      font-size: 10px;
      background: rgba(31,41,55,0.9);
      margin-right: 4px;
      margin-bottom: 2px;
    }
    .badge span.dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      margin-right: 4px;
      background: var(--accent);
    }

    /* Main */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .main-header {
      padding: 10px 16px;
      border-bottom: 1px solid #111827;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(15,23,42,0.9);
      backdrop-filter: blur(10px);
      gap: 8px;
    }
    .main-header-title {
      font-size: 13px;
      font-weight: 500;
      display: flex;
      flex-direction: column;
    }
    .main-header-title span.sub {
      font-size: 11px;
      color: var(--text-soft);
    }
    .header-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
      max-width: 55%;
    }
    .header-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    .header-btn {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #374151;
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .header-btn span.icon {
      font-size: 12px;
    }
    .header-btn:hover {
      border-color: var(--accent);
    }
    .header-btn:disabled {
      opacity: 0.5;
      cursor: default;
    }
    .tag-list {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      justify-content: flex-end;
    }
    .tag-chip {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(16,185,129,0.15);
      color: #a7f3d0;
      border: 1px solid rgba(16,185,129,0.35);
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px 18px 8px;
      background: radial-gradient(circle at top, #111827 0, #020617 45%, #000 100%);
    }
    .message-row {
      margin-bottom: 12px;
      display: flex;
    }
    .message-row.assistant { justify-content: flex-start; }
    .message-row.user { justify-content: flex-end; }

    .message-bubble {
      max-width: 70%;
      padding: 10px 12px;
      border-radius: 16px;
      font-size: 14px;
      line-height: 1.45;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .assistant .message-bubble {
      background: var(--bg-msg-assistant);
      border: 1px solid #1f2937;
    }
    .user .message-bubble {
      background: var(--bg-msg-user);
      border: 1px solid #374151;
    }
    .message-meta {
      font-size: 10px;
      color: var(--text-soft);
      margin-bottom: 2px;
      padding: 0 4px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .avatar {
      width: 20px;
      height: 20px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-right: 6px;
      font-size: 12px;
    }
    .avatar.assistant {
      background: rgba(16,185,129,0.15);
      color: #6ee7b7;
    }
    .avatar.user {
      background: rgba(59,130,246,0.15);
      color: #bfdbfe;
    }

    .input-bar {
      padding: 10px 16px 14px;
      border-top: 1px solid #111827;
      background: radial-gradient(circle at top, #020617 0, #000 100%);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .input-top {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: var(--text-soft);
      gap: 8px;
      flex-wrap: wrap;
    }
    .input-row {
      display: flex;
      align-items: flex-end;
      gap: 8px;
    }
    .input-box-wrap {
      flex: 1;
      position: relative;
    }
    .input-box {
      width: 100%;
      padding: 10px 40px 10px 12px;
      border-radius: 999px;
      border: 1px solid #374151;
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      font-size: 14px;
      resize: none;
      max-height: 100px;
      min-height: 40px;
      outline: none;
    }
    .input-box::placeholder {
      color: #6b7280;
    }
    .input-actions-right {
      position: absolute;
      right: 6px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .icon-btn {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      border: none;
      background: transparent;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #9ca3af;
      font-size: 14px;
    }
    .icon-btn:hover {
      background: rgba(31,41,55,0.9);
      color: #e5e7eb;
    }
    .send-btn {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      border: none;
      background: var(--accent);
      color: #022c22;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 16px;
    }
    .send-btn:disabled {
      opacity: 0.4;
      cursor: default;
    }
    .status-line {
      font-size: 11px;
      color: var(--text-soft);
      min-height: 14px;
    }
    .status-line.error {
      color: #fca5a5;
    }

    #file-input {
      display: none;
    }

    /* Test panel overlay */
    .test-panel {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.65);
      z-index: 40;
      font-size: 12px;
    }
    .test-panel-inner {
      width: min(960px, 95vw);
      max-height: 85vh;
      background: #020617;
      border-radius: 16px;
      border: 1px solid #111827;
      padding: 12px 16px 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .test-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      gap: 8px;
    }
    .test-panel-title-group {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .test-summary {
      font-size: 11px;
      color: var(--text-soft);
    }
    .test-panel-switch {
      display: flex;
      gap: 6px;
      align-items: center;
    }
    .test-panel-footer {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 6px;
    }
    .test-table-wrapper {
      max-height: 55vh;
      overflow-y: auto;
      border-radius: 8px;
      border: 1px solid #111827;
      background: #020617;
    }
    table.test-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }
    .test-table th,
    .test-table td {
      padding: 4px 6px;
      border-bottom: 1px solid #111827;
      vertical-align: top;
    }
    .test-table th {
      position: sticky;
      top: 0;
      background: #020617;
      z-index: 1;
    }
    .badge-pass {
      display: inline-flex;
      padding: 1px 5px;
      border-radius: 999px;
      background: rgba(16,185,129,0.15);
      color: #6ee7b7;
      border: 1px solid rgba(16,185,129,0.5);
      font-size: 10px;
    }
    .badge-fail {
      display: inline-flex;
      padding: 1px 5px;
      border-radius: 999px;
      background: rgba(239,68,68,0.12);
      color: #fecaca;
      border: 1px solid rgba(248,113,113,0.7);
      font-size: 10px;
    }

    @media (max-width: 800px) {
      .sidebar {
        display: none;
      }
      .header-right {
        max-width: 60%;
      }
    }
  </style>

  <!-- jsPDF d√πng ƒë·ªÉ xu·∫•t PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"
          integrity="sha512-3cWrdYkRjakGugHgdGXNq35p3xNmPR9U1FVLtZL1YI7DiIP9N6byN1Nsx3Rp3XIanFkFJxuxMxDPZLIFLZhoUw=="
          crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <!-- MathJax -->
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']]
      },
      svg: { fontCache: 'global' }
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" async></script>
</head>
<body>
  <div class="layout">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div>
          <div class="logo">K9 Math AI</div>
          <div class="subtitle">Tr·ª£ l√Ω To√°n 9 ‚Äì AI for Good</div>
        </div>
      </div>
      <button class="new-chat-btn" id="btn-new-chat">
        <span class="icon">+</span>
        <span>Cu·ªôc tr√≤ chuy·ªán m·ªõi</span>
      </button>

      <div class="chat-list" id="chat-list"></div>

      <div class="sidebar-footer">
        <div>Chu·∫©n ƒë·∫ßu ra (T1‚ÄìT15)</div>
        <div style="margin-top:4px;">
          <div class="badge"><span class="dot"></span>T1 ‚Äì S·ªë &amp; l≈©y th·ª´a</div>
          <div class="badge"><span class="dot"></span>T2 ‚Äì T·ªâ l·ªá &amp; ph·∫ßn trƒÉm</div>
          <div class="badge"><span class="dot"></span>T3 ‚Äì G√≥c &amp; tam gi√°c</div>
          <!-- C√≥ th·ªÉ b·ªï sung th√™m T4..T15 sau -->
        </div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <header class="main-header">
        <div class="main-header-title">
          <span>Chat v·ªõi Tr·ª£ l√Ω To√°n AI</span>
          <span class="sub">
            ƒê·∫∑t c√¢u h·ªèi, t·∫£i b√†i t·∫≠p, nh·ªù AI ph√¢n t√≠ch &amp; ph√¢n lo·∫°i theo chu·∫©n T1‚ÄìT15.
          </span>
        </div>
        <div class="header-right">
          <div class="header-actions">
            <button class="header-btn" id="btn-run-tests">
              <span class="icon">üß™</span>
              <span>L√†m b√†i ki·ªÉm tra ƒë·∫ßu v√†o / ƒë·∫ßu ra</span>
            </button>

            <button class="header-btn" id="btn-create-quiz">
              <span class="icon">‚ùì</span>
              <span>T·∫°o quiz luy·ªán t·∫≠p</span>
            </button>

            <!-- N√∫t xu·∫•t PDF chung: ch·ªâ b·∫≠t sau khi ƒë√£ ch·∫•m b√†i -->
            <button class="header-btn" id="btn-export-pdf-global" disabled>
              <span class="icon">üìÑ</span>
              <span>Xu·∫•t PDF ƒë√°nh gi√°</span>
            </button>
          </div>
          <div class="tag-list" id="header-tags">
            <!-- Dynamic tags -->
          </div>
        </div>
      </header>

      <section class="messages" id="messages"></section>

      <!-- TEST PANEL OVERLAY -->
      <section class="test-panel" id="test-panel" style="display:none;">
        <div class="test-panel-inner">
          <div class="test-panel-header">
            <div class="test-panel-title-group">
              <div class="test-panel-header-title" id="test-panel-title">
                B√†i ki·ªÉm tra ƒë·∫ßu v√†o T1‚ÄìT15
              </div>
              <div class="test-summary" id="test-summary"></div>
            </div>
            <div class="test-panel-switch">
              <button class="header-btn" id="btn-switch-input">ƒê·∫ßu v√†o</button>
              <button class="header-btn" id="btn-switch-output">ƒê·∫ßu ra</button>
              <button class="header-btn" id="btn-close-test">‚úï</button>
            </div>
          </div>
          <div class="test-table-wrapper">
            <table class="test-table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>C√¢u h·ªèi</th>
                  <th>Chu·∫©n</th>
                  <th>ƒê√°p √°n c·ªßa b·∫°n</th>
                  <th>K·∫øt qu·∫£</th>
                </tr>
              </thead>
              <tbody id="test-table-body"></tbody>
            </table>
          </div>
          <div class="test-panel-footer">
            <button class="header-btn" id="btn-grade-test">
              <span class="icon">‚úî</span>
              <span>Ch·∫•m b√†i</span>
            </button>
            <button class="header-btn" id="btn-export-pdf" disabled>
              <span class="icon">üìÑ</span>
              <span>Xu·∫•t PDF b√°o c√°o</span>
            </button>
          </div>
        </div>
      </section>

      <section class="input-bar">
        <div class="input-top">
          <span>Tip: B·∫°n c√≥ th·ªÉ t·∫£i file PDF/TXT b√†i t·∫≠p, h·ªá th·ªëng s·∫Ω ƒë·ªçc &amp; ph√¢n t√≠ch t·ª± ƒë·ªông.</span>
          <span id="status-text"></span>
        </div>
        <div class="input-row">
          <div class="input-box-wrap">
            <textarea id="chat-input" class="input-box" rows="1"
                      placeholder="ƒê·∫∑t c√¢u h·ªèi To√°n 9 ho·∫∑c d√°n ƒë·ªÅ b√†i ·ªü ƒë√¢y..."></textarea>
            <div class="input-actions-right">
              <button class="icon-btn" id="btn-upload" title="T·∫£i file b√†i t·∫≠p">
                üìé
              </button>
            </div>
          </div>
          <button class="send-btn" id="btn-send" title="G·ª≠i">
            ‚û§
          </button>
          <input type="file" id="file-input" accept=".txt,.pdf,.md,.json">
        </div>
        <div class="status-line" id="status-line"></div>
      </section>
    </main>
  </div>

  <script>
    // ======= C·∫§U H√åNH BACKEND (c√πng domain) =======
    const API_BASE = ""; // d√πng ƒë∆∞·ªùng d·∫´n t∆∞∆°ng ƒë·ªëi: "/chat/message", "/file/parse"

    // Nh√£n T1‚ÄìT15 ƒë·ªÉ b√°o c√°o PDF
    const STANDARD_LABELS = {
      T1: "S·ªë & l≈©y th·ª´a",
      T2: "T·ªâ l·ªá & ph·∫ßn trƒÉm",
      T3: "G√≥c & tam gi√°c",
      T4: "CƒÉn b·∫≠c hai",
      T5: "Ph∆∞∆°ng tr√¨nh b·∫≠c nh·∫•t",
      T6: "H·ªá ph∆∞∆°ng tr√¨nh",
      T7: "B·∫•t ph∆∞∆°ng tr√¨nh",
      T8: "H√†m s·ªë & ƒë·ªì th·ªã",
      T9: "Tam gi√°c vu√¥ng & ƒë·ªãnh l√Ω Pytago",
      T10: "ƒê∆∞·ªùng tr√≤n",
      T11: "Ti·∫øp tuy·∫øn",
      T12: "H√¨nh tr·ª•, n√≥n, c·∫ßu",
      T13: "Th·ªëng k√™",
      T14: "X√°c su·∫•t",
      T15: "B√†i to√°n th·ª±c t·∫ø"
    };

    // ======= STATE FRONTEND =======
    let conversations = {};
    let currentId = null;
    let chatCounter = 1;

    const chatListEl = document.getElementById("chat-list");
    const messagesEl = document.getElementById("messages");
    const headerTagsEl = document.getElementById("header-tags");
    const inputEl = document.getElementById("chat-input");
    const sendBtn = document.getElementById("btn-send");
    const statusLine = document.getElementById("status-line");
    const fileInput = document.getElementById("file-input");
    const uploadBtn = document.getElementById("btn-upload");
    const newChatBtn = document.getElementById("btn-new-chat");
    const statusText = document.getElementById("status-text");

    const runTestsBtn = document.getElementById("btn-run-tests");
    const createQuizBtn = document.getElementById("btn-create-quiz");
    const exportPdfBtn = document.getElementById("btn-export-pdf");
    const exportPdfGlobalBtn = document.getElementById("btn-export-pdf-global");

    const testPanel = document.getElementById("test-panel");
    const testPanelTitle = document.getElementById("test-panel-title");
    const testTableBody = document.getElementById("test-table-body");
    const testSummary = document.getElementById("test-summary");
    const btnSwitchInput = document.getElementById("btn-switch-input");
    const btnSwitchOutput = document.getElementById("btn-switch-output");
    const btnCloseTest = document.getElementById("btn-close-test");
    const btnGradeTest = document.getElementById("btn-grade-test");

    let lastTestResults = null; // ch·ªâ l∆∞u trong phi√™n
    let testMode = "input"; // 'input' | 'output'
    let testQuestions = [];

    function createNewConversation() {
      const id = "chat-" + Date.now();
      conversations[id] = {
        id,
        title: "Cu·ªôc tr√≤ chuy·ªán " + chatCounter++,
        messages: [],
        standards: []
      };
      currentId = id;
      renderChatList();
      renderMessages();
      updateHeaderTags();
      inputEl.focus();
    }

    function getCurrentConversation() {
      if (!currentId || !conversations[currentId]) {
        createNewConversation();
      }
      return conversations[currentId];
    }

    function renderChatList() {
      chatListEl.innerHTML = "";
      Object.values(conversations).forEach(conv => {
        const div = document.createElement("div");
        div.className = "chat-item" + (conv.id === currentId ? " active" : "");
        div.onclick = () => {
          currentId = conv.id;
          renderChatList();
          renderMessages();
          updateHeaderTags();
        };
        const title = document.createElement("div");
        title.className = "chat-item-title";
        title.textContent = conv.title;
        const sub = document.createElement("div");
        sub.className = "chat-item-sub";
        if (conv.messages.length) {
          const first = conv.messages[0].content || "";
          sub.textContent = first.slice(0, 32) + (first.length > 32 ? "‚Ä¶" : "");
        } else {
          sub.textContent = "Ch∆∞a c√≥ n·ªôi dung";
        }
        div.appendChild(title);
        div.appendChild(sub);
        chatListEl.appendChild(div);
      });
    }

    function renderMessages() {
      const conv = getCurrentConversation();
      messagesEl.innerHTML = "";
      if (!conv.messages.length) {
        const intro = document.createElement("div");
        intro.style.color = "#9ca3af";
        intro.style.fontSize = "13px";
        intro.style.maxWidth = "480px";
        intro.style.margin = "40px auto 0";
        intro.style.textAlign = "center";
        intro.innerHTML = "Ch√†o b·∫°n üëã<br>H√£y ƒë·∫∑t c√¢u h·ªèi To√°n 9, t·∫£i file b√†i t·∫≠p, ho·∫∑c nh·ªù m√¨nh ph√¢n t√≠ch l·ªói sai theo chu·∫©n T1‚ÄìT15.";
        messagesEl.appendChild(intro);
      } else {
        conv.messages.forEach(msg => {
          const row = document.createElement("div");
          row.className = "message-row " + msg.role;

          const wrapper = document.createElement("div");
          const meta = document.createElement("div");
          meta.className = "message-meta";

          const avatar = document.createElement("span");
          avatar.className = "avatar " + msg.role;
          avatar.textContent = msg.role === "assistant" ? "AI" : "You";

          const metaText = document.createElement("span");
          metaText.textContent = msg.role === "assistant" ? "Tr·ª£ l√Ω To√°n AI" : "B·∫°n";

          meta.appendChild(avatar);
          meta.appendChild(metaText);

          const bubble = document.createElement("div");
          bubble.className = "message-bubble";
          bubble.textContent = msg.content;

          wrapper.appendChild(meta);
          wrapper.appendChild(bubble);
          row.appendChild(wrapper);
          messagesEl.appendChild(row);
        });
      }

      messagesEl.scrollTop = messagesEl.scrollHeight;

      // Render l·∫°i MathJax sau khi c·∫≠p nh·∫≠t DOM
      if (window.MathJax && window.MathJax.typesetPromise) {
        window.MathJax.typesetPromise();
      }
    }

    function updateHeaderTags() {
      const conv = getCurrentConversation();
      headerTagsEl.innerHTML = "";
      if (!conv.standards || !conv.standards.length) return;
      conv.standards.forEach(code => {
        const div = document.createElement("div");
        div.className = "tag-chip";
        div.textContent = code;
        headerTagsEl.appendChild(div);
      });
    }

    async function sendMessage() {
      const text = inputEl.value.trim();
      if (!text) return;
      const conv = getCurrentConversation();

      conv.messages.push({ role: "user", content: text });
      inputEl.value = "";
      renderMessages();
      statusLine.textContent = "ƒêang suy nghƒ©‚Ä¶";
      statusLine.classList.remove("error");
      sendBtn.disabled = true;

      try {
        const payload = {
          messages: conv.messages.map(m => ({ role: m.role, content: m.content }))
        };
        const res = await fetch(API_BASE + "/chat/message", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        conv.messages.push({ role: "assistant", content: data.reply });
        conv.standards = data.standards || [];
        renderMessages();
        updateHeaderTags();
        renderChatList();
        statusLine.textContent = "";
      } catch (err) {
        console.error(err);
        statusLine.textContent = "Kh√¥ng g·ªçi ƒë∆∞·ª£c API /chat/message. Ki·ªÉm tra server.";
        statusLine.classList.add("error");
      } finally {
        sendBtn.disabled = false;
      }
    }

    // G·ª≠i l·∫°i to√†n b·ªô l·ªãch s·ª≠ h·ªôi tho·∫°i hi·ªán t·∫°i (d√πng sau khi ƒë·ªçc file)
    async function sendHistoryOnly() {
      const conv = getCurrentConversation();
      if (!conv.messages.length) return;
      statusLine.textContent = "ƒêang ph√¢n t√≠ch‚Ä¶";
      statusLine.classList.remove("error");
      sendBtn.disabled = true;

      try {
        const payload = {
          messages: conv.messages.map(m => ({ role: m.role, content: m.content }))
        };
        const res = await fetch(API_BASE + "/chat/message", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        conv.messages.push({ role: "assistant", content: data.reply });
        conv.standards = data.standards || [];
        renderMessages();
        updateHeaderTags();
        renderChatList();
        statusLine.textContent = "";
      } catch (err) {
        console.error(err);
        statusLine.textContent = "Kh√¥ng g·ªçi ƒë∆∞·ª£c API /chat/message. Ki·ªÉm tra server.";
        statusLine.classList.add("error");
      } finally {
        sendBtn.disabled = false;
      }
    }

    // Upload file ‚Üí /file/parse ‚Üí th√™m v√†o chat ‚Üí g·ªçi AI
    uploadBtn.addEventListener("click", () => fileInput.click());
    fileInput.addEventListener("change", async () => {
      const file = fileInput.files[0];
      if (!file) return;

      const conv = getCurrentConversation();
      statusLine.textContent = "ƒêang ƒë·ªçc file " + file.name + "‚Ä¶";
      statusLine.classList.remove("error");

      const formData = new FormData();
      formData.append("file", file);

      try {
        const res = await fetch(API_BASE + "/file/parse", {
          method: "POST",
          body: formData
        });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        const snippet = data.content.length > 600
          ? data.content.slice(0, 600) + "\n[...ƒë√£ c·∫Øt b·ªõt...]"
          : data.content;
        const text = `N·ªôi dung tr√≠ch t·ª´ file "${data.filename}":\n\n` + snippet;

        conv.messages.push({ role: "user", content: text });
        renderMessages();

        await sendHistoryOnly();
      } catch (err) {
        console.error(err);
        statusLine.textContent = "Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c file. Ki·ªÉm tra /file/parse.";
        statusLine.classList.add("error");
      } finally {
        fileInput.value = "";
      }
    });

    // ==== B√ÄI KI·ªÇM TRA ƒê·∫¶U V√ÄO / ƒê·∫¶U RA (OVERLAY) ====
    async function openTestPanel(mode) {
      testMode = mode || "input";
      testPanel.style.display = "flex";
      testSummary.textContent =
        "ƒêang t·∫£i b√†i ki·ªÉm tra " + (testMode === "input" ? "ƒë·∫ßu v√†o" : "ƒë·∫ßu ra") + "‚Ä¶";
      exportPdfBtn.disabled = true;
      exportPdfGlobalBtn.disabled = true;
      lastTestResults = null;
      await loadTestQuestions();
    }

    function closeTestPanel() {
      testPanel.style.display = "none";
    }

    async function loadTestQuestions() {
      testTableBody.innerHTML = "";
      const endpoint = testMode === "input" ? "/api/input_quiz" : "/api/output_quiz";

      try {
        const res = await fetch(API_BASE + endpoint);
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        testQuestions = data.questions || [];
        if (!testQuestions.length) throw new Error("Kh√¥ng c√≥ c√¢u h·ªèi.");

        testPanelTitle.textContent =
          testMode === "input"
            ? "B√†i ki·ªÉm tra ƒë·∫ßu v√†o T1‚ÄìT15"
            : "B√†i ki·ªÉm tra ƒë·∫ßu ra T1‚ÄìT15";
        testSummary.textContent =
          "Ch·ªçn ƒë√°p √°n A‚ÄìD cho t·ª´ng c√¢u, sau ƒë√≥ b·∫•m \"Ch·∫•m b√†i\" ƒë·ªÉ xem ƒë√°nh gi√°.";

        // render c√¢u h·ªèi
        testTableBody.innerHTML = "";
        testQuestions.forEach((q, idx) => {
          const tr = document.createElement("tr");

          const tdIndex = document.createElement("td");
          tdIndex.textContent = idx + 1;

          const tdQuestion = document.createElement("td");
          tdQuestion.textContent = q.text;

          const tdStandards = document.createElement("td");
          tdStandards.textContent = (q.standards || []).join(", ");

          const tdAnswer = document.createElement("td");
          (q.options || []).forEach((opt, i) => {
            const label = document.createElement("label");
            label.style.display = "block";
            const radio = document.createElement("input");
            radio.type = "radio";
            radio.name = "q-" + q.id;
            radio.value = String(i);
            label.appendChild(radio);
            label.appendChild(
              document.createTextNode(
                " " + String.fromCharCode(65 + i) + ". " + opt
              )
            );
            tdAnswer.appendChild(label);
          });

          const tdResult = document.createElement("td");
          tdResult.dataset.questionId = String(q.id);

          tr.appendChild(tdIndex);
          tr.appendChild(tdQuestion);
          tr.appendChild(tdStandards);
          tr.appendChild(tdAnswer);
          tr.appendChild(tdResult);

          testTableBody.appendChild(tr);
        });
      } catch (err) {
        console.error(err);
        testSummary.textContent = "L·ªói t·∫£i b√†i ki·ªÉm tra: " + err.message;
      }
    }

    function describeStandardLevel(total, correct) {
      if (!total) {
        return "Ch∆∞a c√≥ c√¢u h·ªèi thu·ªôc nh√≥m n√†y trong b√†i ki·ªÉm tra.";
      }
      const ratio = correct / total;
      if (ratio >= 0.8) {
        return "M·∫°nh ‚Äì l√†m t·ªët h·∫ßu h·∫øt c√¢u h·ªèi thu·ªôc nh√≥m chu·∫©n n√†y.";
      } else if (ratio >= 0.5) {
        return "Trung b√¨nh ‚Äì ƒë√£ n·∫Øm ƒë∆∞·ª£c m·ªôt ph·∫ßn, n√™n luy·ªán th√™m ƒë·ªÉ v·ªØng h∆°n.";
      }
      return "C·∫ßn c·ªßng c·ªë ‚Äì n√™n √¥n l·∫°i l√Ω thuy·∫øt v√† l√†m th√™m b√†i t·∫≠p.";
    }

    function overallText(total, correct) {
      if (!total) {
        return "Ch∆∞a c√≥ ƒë·ªß d·ªØ li·ªáu ƒë·ªÉ ƒë√°nh gi√°.";
      }
      const ratio = correct / total;
      if (ratio >= 0.8) {
        return "K·∫øt qu·∫£ cho th·∫•y em ƒëang l√†m kh√° t·ªët b√†i ki·ªÉm tra n√†y. C√≥ th·ªÉ ti·∫øp t·ª•c luy·ªán c√°c d·∫°ng b√†i n√¢ng cao, ƒë·ªìng th·ªùi duy tr√¨ √¥n t·∫≠p nh·ªØng ch·ªß ƒë·ªÅ ƒë√£ l√†m ƒë√∫ng.";
      } else if (ratio >= 0.5) {
        return "K·∫øt qu·∫£ ·ªü m·ª©c trung b√¨nh. Em ƒë√£ n·∫Øm ƒë∆∞·ª£c m·ªôt ph·∫ßn ki·∫øn th·ª©c, nh∆∞ng v·∫´n c·∫ßn luy·ªán th√™m m·ªôt s·ªë d·∫°ng b√†i ƒë·ªÉ ƒë·∫°t ƒë·ªô v·ªØng ch·∫Øc cao h∆°n.";
      }
      return "K·∫øt qu·∫£ cho th·∫•y em c·∫ßn t·∫≠p trung c·ªßng c·ªë l·∫°i c√°c ki·∫øn th·ª©c c∆° b·∫£n, n√™n xem l·∫°i l√Ω thuy·∫øt v√† l√†m th√™m b√†i t·∫≠p minh h·ªça cho t·ª´ng chu·∫©n.";
    }

    function gradeCurrentTest() {
      if (!testQuestions.length) return;

      let correct = 0;
      let answered = 0;
      const results = [];
      const perStandard = {};

      testQuestions.forEach((q, idx) => {
        const selected = document.querySelector(
          `input[name="q-${q.id}"]:checked`
        );
        const userIndex = selected ? parseInt(selected.value, 10) : null;
        const isCorrect = userIndex === q.correct_index;

        if (userIndex !== null && !Number.isNaN(userIndex)) {
          answered++;
        }
        if (isCorrect) correct++;

        const resultCell = testTableBody.querySelector(
          `td[data-question-id="${q.id}"]`
        );
        if (resultCell) {
          resultCell.innerHTML = "";
          const badge = document.createElement("span");
          badge.className = isCorrect ? "badge-pass" : "badge-fail";
          badge.textContent = isCorrect ? "ƒê√∫ng" : "Sai";
          resultCell.appendChild(badge);
        }

        (q.standards || []).forEach(code => {
          if (!perStandard[code]) {
            perStandard[code] = { total: 0, correct: 0 };
          }
          perStandard[code].total += 1;
          if (isCorrect) {
            perStandard[code].correct += 1;
          }
        });

        results.push({
          index: idx + 1,
          input: q.text,
          standards: q.standards || [],
          ok: isCorrect
        });
      });

      const total = testQuestions.length;

      const modeLabel = testMode === "input" ? "ƒë·∫ßu v√†o" : "ƒë·∫ßu ra";

      // Kh√¥ng hi·ªÉn th·ªã r√µ s·ªë c√¢u ƒë√∫ng/sai, ch·ªâ nh·∫Øc ƒë√£ c√≥ ƒë√°nh gi√°
      testSummary.textContent =
        `ƒê√£ ch·∫•m xong b√†i ki·ªÉm tra ${modeLabel}. Nh·∫•n "Xu·∫•t PDF b√°o c√°o" ho·∫∑c "Xu·∫•t PDF ƒë√°nh gi√°" ƒë·ªÉ xem nh·∫≠n x√©t chi ti·∫øt theo t·ª´ng chu·∫©n.`;

      lastTestResults = {
        mode: testMode,
        totalQuestions: total,
        answered,
        correct,
        perStandard,
        results
      };

      const hasQuestions = total > 0;
      exportPdfBtn.disabled = !hasQuestions;
      exportPdfGlobalBtn.disabled = !hasQuestions;
    }

    function exportPdfReport() {
      if (!lastTestResults) return;
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: "pt", format: "a4" });

      const s = lastTestResults;
      let y = 40;
      const modeLabel = s.mode === "input" ? "ƒë·∫ßu v√†o" : "ƒë·∫ßu ra";
      const maxWidth = 500;

      doc.setFontSize(14);
      doc.text(
        `B√°o c√°o ƒë√°nh gi√° b√†i ki·ªÉm tra ${modeLabel} T1‚ÄìT15 ‚Äì K9 Math AI Assistant`,
        40,
        y
      );

      y += 20;
      doc.setFontSize(11);
      doc.text("Th·ªùi gian: " + new Date().toLocaleString(), 40, y);

      // ƒê√°nh gi√° t·ªïng quan
      y += 24;
      doc.setFontSize(11);
      doc.text("1. ƒê√°nh gi√° t·ªïng quan", 40, y);
      y += 14;
      const overallLines = doc.splitTextToSize(
        overallText(s.totalQuestions, s.correct),
        maxWidth
      );
      doc.setFontSize(10);
      doc.text(overallLines, 40, y);
      y += overallLines.length * 12;

      // ƒê√°nh gi√° theo t·ª´ng chu·∫©n
      y += 10;
      doc.setFontSize(11);
      doc.text("2. ƒê√°nh gi√° theo t·ª´ng nh√≥m chu·∫©n", 40, y);
      y += 14;
      doc.setFontSize(10);

      const codes = Object.keys(s.perStandard || {}).sort();
      if (!codes.length) {
        doc.text(
          "Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·∫ßy ƒë·ªß ƒë·ªÉ ph√¢n t√≠ch theo t·ª´ng chu·∫©n.",
          40,
          y
        );
        y += 14;
      } else {
        codes.forEach(code => {
          const info = s.perStandard[code];
          const label = STANDARD_LABELS[code] || `Chu·∫©n ${code}`;
          const levelText = describeStandardLevel(info.total, info.correct);
          if (y > 760) {
            doc.addPage();
            y = 40;
          }
          const line = `${code} ‚Äì ${label}: ${levelText}`;
          const wrapped = doc.splitTextToSize(line, maxWidth);
          doc.text(wrapped, 40, y);
          y += wrapped.length * 12;
        });
      }

      // G·ª£i √Ω ti·∫øp theo
      y += 16;
      if (y > 760) {
        doc.addPage();
        y = 40;
      }
      doc.setFontSize(11);
      doc.text("3. G·ª£i √Ω ti·∫øp theo", 40, y);
      y += 14;
      doc.setFontSize(10);
      const suggest = [
        "- Luy·ªán th√™m c√°c b√†i t·∫≠p thu·ªôc nh·ªØng chu·∫©n ƒë∆∞·ª£c ƒë√°nh gi√° \"C·∫ßn c·ªßng c·ªë\".",
        "- Xem l·∫°i l√Ω thuy·∫øt v√† v√≠ d·ª• m·∫´u cho c√°c ch·ªß ƒë·ªÅ em c√≤n sai nhi·ªÅu.",
        "- C√≥ th·ªÉ s·ª≠ d·ª•ng l·∫°i Tr·ª£ l√Ω To√°n AI ƒë·ªÉ h·ªèi t·ª´ng d·∫°ng b√†i c·ª• th·ªÉ ho·∫∑c t·∫°o quiz luy·ªán t·∫≠p."
      ];
      suggest.forEach(line => {
        const wrapped = doc.splitTextToSize(line, maxWidth);
        doc.text(wrapped, 40, y);
        y += wrapped.length * 12;
      });

      doc.save(
        `Bao_cao_danh_gia_${modeLabel.replace(" ", "_")}_T1-T15.pdf`
      );
    }

    // ==== QUIZ T·ª™ H·ªòI THO·∫†I (T·∫†O TH√äM B√ÄI LUY·ªÜN T·∫¨P) ====
    async function createQuizFromConversation() {
      const conv = getCurrentConversation();
      if (!conv.messages.length) return;

      const baseText = conv.messages
        .map(m => `${m.role === "assistant" ? "AI" : "HS"}: ${m.content}`)
        .join("\n");

      const prompt = `
T·ª´ n·ªôi dung trao ƒë·ªïi sau gi·ªØa h·ªçc sinh v√† tr·ª£ l√Ω To√°n 9, h√£y t·∫°o m·ªôt b·ªô 5 c√¢u h·ªèi tr·∫Øc nghi·ªám luy·ªán t·∫≠p (quiz) ph√π h·ª£p:

${baseText}

Y√äU C·∫¶U:
- M·ªói c√¢u h·ªèi c√≥ 4 l·ª±a ch·ªçn A, B, C, D.
- Ch·ªâ c√≥ 1 ƒë√°p √°n ƒë√∫ng m·ªói c√¢u.
- N·ªôi dung b√°m s√°t ki·∫øn th·ª©c ƒë√£ xu·∫•t hi·ªán trong ƒëo·∫°n h·ªôi tho·∫°i (kh√¥ng b·ªãa sang ch·ªß ƒë·ªÅ kh√°c).
- Tr√¨nh b√†y theo d·∫°ng:

C√¢u 1: ...
A. ...
B. ...
C. ...
D. ...
ƒê√°p √°n: ...

C√¢u 2: ...
...

Ch·ªâ tr·∫£ l·ªùi n·ªôi dung quiz, kh√¥ng c·∫ßn gi·∫£i th√≠ch chi ti·∫øt.
`;

      statusLine.textContent = "AI ƒëang t·∫°o quiz luy·ªán t·∫≠p‚Ä¶";
      statusLine.classList.remove("error");

      try {
        const res = await fetch(API_BASE + "/chat/message", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            messages: [{ role: "user", content: prompt }]
          })
        });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();

        conv.messages.push({
          role: "assistant",
          content: "Quiz luy·ªán t·∫≠p d·ª±a tr√™n cu·ªôc tr√≤ chuy·ªán:\n\n" + data.reply
        });
        renderMessages();
        statusLine.textContent = "";
      } catch (err) {
        console.error(err);
        statusLine.textContent = "Kh√¥ng t·∫°o ƒë∆∞·ª£c quiz luy·ªán t·∫≠p.";
        statusLine.classList.add("error");
      }
    }

    // ====== S·ª± ki·ªán ======
    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
    sendBtn.addEventListener("click", sendMessage);
    newChatBtn.addEventListener("click", () => {
      createNewConversation();
      renderChatList();
      renderMessages();
      updateHeaderTags();
      statusLine.textContent = "";
    });

    runTestsBtn.addEventListener("click", () => openTestPanel("input"));
    btnSwitchInput.addEventListener("click", () => openTestPanel("input"));
    btnSwitchOutput.addEventListener("click", () => openTestPanel("output"));
    btnCloseTest.addEventListener("click", closeTestPanel);
    btnGradeTest.addEventListener("click", gradeCurrentTest);
    exportPdfBtn.addEventListener("click", exportPdfReport);
    exportPdfGlobalBtn.addEventListener("click", exportPdfReport);
    createQuizBtn.addEventListener("click", createQuizFromConversation);

    // Init
    createNewConversation();
    statusText.textContent = "Server: " + window.location.origin;
  </script>
</body>
</html>
