<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>K9 Math AI Assistant ‚Äì Chat</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root {
      --bg-main: #050816;
      --bg-chat: #0b1020;
      --bg-msg-user: #1f2937;
      --bg-msg-assistant: #111827;
      --accent: #10b981;
      --accent-soft: rgba(16,185,129,0.15);
      --border-subtle: #374151;
      --text-main: #e5e7eb;
      --text-soft: #9ca3af;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text-main);
      background: radial-gradient(circle at top, #1f2937 0, #020617 55%, #000 100%);
    }
    .layout {
      display: flex;
      width: 100%;
      height: 100%;
    }
    /* Sidebar */
    .sidebar {
      width: 260px;
      background: #020617;
      border-right: 1px solid #111827;
      padding: 12px 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .sidebar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 4px 6px 0;
    }
    .logo {
      font-size: 14px;
      font-weight: 600;
      color: #f9fafb;
    }
    .subtitle {
      font-size: 11px;
      color: var(--text-soft);
    }
    .new-chat-btn {
      margin-top: 8px;
      width: 100%;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #374151;
      background: linear-gradient(to right, #111827, #020617);
      color: #e5e7eb;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }
    .new-chat-btn span.icon {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: var(--accent-soft);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }
    .new-chat-btn:hover {
      border-color: var(--accent);
    }
    .chat-list {
      flex: 1;
      margin-top: 4px;
      overflow-y: auto;
      padding-right: 2px;
    }
    .chat-item {
      padding: 8px 10px;
      border-radius: 8px;
      margin-bottom: 4px;
      font-size: 13px;
      color: var(--text-soft);
      display: flex;
      flex-direction: column;
      gap: 2px;
      cursor: pointer;
    }
    .chat-item.active {
      background: linear-gradient(to right, rgba(16,185,129,0.18), rgba(15,23,42,0.9));
      color: #f9fafb;
    }
    .chat-item-title {
      font-weight: 500;
    }
    .chat-item-sub {
      font-size: 11px;
    }
    .sidebar-footer {
      padding: 8px 6px;
      border-top: 1px solid #111827;
      font-size: 11px;
      color: #6b7280;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      padding: 2px 7px;
      font-size: 10px;
      background: rgba(31,41,55,0.9);
      margin-right: 4px;
      margin-bottom: 2px;
    }
    .badge span.dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      margin-right: 4px;
      background: var(--accent);
    }

    /* Main */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .main-header {
      padding: 10px 16px;
      border-bottom: 1px solid #111827;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(15,23,42,0.9);
      backdrop-filter: blur(10px);
    }
    .main-header-title {
      font-size: 13px;
      font-weight: 500;
      display: flex;
      flex-direction: column;
    }
    .main-header-title span.sub {
      font-size: 11px;
      color: var(--text-soft);
    }
    .tag-list {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      justify-content: flex-end;
      max-width: 50%;
    }
    .tag-chip {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(16,185,129,0.15);
      color: #a7f3d0;
      border: 1px solid rgba(16,185,129,0.35);
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px 18px 8px;
      background: radial-gradient(circle at top, #111827 0, #020617 45%, #000 100%);
    }
    .message-row {
      margin-bottom: 12px;
      display: flex;
    }
    .message-row.assistant { justify-content: flex-start; }
    .message-row.user { justify-content: flex-end; }

    .message-bubble {
      max-width: 70%;
      padding: 10px 12px;
      border-radius: 16px;
      font-size: 14px;
      line-height: 1.45;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .assistant .message-bubble {
      background: var(--bg-msg-assistant);
      border: 1px solid #1f2937;
    }
    .user .message-bubble {
      background: var(--bg-msg-user);
      border: 1px solid #374151;
    }
    .message-meta {
      font-size: 10px;
      color: var(--text-soft);
      margin-bottom: 2px;
      padding: 0 4px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .avatar {
      width: 20px;
      height: 20px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-right: 6px;
      font-size: 12px;
    }
    .avatar.assistant {
      background: rgba(16,185,129,0.15);
      color: #6ee7b7;
    }
    .avatar.user {
      background: rgba(59,130,246,0.15);
      color: #bfdbfe;
    }

    .input-bar {
      padding: 10px 16px 14px;
      border-top: 1px solid #111827;
      background: radial-gradient(circle at top, #020617 0, #000 100%);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .input-top {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: var(--text-soft);
    }
    .input-row {
      display: flex;
      align-items: flex-end;
      gap: 8px;
    }
    .input-box-wrap {
      flex: 1;
      position: relative;
    }
    .input-box {
      width: 100%;
      padding: 10px 40px 10px 12px;
      border-radius: 999px;
      border: 1px solid #374151;
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      font-size: 14px;
      resize: none;
      max-height: 100px;
      min-height: 40px;
      outline: none;
    }
    .input-box::placeholder {
      color: #6b7280;
    }
    .input-actions-right {
      position: absolute;
      right: 6px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .icon-btn {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      border: none;
      background: transparent;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #9ca3af;
      font-size: 14px;
    }
    .icon-btn:hover {
      background: rgba(31,41,55,0.9);
      color: #e5e7eb;
    }
    .send-btn {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      border: none;
      background: var(--accent);
      color: #022c22;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 16px;
    }
    .send-btn:disabled {
      opacity: 0.4;
      cursor: default;
    }
    .status-line {
      font-size: 11px;
      color: var(--text-soft);
      min-height: 14px;
    }
    .status-line.error {
      color: #fca5a5;
    }

    #file-input {
      display: none;
    }

    @media (max-width: 800px) {
      .sidebar {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div class="layout">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div>
          <div class="logo">K9 Math AI</div>
          <div class="subtitle">Tr·ª£ l√Ω To√°n 9 ‚Äì AI for Good</div>
        </div>
      </div>
      <button class="new-chat-btn" id="btn-new-chat">
        <span class="icon">+</span>
        <span>Cu·ªôc tr√≤ chuy·ªán m·ªõi</span>
      </button>

      <div class="chat-list" id="chat-list"></div>

      <div class="sidebar-footer">
        <div>Chu·∫©n ƒë·∫ßu ra (T1‚ÄìT15)</div>
        <div style="margin-top:4px;">
          <div class="badge"><span class="dot"></span>T1 ‚Äì Ph∆∞∆°ng tr√¨nh</div>
          <div class="badge"><span class="dot"></span>T2 ‚Äì Ph·∫ßn trƒÉm</div>
          <div class="badge"><span class="dot"></span>T3 ‚Äì G√≥c &amp; tam gi√°c</div>
          <!-- B·∫°n b·ªï sung th√™m T4..T15 cho ƒë√∫ng chu·∫©n th·∫≠t -->
        </div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <header class="main-header">
        <div class="main-header-title">
          <span>Chat v·ªõi Tr·ª£ l√Ω To√°n AI</span>
          <span class="sub">ƒê·∫∑t c√¢u h·ªèi, t·∫£i b√†i t·∫≠p, nh·ªù AI ph√¢n t√≠ch &amp; ph√¢n lo·∫°i theo chu·∫©n T1‚ÄìT15.</span>
        </div>
        <div class="tag-list" id="header-tags">
          <!-- Dynamic tags -->
        </div>
      </header>

      <section class="messages" id="messages"></section>

      <section class="input-bar">
        <div class="input-top">
          <span>Tip: B·∫°n c√≥ th·ªÉ t·∫£i file PDF/TXT b√†i t·∫≠p, h·ªá th·ªëng s·∫Ω ƒë·ªçc &amp; ph√¢n t√≠ch t·ª± ƒë·ªông.</span>
          <span id="status-text"></span>
        </div>
        <div class="input-row">
          <div class="input-box-wrap">
            <textarea id="chat-input" class="input-box" rows="1" placeholder="ƒê·∫∑t c√¢u h·ªèi To√°n 9 ho·∫∑c d√°n ƒë·ªÅ b√†i ·ªü ƒë√¢y..."></textarea>
            <div class="input-actions-right">
              <button class="icon-btn" id="btn-upload" title="T·∫£i file b√†i t·∫≠p">
                üìé
              </button>
            </div>
          </div>
          <button class="send-btn" id="btn-send" title="G·ª≠i">
            ‚û§
          </button>
          <input type="file" id="file-input" accept=".txt,.pdf,.md,.json">
        </div>
        <div class="status-line" id="status-line"></div>
      </section>
    </main>
  </div>

  <script>
    // ======= C·∫§U H√åNH BACKEND =======
    // Backend c√πng domain (FastAPI serve index.html):
    const BASE_URL = window.location.origin;
    // N·∫øu backend ·ªü host kh√°c, s·ª≠a th√†nh:
    // const BASE_URL = "https://ten-service-cua-ban.onrender.com";

    // ======= STATE FRONTEND =======
    let conversations = {};
    let currentId = null;
    let chatCounter = 1;

    const chatListEl = document.getElementById("chat-list");
    const messagesEl = document.getElementById("messages");
    const headerTagsEl = document.getElementById("header-tags");
    const inputEl = document.getElementById("chat-input");
    const sendBtn = document.getElementById("btn-send");
    const statusLine = document.getElementById("status-line");
    const fileInput = document.getElementById("file-input");
    const uploadBtn = document.getElementById("btn-upload");
    const newChatBtn = document.getElementById("btn-new-chat");
    const statusText = document.getElementById("status-text");

    function createNewConversation() {
      const id = "chat-" + Date.now();
      conversations[id] = {
        id,
        title: "Cu·ªôc tr√≤ chuy·ªán " + chatCounter++,
        messages: [],
        standards: []
      };
      currentId = id;
      renderChatList();
      renderMessages();
      updateHeaderTags();
      inputEl.focus();
    }

    function getCurrentConversation() {
      if (!currentId || !conversations[currentId]) {
        createNewConversation();
      }
      return conversations[currentId];
    }

    function renderChatList() {
      chatListEl.innerHTML = "";
      Object.values(conversations).forEach(conv => {
        const div = document.createElement("div");
        div.className = "chat-item" + (conv.id === currentId ? " active" : "");
        div.onclick = () => {
          currentId = conv.id;
          renderChatList();
          renderMessages();
          updateHeaderTags();
        };
        const title = document.createElement("div");
        title.className = "chat-item-title";
        title.textContent = conv.title;
        const sub = document.createElement("div");
        sub.className = "chat-item-sub";
        if (conv.messages.length) {
          sub.textContent = conv.messages[0].content.slice(0, 32) + (conv.messages[0].content.length > 32 ? "‚Ä¶" : "");
        } else {
          sub.textContent = "Ch∆∞a c√≥ n·ªôi dung";
        }
        div.appendChild(title);
        div.appendChild(sub);
        chatListEl.appendChild(div);
      });
    }

    function renderMessages() {
      const conv = getCurrentConversation();
      messagesEl.innerHTML = "";
      if (!conv.messages.length) {
        const intro = document.createElement("div");
        intro.style.color = "#9ca3af";
        intro.style.fontSize = "13px";
        intro.style.maxWidth = "480px";
        intro.style.margin = "40px auto 0";
        intro.style.textAlign = "center";
        intro.innerHTML = "Ch√†o b·∫°n üëã<br>H√£y ƒë·∫∑t c√¢u h·ªèi To√°n 9, t·∫£i file b√†i t·∫≠p, ho·∫∑c nh·ªù m√¨nh ph√¢n t√≠ch l·ªói sai theo chu·∫©n T1‚ÄìT15.";
        messagesEl.appendChild(intro);
        return;
      }
      conv.messages.forEach(msg => {
        const row = document.createElement("div");
        row.className = "message-row " + msg.role;

        const wrapper = document.createElement("div");
        const meta = document.createElement("div");
        meta.className = "message-meta";

        const avatar = document.createElement("span");
        avatar.className = "avatar " + msg.role;
        avatar.textContent = msg.role === "assistant" ? "AI" : "You";

        const metaText = document.createElement("span");
        metaText.textContent = msg.role === "assistant" ? "Tr·ª£ l√Ω To√°n AI" : "B·∫°n";

        meta.appendChild(avatar);
        meta.appendChild(metaText);

        const bubble = document.createElement("div");
        bubble.className = "message-bubble";
        bubble.textContent = msg.content;

        wrapper.appendChild(meta);
        wrapper.appendChild(bubble);
        row.appendChild(wrapper);
        messagesEl.appendChild(row);
      });

      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function updateHeaderTags() {
      const conv = getCurrentConversation();
      headerTagsEl.innerHTML = "";
      if (!conv.standards || !conv.standards.length) return;
      conv.standards.forEach(code => {
        const div = document.createElement("div");
        div.className = "tag-chip";
        div.textContent = code;
        headerTagsEl.appendChild(div);
      });
    }

    async function sendMessage() {
      const text = inputEl.value.trim();
      if (!text) return;
      const conv = getCurrentConversation();

      conv.messages.push({ role: "user", content: text });
      inputEl.value = "";
      renderMessages();
      statusLine.textContent = "ƒêang suy nghƒ©‚Ä¶";
      statusLine.classList.remove("error");
      sendBtn.disabled = true;

      try {
        const payload = {
          messages: conv.messages.map(m => ({ role: m.role, content: m.content }))
        };
        const res = await fetch(BASE_URL + "/chat/message", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        conv.messages.push({ role: "assistant", content: data.reply });
        conv.standards = data.standards || [];
        renderMessages();
        updateHeaderTags();
        renderChatList();
        statusLine.textContent = "";
      } catch (err) {
        console.error(err);
        statusLine.textContent = "Kh√¥ng g·ªçi ƒë∆∞·ª£c API /chat/message. Ki·ªÉm tra server ho·∫∑c BASE_URL.";
        statusLine.classList.add("error");
      } finally {
        sendBtn.disabled = false;
      }
    }

    // G·ª≠i l·ªãch s·ª≠ h·ªôi tho·∫°i hi·ªán t·∫°i (kh√¥ng ph·ª• thu·ªôc √¥ input)
    async function sendHistoryOnly() {
      const conv = getCurrentConversation();
      if (!conv.messages.length) return;
      statusLine.textContent = "ƒêang ph√¢n t√≠ch‚Ä¶";
      statusLine.classList.remove("error");
      sendBtn.disabled = true;

      try {
        const payload = {
          messages: conv.messages.map(m => ({ role: m.role, content: m.content }))
        };
        const res = await fetch(BASE_URL + "/chat/message", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        conv.messages.push({ role: "assistant", content: data.reply });
        conv.standards = data.standards || [];
        renderMessages();
        updateHeaderTags();
        renderChatList();
        statusLine.textContent = "";
      } catch (err) {
        console.error(err);
        statusLine.textContent = "Kh√¥ng g·ªçi ƒë∆∞·ª£c API /chat/message. Ki·ªÉm tra server ho·∫∑c BASE_URL.";
        statusLine.classList.add("error");
      } finally {
        sendBtn.disabled = false;
      }
    }

    // Upload file ‚Üí g·ªçi /file/parse ‚Üí th√™m message user ‚Üí t·ª± ƒë·ªông g·ªçi AI
    uploadBtn.addEventListener("click", () => fileInput.click());
    fileInput.addEventListener("change", async () => {
      const file = fileInput.files[0];
      if (!file) return;

      const conv = getCurrentConversation();
      statusLine.textContent = "ƒêang ƒë·ªçc file " + file.name + "‚Ä¶";
      statusLine.classList.remove("error");

      const formData = new FormData();
      formData.append("file", file);

      try {
        const res = await fetch(BASE_URL + "/file/parse", {
          method: "POST",
          body: formData
        });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        const snippet = data.content.length > 600 ? data.content.slice(0, 600) + "\n[...ƒë√£ c·∫Øt b·ªõt...]" : data.content;
        const text = `N·ªôi dung tr√≠ch t·ª´ file "${data.filename}":\n\n` + snippet;

        conv.messages.push({ role: "user", content: text });
        renderMessages();

        // Auto g·ªçi AI lu√¥n
        await sendHistoryOnly();
      } catch (err) {
        console.error(err);
        statusLine.textContent = "Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c file. Ki·ªÉm tra /file/parse.";
        statusLine.classList.add("error");
      } finally {
        fileInput.value = "";
      }
    });

    // Enter ƒë·ªÉ g·ª≠i
    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
    sendBtn.addEventListener("click", sendMessage);
    newChatBtn.addEventListener("click", () => {
      createNewConversation();
      renderChatList();
      renderMessages();
      updateHeaderTags();
      statusLine.textContent = "";
    });

    // Init
    createNewConversation();
    statusText.textContent = "Server: " + BASE_URL;
  </script>
</body>
</html>
