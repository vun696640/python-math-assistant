<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>K9 Math AI Assistant ‚Äì Chat</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root {
      --bg-main: #050816;
      --bg-chat: #0b1020;
      --bg-msg-user: #1f2937;
      --bg-msg-assistant: #111827;
      --accent: #10b981;
      --accent-soft: rgba(16,185,129,0.15);
      --border-subtle: #374151;
      --text-main: #e5e7eb;
      --text-soft: #9ca3af;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text-main);
      background: radial-gradient(circle at top, #1f2937 0, #020617 55%, #000 100%);
    }
    .layout {
      display: flex;
      width: 100%;
      height: 100%;
    }
    /* Sidebar */
    .sidebar {
      width: 260px;
      background: #020617;
      border-right: 1px solid #111827;
      padding: 12px 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .sidebar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 4px 6px 0;
    }
    .logo {
      font-size: 14px;
      font-weight: 600;
      color: #f9fafb;
    }
    .subtitle {
      font-size: 11px;
      color: var(--text-soft);
    }
    .new-chat-btn {
      margin-top: 8px;
      width: 100%;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #374151;
      background: linear-gradient(to right, #111827, #020617);
      color: #e5e7eb;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }
    .new-chat-btn span.icon {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: var(--accent-soft);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }
    .new-chat-btn:hover {
      border-color: var(--accent);
    }
    .chat-list {
      flex: 1;
      margin-top: 4px;
      overflow-y: auto;
      padding-right: 2px;
    }
    .chat-item {
      padding: 8px 10px;
      border-radius: 8px;
      margin-bottom: 4px;
      font-size: 13px;
      color: var(--text-soft);
      display: flex;
      flex-direction: column;
      gap: 2px;
      cursor: pointer;
    }
    .chat-item.active {
      background: linear-gradient(to right, rgba(16,185,129,0.18), rgba(15,23,42,0.9));
      color: #f9fafb;
    }
    .chat-item-title {
      font-weight: 500;
    }
    .chat-item-sub {
      font-size: 11px;
    }
    .sidebar-footer {
      padding: 8px 6px;
      border-top: 1px solid #111827;
      font-size: 11px;
      color: #6b7280;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      padding: 2px 7px;
      font-size: 10px;
      background: rgba(31,41,55,0.9);
      margin-right: 4px;
      margin-bottom: 2px;
    }
    .badge span.dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      margin-right: 4px;
      background: var(--accent);
    }

    /* Main */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .main-header {
      padding: 10px 16px;
      border-bottom: 1px solid #111827;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(15,23,42,0.9);
      backdrop-filter: blur(10px);
      gap: 8px;
    }
    .main-header-title {
      font-size: 13px;
      font-weight: 500;
      display: flex;
      flex-direction: column;
    }
    .main-header-title span.sub {
      font-size: 11px;
      color: var(--text-soft);
    }
    .header-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
      max-width: 55%;
    }
    .header-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    .header-btn {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #374151;
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .header-btn span.icon {
      font-size: 12px;
    }
    .header-btn:hover {
      border-color: var(--accent);
    }
    .header-btn:disabled {
      opacity: 0.5;
      cursor: default;
    }
    .tag-list {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      justify-content: flex-end;
    }
    .tag-chip {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(16,185,129,0.15);
      color: #a7f3d0;
      border: 1px solid rgba(16,185,129,0.35);
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px 18px 8px;
      background: radial-gradient(circle at top, #111827 0, #020617 45%, #000 100%);
    }
    .message-row {
      margin-bottom: 12px;
      display: flex;
    }
    .message-row.assistant { justify-content: flex-start; }
    .message-row.user { justify-content: flex-end; }

    .message-bubble {
      max-width: 70%;
      padding: 10px 12px;
      border-radius: 16px;
      font-size: 14px;
      line-height: 1.45;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .assistant .message-bubble {
      background: var(--bg-msg-assistant);
      border: 1px solid #1f2937;
    }
    .user .message-bubble {
      background: var(--bg-msg-user);
      border: 1px solid #374151;
    }
    .message-meta {
      font-size: 10px;
      color: var(--text-soft);
      margin-bottom: 2px;
      padding: 0 4px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .avatar {
      width: 20px;
      height: 20px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-right: 6px;
      font-size: 12px;
    }
    .avatar.assistant {
      background: rgba(16,185,129,0.15);
      color: #6ee7b7;
    }
    .avatar.user {
      background: rgba(59,130,246,0.15);
      color: #bfdbfe;
    }

    .input-bar {
      padding: 10px 16px 14px;
      border-top: 1px solid #111827;
      background: radial-gradient(circle at top, #020617 0, #000 100%);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .input-top {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: var(--text-soft);
      gap: 8px;
      flex-wrap: wrap;
    }
    .input-row {
      display: flex;
      align-items: flex-end;
      gap: 8px;
    }
    .input-box-wrap {
      flex: 1;
      position: relative;
    }
    .input-box {
      width: 100%;
      padding: 10px 40px 10px 12px;
      border-radius: 999px;
      border: 1px solid #374151;
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      font-size: 14px;
      resize: none;
      max-height: 100px;
      min-height: 40px;
      outline: none;
    }
    .input-box::placeholder {
      color: #6b7280;
    }
    .input-actions-right {
      position: absolute;
      right: 6px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .icon-btn {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      border: none;
      background: transparent;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #9ca3af;
      font-size: 14px;
    }
    .icon-btn:hover {
      background: rgba(31,41,55,0.9);
      color: #e5e7eb;
    }
    .send-btn {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      border: none;
      background: var(--accent);
      color: #022c22;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 16px;
    }
    .send-btn:disabled {
      opacity: 0.4;
      cursor: default;
    }
    .status-line {
      font-size: 11px;
      color: var(--text-soft);
      min-height: 14px;
    }
    .status-line.error {
      color: #fca5a5;
    }

    #file-input {
      display: none;
    }

    /* Test panel overlay */
    .test-panel {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.65);
      z-index: 40;
      font-size: 12px;
    }
    .test-panel-inner {
      width: min(960px, 95vw);
      max-height: 85vh;
      background: #020617;
      border-radius: 16px;
      border: 1px solid #111827;
      padding: 12px 16px 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .test-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      gap: 8px;
    }
    .test-panel-title-group {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .test-summary {
      font-size: 11px;
      color: var(--text-soft);
    }
    .test-panel-switch {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .test-body {
      border: 1px solid #111827;
      border-radius: 10px;
      padding: 10px;
      background: #020617;
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 55vh;
      overflow-y: auto;
    }
    .test-progress {
      font-size: 11px;
      color: #9ca3af;
    }
    .test-question {
      font-size: 13px;
      font-weight: 500;
    }
    .test-standards {
      font-size: 11px;
      color: #9ca3af;
    }
    .test-options label {
      display: block;
      margin-bottom: 4px;
      cursor: pointer;
    }
    .test-options input[type="radio"] {
      margin-right: 6px;
    }
    .test-explain-block label {
      font-size: 11px;
      color: #9ca3af;
      display: block;
      margin-bottom: 4px;
    }
    .test-explain-block textarea {
      width: 100%;
      min-height: 80px;
      max-height: 160px;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 12px;
      resize: vertical;
    }
    .test-feedback {
      font-size: 11px;
      color: #e5e7eb;
      min-height: 16px;
    }

    .test-panel-footer {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      margin-top: 6px;
      flex-wrap: wrap;
    }

    @media (max-width: 800px) {
      .sidebar {
        display: none;
      }
      .header-right {
        max-width: 60%;
      }
    }
  </style>

  <!-- jsPDF d√πng ƒë·ªÉ xu·∫•t PDF ‚Äì b·∫£n UMD, d√πng window.jspdf.jsPDF -->
  <script src="/static/js/jspdf.umd.min.js"></script>

  <!-- MathJax -->
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']]
      },
      svg: { fontCache: 'global' }
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" async></script>
</head>
<body>
  <div class="layout">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div>
          <div class="logo">K9 Math AI</div>
          <div class="subtitle">Tr·ª£ l√Ω To√°n 9 ‚Äì AI for Good</div>
        </div>
      </div>
      <button class="new-chat-btn" id="btn-new-chat">
        <span class="icon">+</span>
        <span>Cu·ªôc tr√≤ chuy·ªán m·ªõi</span>
      </button>

      <div class="chat-list" id="chat-list"></div>

      <div class="sidebar-footer">
        <div>Chu·∫©n ƒë·∫ßu ra (T1‚ÄìT15)</div>
        <div style="margin-top:4px;">
          <div class="badge"><span class="dot"></span>T1 ‚Äì S·ªë &amp; l≈©y th·ª´a</div>
          <div class="badge"><span class="dot"></span>T2 ‚Äì T·ªâ l·ªá &amp; ph·∫ßn trƒÉm</div>
          <div class="badge"><span class="dot"></span>T3 ‚Äì G√≥c &amp; tam gi√°c</div>
          <!-- C√≥ th·ªÉ b·ªï sung th√™m T4..T15 sau -->
        </div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <header class="main-header">
        <div class="main-header-title">
          <span>Chat v·ªõi Tr·ª£ l√Ω To√°n AI</span>
          <span class="sub">
            ƒê·∫∑t c√¢u h·ªèi, t·∫£i b√†i t·∫≠p, nh·ªù AI ph√¢n t√≠ch &amp; ph√¢n lo·∫°i theo chu·∫©n T1‚ÄìT15.
          </span>
        </div>
        <div class="header-right">
          <div class="header-actions">
            <button class="header-btn" id="btn-run-tests">
              <span class="icon">üß™</span>
              <span>L√†m b√†i ki·ªÉm tra ƒë·∫ßu v√†o / ƒë·∫ßu ra</span>
            </button>

            <button class="header-btn" id="btn-create-quiz">
              <span class="icon">‚ùì</span>
              <span>Quiz luy·ªán t·∫≠p</span>
            </button>

            <button class="header-btn" id="btn-export-pdf-global" disabled>
              <span class="icon">üìÑ</span>
              <span>Xu·∫•t PDF b√°o c√°o</span>
            </button>
          </div>
          <div class="tag-list" id="header-tags">
            <!-- Dynamic tags -->
          </div>
        </div>
      </header>

      <section class="messages" id="messages"></section>

      <!-- TEST PANEL OVERLAY -->
      <section class="test-panel" id="test-panel">
        <div class="test-panel-inner">
          <div class="test-panel-header">
            <div class="test-panel-title-group">
              <div class="test-panel-header-title" id="test-panel-title">
                B√†i ki·ªÉm tra ƒë·∫ßu v√†o T1‚ÄìT15
              </div>
              <div class="test-summary" id="test-summary"></div>
            </div>
            <div class="test-panel-switch">
              <button class="header-btn" id="btn-switch-input">ƒê·∫ßu v√†o</button>
              <button class="header-btn" id="btn-switch-output">ƒê·∫ßu ra</button>
              <button class="header-btn" id="btn-close-test">‚úï</button>
            </div>
          </div>

          <div class="test-body">
            <div class="test-progress" id="test-progress"></div>
            <div class="test-question" id="test-question"></div>
            <div class="test-standards" id="test-standards"></div>
            <div class="test-options" id="test-options"></div>
            <div class="test-explain-block">
              <label for="test-explanation">Tr√¨nh b√†y l·ªùi gi·∫£i / c√°ch nghƒ© c·ªßa b·∫°n:</label>
              <textarea id="test-explanation"></textarea>
            </div>
            <div class="test-feedback" id="test-feedback"></div>
          </div>

          <div class="test-panel-footer">
            <div style="display:flex; gap:6px; flex-wrap:wrap;">
              <button class="header-btn" id="btn-prev-question">
                ‚óÄ Tr∆∞·ªõc
              </button>
              <button class="header-btn" id="btn-next-question">
                Ti·∫øp ‚ñ∂
              </button>
            </div>
            <div style="display:flex; gap:6px; flex-wrap:wrap;">
              <button class="header-btn" id="btn-grade-test">
                <span class="icon">‚úî</span>
                <span>Ch·∫•m b√†i &amp; g·ª£i √Ω k·∫ø ho·∫°ch</span>
              </button>
              <button class="header-btn" id="btn-export-pdf" disabled>
                <span class="icon">üìÑ</span>
                <span>Xu·∫•t PDF b√°o c√°o</span>
              </button>
            </div>
          </div>
        </div>
      </section>

      <section class="input-bar">
        <div class="input-top">
          <span>Tip: B·∫°n c√≥ th·ªÉ t·∫£i file PDF/TXT b√†i t·∫≠p, h·ªá th·ªëng s·∫Ω ƒë·ªçc &amp; ph√¢n t√≠ch t·ª± ƒë·ªông.</span>
          <span id="status-text"></span>
        </div>
        <div class="input-row">
          <div class="input-box-wrap">
            <textarea id="chat-input" class="input-box" rows="1"
                      placeholder="ƒê·∫∑t c√¢u h·ªèi To√°n 9 ho·∫∑c d√°n ƒë·ªÅ b√†i ·ªü ƒë√¢y..."></textarea>
            <div class="input-actions-right">
              <button class="icon-btn" id="btn-upload" title="T·∫£i file b√†i t·∫≠p">
                üìé
              </button>
            </div>
          </div>
          <button class="send-btn" id="btn-send" title="G·ª≠i">
            ‚û§
          </button>
          <input type="file" id="file-input" accept=".txt,.pdf,.md,.json">
        </div>
        <div class="status-line" id="status-line"></div>
      </section>
    </main>
  </div>

  <script>
    const API_BASE = "";

    const STANDARD_LABELS = {
      T1: "So & luy thua",
      T2: "Ti le & phan tram",
      T3: "Goc & tam giac",
      T4: "Can bac hai",
      T5: "Phuong trinh bac nhat",
      T6: "He phuong trinh",
      T7: "Bat phuong trinh",
      T8: "Ham so & do thi",
      T9: "Tam giac vuong & dinh ly Pytago",
      T10: "Duong tron",
      T11: "Tiep tuyen",
      T12: "Hinh tru, non, cau",
      T13: "Thong ke",
      T14: "Xac suat",
      T15: "Bai toan thuc te"
    };

    // G·ª£i √Ω t√†i li·ªáu (hardcode, gi·∫£ l·∫≠p ‚Äút√¨m ki·∫øm tham kh·∫£o‚Äù)
    const STANDARD_RESOURCES = {
      T1: ["SGK Toan 9 tap 1, Bai luy thua", "Tim video 'Luy thua lop 9' tren YouTube"],
      T2: ["SGK Toan 9 tap 1, Bai ti le phan tram", "Tim video 'Bai tap phan tram lop 9'"],
      T3: ["SGK Toan 9 tap 1, Chuong goc & tam giac", "Tim video 'Chung minh tam giac lop 9'"],
      T4: ["SGK Toan 9 tap 1, Bai can bac hai", "Tim video 'Can bac hai lop 9'"],
      T5: ["SGK Toan 9 tap 2, Bai phuong trinh bac nhat", "Tim video 'Phuong trinh bac nhat lop 9'"],
      T6: ["SGK Toan 9 tap 2, Bai he phuong trinh", "Tim video 'He phuong trinh lop 9'"],
      T7: ["SGK Toan 9 tap 2, Bai bat phuong trinh", "Tim video 'Bat phuong trinh lop 9'"],
      T8: ["SGK Toan 9 tap 2, Bai ham so & do thi", "Tim video 'Ham so bac nhat lop 9'"],
      T9: ["SGK Toan 9 tap 1, Bai dinh ly Pytago", "Tim video 'Dinh ly Pytago lop 9'"],
      T12:["SGK Toan 9 tap 2, Bai hinh tru-non-cau", "Tim video 'The tich hinh tru non cau'"],
      T15:["SGK Toan 9, cac bai tap thuc te", "Tim video 'Bai toan thuc te lop 9'"]
    };

    // === STATE CHAT ===
    let conversations = {};
    let currentId = null;
    let chatCounter = 1;

    const chatListEl = document.getElementById("chat-list");
    const messagesEl = document.getElementById("messages");
    const headerTagsEl = document.getElementById("header-tags");
    const inputEl = document.getElementById("chat-input");
    const sendBtn = document.getElementById("btn-send");
    const statusLine = document.getElementById("status-line");
    const fileInput = document.getElementById("file-input");
    const uploadBtn = document.getElementById("btn-upload");
    const newChatBtn = document.getElementById("btn-new-chat");
    const statusText = document.getElementById("status-text");

    const runTestsBtn = document.getElementById("btn-run-tests");
    const createQuizBtn = document.getElementById("btn-create-quiz");
    const exportPdfGlobalBtn = document.getElementById("btn-export-pdf-global");

    // === STATE TEST/QUIZ ===
    const testPanel = document.getElementById("test-panel");
    const testPanelTitle = document.getElementById("test-panel-title");
    const testSummary = document.getElementById("test-summary");
    const testProgress = document.getElementById("test-progress");
    const testQuestionEl = document.getElementById("test-question");
    const testStandardsEl = document.getElementById("test-standards");
    const testOptionsEl = document.getElementById("test-options");
    const testExplainEl = document.getElementById("test-explanation");
    const testFeedbackEl = document.getElementById("test-feedback");

    const btnSwitchInput = document.getElementById("btn-switch-input");
    const btnSwitchOutput = document.getElementById("btn-switch-output");
    const btnCloseTest = document.getElementById("btn-close-test");
    const btnPrevQuestion = document.getElementById("btn-prev-question");
    const btnNextQuestion = document.getElementById("btn-next-question");
    const btnGradeTest = document.getElementById("btn-grade-test");
    const exportPdfBtn = document.getElementById("btn-export-pdf");

    let testMode = "input"; // input | output | quiz
    let testQuestions = [];
    let testSession = null; // {mode, questions, answers, currentIndex, graded, perStandard, correctCount, total, explanationStats}
    let lastTestResults = null; // cho PDF

    // ===== CHAT =====
    function createNewConversation() {
      const id = "chat-" + Date.now();
      conversations[id] = {
        id,
        title: "Cuoc tro chuyen " + chatCounter++,
        messages: [],
        standards: []
      };
      currentId = id;
      renderChatList();
      renderMessages();
      updateHeaderTags();
      inputEl.focus();
    }

    function getCurrentConversation() {
      if (!currentId || !conversations[currentId]) {
        createNewConversation();
      }
      return conversations[currentId];
    }

    function renderChatList() {
      chatListEl.innerHTML = "";
      Object.values(conversations).forEach(conv => {
        const div = document.createElement("div");
        div.className = "chat-item" + (conv.id === currentId ? " active" : "");
        div.onclick = () => {
          currentId = conv.id;
          renderChatList();
          renderMessages();
          updateHeaderTags();
        };
        const title = document.createElement("div");
        title.className = "chat-item-title";
        title.textContent = conv.title;
        const sub = document.createElement("div");
        sub.className = "chat-item-sub";
        if (conv.messages.length) {
          const first = conv.messages[0].content || "";
          sub.textContent = first.slice(0, 32) + (first.length > 32 ? "‚Ä¶" : "");
        } else {
          sub.textContent = "Chua co noi dung";
        }
        div.appendChild(title);
        div.appendChild(sub);
        chatListEl.appendChild(div);
      });
    }

    function renderMessages() {
      const conv = getCurrentConversation();
      messagesEl.innerHTML = "";
      if (!conv.messages.length) {
        const intro = document.createElement("div");
        intro.style.color = "#9ca3af";
        intro.style.fontSize = "13px";
        intro.style.maxWidth = "480px";
        intro.style.margin = "40px auto 0";
        intro.style.textAlign = "center";
        intro.innerHTML = "Chao ban üëã<br>Hay dat cau hoi Toan 9, tai file bai tap, hoac nho minh phan tich loi sai theo chuan T1‚ÄìT15.";
        messagesEl.appendChild(intro);
      } else {
        conv.messages.forEach(msg => {
          const row = document.createElement("div");
          row.className = "message-row " + msg.role;

          const wrapper = document.createElement("div");
          const meta = document.createElement("div");
          meta.className = "message-meta";

          const avatar = document.createElement("span");
          avatar.className = "avatar " + msg.role;
          avatar.textContent = msg.role === "assistant" ? "AI" : "You";

          const metaText = document.createElement("span");
          metaText.textContent = msg.role === "assistant" ? "Tro ly Toan AI" : "Ban";

          meta.appendChild(avatar);
          meta.appendChild(metaText);

          const bubble = document.createElement("div");
          bubble.className = "message-bubble";
          bubble.textContent = msg.content;

          wrapper.appendChild(meta);
          wrapper.appendChild(bubble);
          row.appendChild(wrapper);
          messagesEl.appendChild(row);
        });
      }

      messagesEl.scrollTop = messagesEl.scrollHeight;

      if (window.MathJax && window.MathJax.typesetPromise) {
        window.MathJax.typesetPromise();
      }
    }

    function updateHeaderTags() {
      const conv = getCurrentConversation();
      headerTagsEl.innerHTML = "";
      if (!conv.standards || !conv.standards.length) return;
      conv.standards.forEach(code => {
        const div = document.createElement("div");
        div.className = "tag-chip";
        div.textContent = code;
        headerTagsEl.appendChild(div);
      });
    }

    async function sendMessage() {
      const text = inputEl.value.trim();
      if (!text) return;
      const conv = getCurrentConversation();

      conv.messages.push({ role: "user", content: text });
      inputEl.value = "";
      renderMessages();
      statusLine.textContent = "Dang suy nghi‚Ä¶";
      statusLine.classList.remove("error");
      sendBtn.disabled = true;

      try {
        const payload = {
          messages: conv.messages.map(m => ({ role: m.role, content: m.content }))
        };
        const res = await fetch(API_BASE + "/chat/message", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        conv.messages.push({ role: "assistant", content: data.reply });
        conv.standards = data.standards || [];
        renderMessages();
        updateHeaderTags();
        renderChatList();
        statusLine.textContent = "";
      } catch (err) {
        console.error(err);
        statusLine.textContent = "Khong goi duoc API /chat/message. Kiem tra server.";
        statusLine.classList.add("error");
      } finally {
        sendBtn.disabled = false;
      }
    }

    async function sendHistoryOnly() {
      const conv = getCurrentConversation();
      if (!conv.messages.length) return;
      statusLine.textContent = "Dang phan tich‚Ä¶";
      statusLine.classList.remove("error");
      sendBtn.disabled = true;

      try {
        const payload = {
          messages: conv.messages.map(m => ({ role: m.role, content: m.content }))
        };
        const res = await fetch(API_BASE + "/chat/message", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        conv.messages.push({ role: "assistant", content: data.reply });
        conv.standards = data.standards || [];
        renderMessages();
        updateHeaderTags();
        renderChatList();
        statusLine.textContent = "";
      } catch (err) {
        console.error(err);
        statusLine.textContent = "Khong goi duoc API /chat/message. Kiem tra server.";
        statusLine.classList.add("error");
      } finally {
        sendBtn.disabled = false;
      }
    }

    // Upload file -> parse
    uploadBtn.addEventListener("click", () => fileInput.click());
    fileInput.addEventListener("change", async () => {
      const file = fileInput.files[0];
      if (!file) return;

      const conv = getCurrentConversation();
      statusLine.textContent = "Dang doc file " + file.name + "‚Ä¶";
      statusLine.classList.remove("error");

      const formData = new FormData();
      formData.append("file", file);

      try {
        const res = await fetch(API_BASE + "/file/parse", {
          method: "POST",
          body: formData
        });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        const snippet = data.content.length > 600
          ? data.content.slice(0, 600) + "\n[...da cat bot...]"
          : data.content;
        const text = `Noi dung trich tu file "${data.filename}":\n\n` + snippet;

        conv.messages.push({ role: "user", content: text });
        renderMessages();

        await sendHistoryOnly();
      } catch (err) {
        console.error(err);
        statusLine.textContent = "Khong doc duoc file. Kiem tra /file/parse.";
        statusLine.classList.add("error");
      } finally {
        fileInput.value = "";
      }
    });

    // ===== TEST / QUIZ (trinh rieng) =====
    function openTestPanel(mode) {
      testMode = mode || "input";
      testPanel.style.display = "flex";
      testSummary.textContent = "Dang tai cau hoi‚Ä¶";
      exportPdfBtn.disabled = true;
      exportPdfGlobalBtn.disabled = true;
      testQuestions = [];
      testSession = null;
      lastTestResults = null;
      loadTestQuestions();
    }

    function closeTestPanel() {
      testPanel.style.display = "none";
    }

    async function loadTestQuestions() {
      let endpoint = "/api/input_quiz";
      if (testMode === "output" || testMode === "quiz") {
        endpoint = "/api/output_quiz";
      }

      try {
        const res = await fetch(API_BASE + endpoint);
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        testQuestions = data.questions || [];
        if (!testQuestions.length) throw new Error("Khong co cau hoi.");

        if (testMode === "quiz") {
          testPanelTitle.textContent = "Quiz luyen tap T1‚ÄìT15";
        } else if (testMode === "input") {
          testPanelTitle.textContent = "Bai kiem tra dau vao T1‚ÄìT15";
        } else {
          testPanelTitle.textContent = "Bai kiem tra dau ra T1‚ÄìT15";
        }

        testSummary.textContent = "Tra loi tung cau, chon dap an A‚ÄìD va trinh bay ngan gon cach lam.";

        testSession = {
          mode: testMode,
          questions: testQuestions,
          currentIndex: 0,
          answers: testQuestions.map(() => ({ choice: null, explanation: "", isCorrect: null })),
          graded: false,
          perStandard: {},
          correctCount: 0,
          total: testQuestions.length,
          explanationStats: null
        };

        renderCurrentTestQuestion();
      } catch (err) {
        console.error(err);
        testSummary.textContent = "Loi tai cau hoi: " + err.message;
      }
    }

    function renderCurrentTestQuestion() {
      if (!testSession) return;
      const idx = testSession.currentIndex;
      const q = testSession.questions[idx];

      testProgress.textContent = `Cau ${idx + 1} / ${testSession.questions.length}`;
      testQuestionEl.textContent = q.text;
      testStandardsEl.textContent = "Chuan lien quan: " + (q.standards || []).join(", ");

      testOptionsEl.innerHTML = "";
      const ans = testSession.answers[idx];
      (q.options || []).forEach((opt, i) => {
        const label = document.createElement("label");
        const radio = document.createElement("input");
        radio.type = "radio";
        radio.name = "test-option";
        radio.value = String(i);
        if (ans.choice === i) radio.checked = true;
        label.appendChild(radio);
        label.appendChild(document.createTextNode(
          " " + String.fromCharCode(65 + i) + ". " + opt
        ));
        testOptionsEl.appendChild(label);
      });

      testExplainEl.value = ans.explanation || "";

      if (testSession.graded && ans.isCorrect !== null) {
        const correctness = ans.isCorrect
          ? "Ket qua: Dung."
          : "Ket qua: Sai. Dap an dung la " +
            String.fromCharCode(65 + (q.correct_index ?? 0)) + ".";
        const explanationEval = evaluateExplanationText(ans.explanation || "", ans.isCorrect);
        testFeedbackEl.textContent = correctness + " " + explanationEval;
      } else {
        testFeedbackEl.textContent = "";
      }

      btnPrevQuestion.disabled = idx === 0;
      btnNextQuestion.disabled = idx === testSession.questions.length - 1;
    }

    function saveCurrentAnswer() {
      if (!testSession) return;
      const idx = testSession.currentIndex;
      const ans = testSession.answers[idx];

      const selected = document.querySelector('input[name="test-option"]:checked');
      ans.choice = selected ? parseInt(selected.value, 10) : null;
      ans.explanation = testExplainEl.value.trim();
    }

    function goToPrevQuestion() {
      if (!testSession) return;
      saveCurrentAnswer();
      if (testSession.currentIndex > 0) {
        testSession.currentIndex -= 1;
        renderCurrentTestQuestion();
      }
    }

    function goToNextQuestion() {
      if (!testSession) return;
      saveCurrentAnswer();
      if (testSession.currentIndex < testSession.questions.length - 1) {
        testSession.currentIndex += 1;
        renderCurrentTestQuestion();
      }
    }

    function evaluateExplanationText(text, isCorrect) {
      const len = (text || "").length;
      if (!text || !text.trim()) {
        return "Em gan nhu khong trinh bay loi giai; nen tap viet lai cac buoc chinh de de kiem tra loi va duoc cham diem cao hon.";
      }
      if (len < 25) {
        if (isCorrect) {
          return "Em chon dung nhung trinh bay con rat ngan, nen ghi ro it nhat 1‚Äì2 buoc tinh chinh de hinh thanh thoi quen giai bai day du.";
        } else {
          return "Em co ghi chu nhung con rat ngan; nen viet ro tung buoc tinh de de nhan ra cho sai va nho nguoi khac gop y.";
        }
      }
      if (len < 80) {
        if (isCorrect) {
          return "Cach trinh bay tam on, nhung co the them 1 buoc giai thich ly do chon cong thuc hoac cach dat an.";
        } else {
          return "Em trinh bay o muc vua phai; hay xem lai tung buoc, dac biet phep tinh va cach suy ra cong thuc de tim chinh xac hon.";
        }
      }
      if (isCorrect) {
        return "Cach trinh bay kha chi tiet, day du buoc. Neu co the, em co the rut gon mot so dong nhung van giu duoc y chinh.";
      }
      return "Em trinh bay kha chi tiet, nhung co the dang sai o mot vai buoc logic hoac phep tinh. Nen kiem tra lai dieu kien, buoc chuyen ve va cac so lieu.";
    }

    function describeStandardLevel(total, correct) {
      if (!total) return "Chua co cau hoi thuoc nhom nay trong bai kiem tra.";
      const ratio = correct / total;
      if (ratio >= 0.8) {
        return "Manh ‚Äì em lam tot phan lon cau hoi thuoc nhom chuan nay.";
      } else if (ratio >= 0.5) {
        return "Trung binh ‚Äì em nam duoc mot phan, nen luyen them de vung hon.";
      }
      return "Can cung co ‚Äì nen on lai ly thuyet va lam them bai tap minh hoa.";
    }

    function overallText(total, correct, explanationStats) {
      if (!total) {
        return "Chua co du du lieu de danh gia.";
      }
      const ratio = correct / total;
      let base;
      if (ratio >= 0.8) {
        base = "Ket qua cho thay em dang lam kha tot bai kiem tra nay. Co the bat dau luyen cac dang bai nang cao va duy tri on tap cac chu de da vung.";
      } else if (ratio >= 0.5) {
        base = "Ket qua o muc trung binh. Em da nam duoc mot phan kien thuc nhung van can luyen them mot so dang bai de chac hon.";
      } else {
        base = "Ket qua cho thay em can tap trung cung co lai cac kien thuc co ban, nen xem lai ly thuyet va lam them bai tap mau cho tung chuan.";
      }

      if (explanationStats) {
        const { blankAnswers, noExplanation, shortExplanation } = explanationStats;
        const extraParts = [];
        if (blankAnswers > 0) {
          extraParts.push(`Co ${blankAnswers} cau em de trong hoan toan (khong chon dap an va khong trinh bay). Nen thu lam ca khi chua chac chan de phat hien diem yeu.`);
        }
        if (noExplanation > 0) {
          extraParts.push(`Co ${noExplanation} cau em chi chon dap an ma khong viet loi giai. De ren thoi quen lam bai thi, em nen tap trinh bay it nhat 1‚Äì2 buoc chinh.`);
        }
        if (shortExplanation > 0) {
          extraParts.push(`Mot so cau em trinh bay rat ngan (${shortExplanation} cau). Hay co gang viet ro them mot buoc tinh hoac giai thich ly do chon cong thuc.`);
        }
        if (extraParts.length) {
          base += " " + extraParts.join(" ");
        }
      }
      return base;
    }

    function buildScheduleFromResults(perStandard, explanationStats) {
      const codes = Object.keys(STANDARD_LABELS);
      const ordered = codes.map(code => {
        const info = perStandard[code] || { total: 0, correct: 0 };
        const ratio = info.total ? info.correct / info.total : 0.6; // khong co du lieu: xem nhu trung binh
        return { code, ratio, total: info.total };
      }).sort((a, b) => a.ratio - b.ratio);

      const weak = ordered.slice(0, 5).map(x => x.code);
      const mid = ordered.slice(5, 10).map(x => x.code);
      const strong = ordered.slice(10).map(x => x.code);

      function pickOrFallback(list, idx, fallback) {
        if (idx < list.length) return list[idx];
        if (fallback < ordered.length) return ordered[fallback].code;
        return "T1";
      }

      const month1 = {
        title: "Thang 1 ‚Äì Tap trung vao cac chuan yeu nhat",
        rows: []
      };
      const month2 = {
        title: "Thang 2 ‚Äì On lai chuan yeu + trung binh",
        rows: []
      };
      const month3 = {
        title: "Thang 3 ‚Äì Cung co chuan trung binh + manh",
        rows: []
      };

      function cellText(code, levelLabel) {
        const label = STANDARD_LABELS[code] || ("Chuan " + code);
        const info = STANDARD_RESOURCES[code] || [];
        const res1 = info[0] || "SGK Toan 9";
        const res2 = info[1] || "Tim video luyen tap phu hop tren YouTube";
        return `${code} ‚Äì ${label}: ${levelLabel}. Bai tap: lam 3‚Äì5 bai tap co ban hoac van dung; co the them 1 bai toan thuc te neu co. Tai lieu: ${res1}; ${res2}.`;
      }

      // Th√°ng 1: ch·ªß y·∫øu weak
      for (let r = 0; r < 4; r++) {
        const row = [];
        row.push(cellText(pickOrFallback(weak, 0, 0), "On lai ly thuyet & cong thuc chinh")); // T2
        row.push(cellText(pickOrFallback(weak, 1, 1), "Lam 3‚Äì5 bai tap co ban"));            // T3
        row.push(cellText(pickOrFallback(weak, 2, 2), "Lam 3‚Äì5 bai tap van dung"));          // T4
        row.push(cellText(pickOrFallback(weak, 3, 3), "Lam 1 bai toan thuc te hoac tong hop")); // T5
        row.push(cellText(pickOrFallback(weak, 4, 4), "On lai ly thuyet & lam 3 bai tap mau")); // T6
        row.push(cellText(pickOrFallback(mid, 0, 5), "Lam 3‚Äì5 bai tap co ban"));              // T7
        row.push("Nghi hoac tong ket tuan: xem lai cac cau lam sai, ghi chu cac loi thuong gap va hoi Tro ly Toan AI giai chi tiet.");
        month1.rows.push(row);
      }

      // Th√°ng 2: weak + mid + them T15
      for (let r = 0; r < 4; r++) {
        const row = [];
        row.push(cellText(pickOrFallback(weak, r % weak.length, 0), "On lai ly thuyet & cong thuc chinh")); // T2
        row.push(cellText(pickOrFallback(mid, 0, 5), "Lam 3‚Äì5 bai tap co ban"));                           // T3
        row.push(cellText(pickOrFallback(mid, 1, 6), "Lam 3‚Äì5 bai tap van dung"));                         // T4
        row.push(cellText(pickOrFallback(mid, 2, 7), "Lam 1 bai tong hop hoac luyen de thi"));             // T5
        row.push(cellText(pickOrFallback(mid, 3, 8), "On lai ly thuyet & lam 3 bai tap mau"));             // T6
        row.push(cellText(pickOrFallback(["T15"], 0, 0), "Lam 2‚Äì3 bai toan thuc te gan voi cuoc song"));   // T7
        row.push("Tong ket tuan: danh dau cac chuan da tien bo va chuan van yeu; dieu chinh ke hoach neu can.");
        month2.rows.push(row);
      }

      // Th√°ng 3: mid + strong
      const combined = mid.concat(strong);
      for (let r = 0; r < 4; r++) {
        const row = [];
        row.push(cellText(pickOrFallback(combined, 0, 0), "On lai ly thuyet & cong thuc chinh")); // T2
        row.push(cellText(pickOrFallback(combined, 1, 1), "Lam 3‚Äì5 bai tap co ban"));             // T3
        row.push(cellText(pickOrFallback(combined, 2, 2), "Lam 3‚Äì5 bai tap van dung & nang cao"));// T4
        row.push(cellText(pickOrFallback(combined, 3, 3), "Lam 1 de on tap tong hop nho nhap vai de thi")); // T5
        row.push(cellText(pickOrFallback(combined, 4, 4), "On lai ly thuyet bang so do tu duy hoac flashcard")); // T6
        row.push(cellText(pickOrFallback(combined, 5, 5), "Lam 3‚Äì5 bai tap tong hop co ket hop nhieu chuan"));    // T7
        row.push("Cuoi tuan: lam lai 1 bai kiem tra tu tao (10 cau), sau do nhap vao he thong de Tro ly Toan AI phan tich loi sai.");
        month3.rows.push(row);
      }

      // Chu ky ngan (ngay 1‚Äì4) ‚Äì dung cho muc "Lich hoc tong quan"
      const cycle = [
        "Ngay 1: Chon 1‚Äì2 chuan yeu nhat, on lai ly thuyet & cong thuc. Lam 3‚Äì5 bai tap co ban.",
        "Ngay 2: Lam 3‚Äì5 bai tap van dung cho cac chuan do; neu du thoi gian lam 1 bai toan thuc te nho.",
        "Ngay 3: On lai cac cau lam sai, ghi chu ly do sai. Nho Tro ly Toan AI giai ki cac cau kho.",
        "Ngay 4: Lam 1 bai kiem tra nho (5‚Äì8 cau), tu cham & so sanh voi huong dan, dieu chinh ke hoach on tap."
      ];

      return { month1, month2, month3, cycle };
    }

    function gradeCurrentTest() {
      if (!testSession) return;
      saveCurrentAnswer();

      const { questions, answers } = testSession;
      let correct = 0;
      const perStandard = {};
      const results = [];

      const explanationStats = {
        blankAnswers: 0,
        noExplanation: 0,
        shortExplanation: 0,
        detailedExplanation: 0
      };

      questions.forEach((q, idx) => {
        const ans = answers[idx];
        const isCorrect = ans.choice === q.correct_index;
        ans.isCorrect = isCorrect;

        if (ans.choice === null && (!ans.explanation || !ans.explanation.trim())) {
          explanationStats.blankAnswers++;
        } else if (!ans.explanation || !ans.explanation.trim()) {
          explanationStats.noExplanation++;
        } else if (ans.explanation.trim().length < 40) {
          explanationStats.shortExplanation++;
        } else {
          explanationStats.detailedExplanation++;
        }

        if (isCorrect) correct++;

        (q.standards || []).forEach(code => {
          if (!perStandard[code]) perStandard[code] = { total: 0, correct: 0 };
          perStandard[code].total += 1;
          if (isCorrect) perStandard[code].correct += 1;
        });

        results.push({
          index: idx + 1,
          question: q.text,
          choice: ans.choice,
          explanation: ans.explanation,
          standards: q.standards || [],
          isCorrect
        });
      });

      testSession.graded = true;
      testSession.perStandard = perStandard;
      testSession.correctCount = correct;
      testSession.explanationStats = explanationStats;

      const modeLabel =
        testSession.mode === "input" ? "dau vao"
          : testSession.mode === "output" ? "dau ra"
          : "quiz luyen tap";

      testSummary.textContent =
        `Da cham xong bai ${modeLabel}. Hay xem lai tung cau, sau do xuat PDF de lay bao cao & ke hoach chi tiet.`;

      lastTestResults = {
        mode: testSession.mode,
        totalQuestions: questions.length,
        correct,
        perStandard,
        results,
        explanationStats
      };

      exportPdfBtn.disabled = questions.length === 0;
      exportPdfGlobalBtn.disabled = questions.length === 0;

      renderCurrentTestQuestion();

      const conv = getCurrentConversation();
      const weakStandards = Object.keys(perStandard).filter(c => {
        const info = perStandard[c];
        return info.total && info.correct / info.total < 0.8;
      });
      const summaryLine = `Tom tat bai ${modeLabel}: em lam dung ${correct}/${questions.length} cau. Cac chuan can chu y them: ${weakStandards.join(", ") || "chua ro"}.\nHe thong cung da tao ke hoach on tap 1 quy trong bao cao PDF.`;
      conv.messages.push({
        role: "assistant",
        content: summaryLine
      });
      renderMessages();
    }

    function exportPdfReport() {
      if (!lastTestResults) return;
      if (!window.jspdf || !window.jspdf.jsPDF) {
        alert("Khong tai duoc thu vien xuat PDF (jsPDF).");
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: "pt", format: "a4" });

      // Luu y: core font cua jsPDF khong ho tro dau tieng Viet day du,
      // nen file PDF se bi bo dau (khong phai loi code, ma la gioi han thu vien).
      // De dung font Unicode, can nhung TTF rieng va sua file fontconverter.
      doc.setFont("helvetica", "normal");

      const s = lastTestResults;
      let y = 40;
      const maxWidth = 500;
      const modeLabel =
        s.mode === "input" ? "dau vao"
          : s.mode === "output" ? "dau ra"
          : "quiz luyen tap";

      doc.setFontSize(14);
      doc.text(
        `Bao cao & ke hoach hoc ‚Äì Bai ${modeLabel} T1‚ÄìT15 ‚Äì K9 Math AI Assistant`,
        40,
        y
      );

      y += 20;
      doc.setFontSize(11);
      doc.text("Thoi gian: " + new Date().toLocaleString(), 40, y);

      // 1. Danh gia tong quan
      y += 24;
      doc.setFontSize(11);
      doc.text("1. Danh gia tong quan", 40, y);
      y += 14;
      doc.setFontSize(10);
      const overallLines = doc.splitTextToSize(
        overallText(s.totalQuestions, s.correct, s.explanationStats),
        maxWidth
      );
      doc.text(overallLines, 40, y);
      y += overallLines.length * 12;

      // 2. Danh gia theo tung nhom chuan
      y += 16;
      doc.setFontSize(11);
      doc.text("2. Danh gia theo tung nhom chuan", 40, y);
      y += 14;
      doc.setFontSize(10);

      const codes = Object.keys(s.perStandard || {}).sort();
      if (!codes.length) {
        doc.text("Chua co du du lieu de phan tich theo chuan.", 40, y);
        y += 14;
      } else {
        codes.forEach(code => {
          const info = s.perStandard[code];
          const line = `${code} ‚Äì ${(STANDARD_LABELS[code] || "Chuan " + code)}: ${describeStandardLevel(info.total, info.correct)}`;
          const wrapped = doc.splitTextToSize(line, maxWidth);
          if (y + wrapped.length * 12 > 770) {
            doc.addPage();
            y = 40;
          }
          doc.text(wrapped, 40, y);
          y += wrapped.length * 12;
        });
      }

      // 3. Nhan xet ve cach trinh bay & thoi quen lam bai
      y += 16;
      doc.setFontSize(11);
      doc.text("3. Nhan xet ve cach trinh bay & thoi quen lam bai", 40, y);
      y += 14;
      doc.setFontSize(10);

      const es = s.explanationStats || {};
      const expLines = [];
      expLines.push(`So cau bo trong hoan toan: ${es.blankAnswers || 0}.`);
      expLines.push(`So cau chi chon dap an, khong viet loi giai: ${es.noExplanation || 0}.`);
      expLines.push(`So cau trinh bay rat ngan: ${es.shortExplanation || 0}.`);
      expLines.push(`So cau trinh bay chi tiet hon: ${es.detailedExplanation || 0}.`);
      const expWrapped = doc.splitTextToSize(
        expLines.join(" "),
        maxWidth
      );
      if (y + expWrapped.length * 12 > 770) {
        doc.addPage();
        y = 40;
      }
      doc.text(expWrapped, 40, y);
      y += expWrapped.length * 12;

      // 4. Lich hoc tong quan theo chu ky ngan
      const scheduleAll = buildScheduleFromResults(s.perStandard || {}, s.explanationStats || {});
      y += 16;
      doc.setFontSize(11);
      doc.text("4. Lich hoc tong quan (chu ky 4 ngay)", 40, y);
      y += 14;
      doc.setFontSize(10);
      scheduleAll.cycle.forEach(line => {
        const wrapped = doc.splitTextToSize(line, maxWidth);
        if (y + wrapped.length * 12 > 770) {
          doc.addPage();
          y = 40;
        }
        doc.text(wrapped, 40, y);
        y += wrapped.length * 12;
      });

      // 5. Ke hoach chi tiet 1 quy (3 thang, dang bang)
      function drawMonthTable(monthData, monthIndex) {
        if (!monthData) return;
        if (y > 700) {
          doc.addPage();
          y = 40;
        }
        doc.setFontSize(11);
        doc.text(`5.${monthIndex} ${monthData.title}`, 40, y);
        y += 14;
        doc.setFontSize(10);
        const headers = "T2 | T3 | T4 | T5 | T6 | T7 | CN";
        doc.text(headers, 40, y);
        y += 12;

        monthData.rows.forEach((row, rIdx) => {
          if (y > 760) {
            doc.addPage();
            y = 40;
          }
          doc.text(`Tuan ${rIdx + 1}:`, 40, y);
          y += 12;
          for (let c = 0; c < row.length; c++) {
            const colLabel = ["T2", "T3", "T4", "T5", "T6", "T7", "CN"][c] || "";
            const text = `${colLabel}: ${row[c]}`;
            const wrapped = doc.splitTextToSize(text, maxWidth);
            if (y + wrapped.length * 12 > 770) {
              doc.addPage();
              y = 40;
            }
            doc.text(wrapped, 60, y);
            y += wrapped.length * 12;
          }
          y += 6;
        });
      }

      y += 16;
      drawMonthTable(scheduleAll.month1, 1);
      y += 10;
      drawMonthTable(scheduleAll.month2, 2);
      y += 10;
      drawMonthTable(scheduleAll.month3, 3);

      doc.save(`Bao_cao_${modeLabel.replace(" ", "_")}_T1-T15.pdf`);
    }

    // ===== EVT =====
    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
    sendBtn.addEventListener("click", sendMessage);

    newChatBtn.addEventListener("click", () => {
      createNewConversation();
      renderChatList();
      renderMessages();
      updateHeaderTags();
      statusLine.textContent = "";
    });

    runTestsBtn.addEventListener("click", () => openTestPanel("input"));
    createQuizBtn.addEventListener("click", () => openTestPanel("quiz"));

    btnSwitchInput.addEventListener("click", () => openTestPanel("input"));
    btnSwitchOutput.addEventListener("click", () => openTestPanel("output"));
    btnCloseTest.addEventListener("click", closeTestPanel);

    btnPrevQuestion.addEventListener("click", goToPrevQuestion);
    btnNextQuestion.addEventListener("click", goToNextQuestion);
    btnGradeTest.addEventListener("click", gradeCurrentTest);

    exportPdfBtn.addEventListener("click", exportPdfReport);
    exportPdfGlobalBtn.addEventListener("click", exportPdfReport);

    // Init
    createNewConversation();
    statusText.textContent = "Server: " + window.location.origin;
  </script>
</body>
</html>

