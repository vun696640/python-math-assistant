<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>K9 Math AI Assistant ‚Äì Chat</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <style>
    :root {
      --bg-main: #050816;
      --bg-chat: #0b1020;
      --bg-msg-user: #1f2937;
      --bg-msg-assistant: #111827;
      --accent: #10b981;
      --accent-soft: rgba(16,185,129,0.15);
      --border-subtle: #374151;
      --text-main: #e5e7eb;
      --text-soft: #9ca3af;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text-main);
      background: radial-gradient(circle at top, #1f2937 0, #020617 55%, #000 100%);
    }
    .layout {
      display: flex;
      width: 100%;
      height: 100%;
    }

    /* Sidebar (ƒë·ªÉ cho vibe x·ªãn th√¥i) */
    .sidebar {
      width: 240px;
      background: #020617;
      border-right: 1px solid #111827;
      padding: 12px 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .sidebar-header {
      padding: 4px 6px 0;
    }
    .logo {
      font-size: 14px;
      font-weight: 600;
      color: #f9fafb;
    }
    .subtitle {
      font-size: 11px;
      color: var(--text-soft);
    }
    .sidebar-footer {
      margin-top: auto;
      padding-top: 8px;
      border-top: 1px solid #111827;
      font-size: 11px;
      color: #6b7280;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      padding: 2px 7px;
      font-size: 10px;
      background: rgba(31,41,55,0.9);
      margin-right: 4px;
      margin-bottom: 2px;
    }
    .badge span.dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      margin-right: 4px;
      background: var(--accent);
    }

    /* Main */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .main-header {
      padding: 10px 16px;
      border-bottom: 1px solid #111827;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(15,23,42,0.9);
      backdrop-filter: blur(10px);
      gap: 8px;
    }
    .main-header-title {
      font-size: 13px;
      font-weight: 500;
      display: flex;
      flex-direction: column;
    }
    .main-header-title span.sub {
      font-size: 11px;
      color: var(--text-soft);
    }
    .header-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
      max-width: 55%;
    }
    .header-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    .header-btn {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #374151;
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .header-btn span.icon {
      font-size: 12px;
    }
    .header-btn:hover { border-color: var(--accent); }
    .header-btn:disabled { opacity: 0.5; cursor: default; }
    .tag-list {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      justify-content: flex-end;
    }
    .tag-chip {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(16,185,129,0.15);
      color: #a7f3d0;
      border: 1px solid rgba(16,185,129,0.35);
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px 18px 8px;
      background: radial-gradient(circle at top, #111827 0, #020617 45%, #000 100%);
    }
    .message-row {
      margin-bottom: 12px;
      display: flex;
    }
    .message-row.assistant { justify-content: flex-start; }
    .message-row.user { justify-content: flex-end; }
    .message-bubble {
      max-width: 70%;
      padding: 10px 12px;
      border-radius: 16px;
      font-size: 14px;
      line-height: 1.45;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .assistant .message-bubble {
      background: var(--bg-msg-assistant);
      border: 1px solid #1f2937;
    }
    .user .message-bubble {
      background: var(--bg-msg-user);
      border: 1px solid #374151;
    }
    .message-meta {
      font-size: 10px;
      color: var(--text-soft);
      margin-bottom: 2px;
      padding: 0 4px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .avatar {
      width: 20px;
      height: 20px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-right: 6px;
      font-size: 12px;
    }
    .avatar.assistant {
      background: rgba(16,185,129,0.15);
      color: #6ee7b7;
    }
    .avatar.user {
      background: rgba(59,130,246,0.15);
      color: #bfdbfe;
    }

    .input-bar {
      padding: 10px 16px 14px;
      border-top: 1px solid #111827;
      background: radial-gradient(circle at top, #020617 0, #000 100%);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .input-top {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: var(--text-soft);
      gap: 8px;
      flex-wrap: wrap;
    }
    .input-row {
      display: flex;
      align-items: flex-end;
      gap: 8px;
    }
    .input-box-wrap {
      flex: 1;
      position: relative;
    }
    .input-box {
      width: 100%;
      padding: 10px 40px 10px 12px;
      border-radius: 999px;
      border: 1px solid #374151;
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      font-size: 14px;
      resize: none;
      max-height: 100px;
      min-height: 40px;
      outline: none;
    }
    .input-box::placeholder { color: #6b7280; }
    .input-actions-right {
      position: absolute;
      right: 6px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .icon-btn {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      border: none;
      background: transparent;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #9ca3af;
      font-size: 14px;
    }
    .icon-btn:hover {
      background: rgba(31,41,55,0.9);
      color: #e5e7eb;
    }
    .send-btn {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      border: none;
      background: var(--accent);
      color: #022c22;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 16px;
    }
    .send-btn:disabled { opacity: 0.4; cursor: default; }
    .status-line {
      font-size: 11px;
      color: var(--text-soft);
      min-height: 14px;
    }
    .status-line.error { color: #fca5a5; }

    #file-input { display: none; }

    /* Test panel overlay */
    .test-panel {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.65);
      z-index: 40;
      font-size: 12px;
    }
    .test-panel-inner {
      width: min(960px, 95vw);
      max-height: 85vh;
      background: #020617;
      border-radius: 16px;
      border: 1px solid #111827;
      padding: 12px 16px 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .test-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      gap: 8px;
    }
    .test-panel-title-group {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .test-summary {
      font-size: 11px;
      color: var(--text-soft);
    }
    .test-panel-switch {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .test-body {
      border: 1px solid #111827;
      border-radius: 10px;
      padding: 10px;
      background: #020617;
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 55vh;
      overflow-y: auto;
    }
    .test-progress {
      font-size: 11px;
      color: #9ca3af;
    }
    .test-question {
      font-size: 13px;
      font-weight: 500;
    }
    .test-standards {
      font-size: 11px;
      color: #9ca3af;
    }
    .test-options label {
      display: block;
      margin-bottom: 4px;
      cursor: pointer;
    }
    .test-options input[type="radio"] {
      margin-right: 6px;
    }
    .test-explain-block label {
      font-size: 11px;
      color: #9ca3af;
      display: block;
      margin-bottom: 4px;
    }
    .test-explain-block textarea {
      width: 100%;
      min-height: 80px;
      max-height: 160px;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 12px;
      resize: vertical;
    }
    .test-feedback {
      font-size: 11px;
      color: #e5e7eb;
      min-height: 16px;
    }

    .test-panel-footer {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      margin-top: 6px;
      flex-wrap: wrap;
    }

    @media (max-width: 800px) {
      .sidebar { display: none; }
      .header-right { max-width: 60%; }
    }
  </style>

    <!-- pdfMake: th∆∞ vi·ªán xu·∫•t PDF c√≥ d·∫•u ti·∫øng Vi·ªát -->
  <script src="/static/js/pdfmake.min.js"></script>
  <script src="/static/js/vfs_fonts.js"></script>

  <script src="/static/js/segoeuithis-normal.js"></script>

  <!-- MathJax ƒë·ªÉ render c√¥ng th·ª©c -->
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']]
      },
      svg: { fontCache: 'global' }
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" async></script>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="logo">K9 Math AI</div>
        <div class="subtitle">Tr·ª£ l√Ω To√°n 9 ‚Äì AI for Good</div>
      </div>

      <div class="sidebar-footer">
        <div>Chu·∫©n ƒë·∫ßu ra (T1‚ÄìT15)</div>
        <div style="margin-top:4px;">
          <div class="badge">
            <span class="dot"></span>T1 ‚Äì S·ªë &amp; l≈©y th·ª´a
          </div>
          <div class="badge">
            <span class="dot"></span>T2 ‚Äì T·ªâ l·ªá &amp; ph·∫ßn trƒÉm
          </div>
          <div class="badge">
            <span class="dot"></span>T3 ‚Äì G√≥c &amp; tam gi√°c
          </div>
        </div>
      </div>
    </aside>

    <main class="main">
      <header class="main-header">
        <div class="main-header-title">
          <span>Chat v·ªõi Tr·ª£ l√Ω To√°n AI</span>
          <span class="sub">
            ƒê·∫∑t c√¢u h·ªèi, t·∫£i b√†i t·∫≠p, nh·ªù AI ph√¢n t√≠ch &amp; ph√¢n lo·∫°i theo chu·∫©n T1‚ÄìT15.
          </span>
        </div>
        <div class="header-right">
          <div class="header-actions">
            <button class="header-btn" id="btn-run-input">
              <span class="icon">üß™</span>
              <span>B√†i ki·ªÉm tra ƒë·∫ßu v√†o</span>
            </button>
            <button class="header-btn" id="btn-run-output">
              <span class="icon">üß™</span>
              <span>B√†i ki·ªÉm tra ƒë·∫ßu ra</span>
            </button>
            <button class="header-btn" id="btn-export-pdf-global" disabled>
              <span class="icon">üìÑ</span>
              <span>Xu·∫•t PDF b√°o c√°o</span>
            </button>
          </div>
          <div class="tag-list" id="header-tags"></div>
        </div>
      </header>

      <section class="messages" id="messages"></section>

      <!-- TEST PANEL -->
      <section class="test-panel" id="test-panel">
        <div class="test-panel-inner">
          <div class="test-panel-header">
            <div class="test-panel-title-group">
              <div id="test-panel-title">B√†i ki·ªÉm tra</div>
              <div class="test-summary" id="test-summary"></div>
            </div>
            <div class="test-panel-switch">
              <button class="header-btn" id="btn-close-test">‚úï ƒê√≥ng</button>
            </div>
          </div>

          <div class="test-body">
            <div class="test-progress" id="test-progress"></div>
            <div class="test-question" id="test-question"></div>
            <div class="test-standards" id="test-standards"></div>
            <div class="test-options" id="test-options"></div>
            <div class="test-explain-block">
              <label for="test-explain">Tr√¨nh b√†y c√°ch nghƒ© / l·ªùi gi·∫£i:</label>
              <textarea id="test-explain"></textarea>
            </div>
            <div class="test-feedback" id="test-feedback"></div>
          </div>

          <div class="test-panel-footer">
            <div style="display:flex; gap:6px; flex-wrap:wrap;">
              <button class="header-btn" id="btn-prev-q">‚óÄ Tr∆∞·ªõc</button>
              <button class="header-btn" id="btn-next-q">Ti·∫øp ‚ñ∂</button>
            </div>
            <div style="display:flex; gap:6px; flex-wrap:wrap;">
              <button class="header-btn" id="btn-grade-test">
                <span class="icon">‚úî</span>Ch·∫•m b√†i &amp; g·ª£i √Ω k·∫ø ho·∫°ch
              </button>
              <button class="header-btn" id="btn-export-pdf" disabled>
                <span class="icon">üìÑ</span>Xu·∫•t PDF b√°o c√°o
              </button>
            </div>
          </div>
        </div>
      </section>

      <section class="input-bar">
        <div class="input-top">
          <span>Tip: b·∫°n c√≥ th·ªÉ t·∫£i file PDF/TXT b√†i t·∫≠p, h·ªá th·ªëng s·∫Ω ƒë·ªçc &amp; ph√¢n t√≠ch.</span>
          <span id="status-text"></span>
        </div>
        <div class="input-row">
          <div class="input-box-wrap">
            <textarea id="chat-input" class="input-box" rows="1"
              placeholder="ƒê·∫∑t c√¢u h·ªèi To√°n 9 ho·∫∑c d√°n ƒë·ªÅ b√†i ·ªü ƒë√¢y..."></textarea>
            <div class="input-actions-right">
              <button class="icon-btn" id="btn-upload" title="T·∫£i file b√†i t·∫≠p">üìé</button>
            </div>
          </div>
          <button class="send-btn" id="btn-send">‚û§</button>
          <input type="file" id="file-input" accept=".txt,.pdf,.md,.json" />
        </div>
        <div class="status-line" id="status-line"></div>
      </section>
    </main>
  </div>

  <script>
    const API_BASE = "";

    const STANDARD_LABELS = {
      T1: "S·ªë & l≈©y th·ª´a",
      T2: "T·ªâ l·ªá & ph·∫ßn trƒÉm",
      T3: "G√≥c & tam gi√°c",
      T4: "CƒÉn b·∫≠c hai",
      T5: "Ph∆∞∆°ng tr√¨nh b·∫≠c nh·∫•t",
      T6: "H·ªá ph∆∞∆°ng tr√¨nh",
      T7: "B·∫•t ph∆∞∆°ng tr√¨nh",
      T8: "H√†m s·ªë & ƒë·ªì th·ªã",
      T9: "Tam gi√°c vu√¥ng & ƒë·ªãnh l√Ω Pythagore",
      T10: "ƒê∆∞·ªùng tr√≤n",
      T11: "Ti·∫øp tuy·∫øn",
      T12: "H√¨nh tr·ª•, n√≥n, c·∫ßu",
      T13: "Th·ªëng k√™",
      T14: "X√°c su·∫•t",
      T15: "B√†i to√°n th·ª±c t·∫ø"
    };

    // ==== CHAT ====
    const messagesEl = document.getElementById("messages");
    const headerTagsEl = document.getElementById("header-tags");
    const inputEl = document.getElementById("chat-input");
    const sendBtn = document.getElementById("btn-send");
    const statusLine = document.getElementById("status-line");
    const statusText = document.getElementById("status-text");
    const uploadBtn = document.getElementById("btn-upload");
    const fileInput = document.getElementById("file-input");

    let messages = []; // {role, content}
    let currentStandards = [];

    function renderMessages() {
      messagesEl.innerHTML = "";
      if (!messages.length) {
        const intro = document.createElement("div");
        intro.style.color = "#9ca3af";
        intro.style.fontSize = "13px";
        intro.style.maxWidth = "480px";
        intro.style.margin = "40px auto 0";
        intro.style.textAlign = "center";
        intro.innerHTML = "Ch√†o b·∫°n üëã<br>H√£y ƒë·∫∑t c√¢u h·ªèi To√°n 9, t·∫£i file b√†i t·∫≠p, ho·∫∑c nh·ªù m√¨nh ph√¢n t√≠ch l·ªói sai theo chu·∫©n T1‚ÄìT15.";
        messagesEl.appendChild(intro);
      } else {
        messages.forEach(msg => {
          const row = document.createElement("div");
          row.className = "message-row " + msg.role;

          const wrapper = document.createElement("div");
          const meta = document.createElement("div");
          meta.className = "message-meta";

          const avatar = document.createElement("span");
          avatar.className = "avatar " + msg.role;
          avatar.textContent = msg.role === "assistant" ? "AI" : "You";

          const metaText = document.createElement("span");
          metaText.textContent = msg.role === "assistant" ? "Tr·ª£ l√Ω To√°n AI" : "B·∫°n";

          meta.appendChild(avatar);
          meta.appendChild(metaText);

          const bubble = document.createElement("div");
          bubble.className = "message-bubble";
          bubble.textContent = msg.content;

          wrapper.appendChild(meta);
          wrapper.appendChild(bubble);
          row.appendChild(wrapper);
          messagesEl.appendChild(row);
        });
      }

      messagesEl.scrollTop = messagesEl.scrollHeight;

      if (window.MathJax && window.MathJax.typesetPromise) {
        window.MathJax.typesetPromise();
      }
    }

    function updateHeaderTags() {
      headerTagsEl.innerHTML = "";
      currentStandards.forEach(code => {
        const div = document.createElement("div");
        div.className = "tag-chip";
        div.textContent = code;
        headerTagsEl.appendChild(div);
      });
    }

    async function callChatAPI() {
      statusLine.textContent = "ƒêang suy nghƒ©‚Ä¶";
      statusLine.classList.remove("error");
      sendBtn.disabled = true;

      try {
        const res = await fetch(API_BASE + "/chat/message", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ messages })
        });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        messages.push({ role: "assistant", content: data.reply });
        currentStandards = data.standards || [];
        renderMessages();
        updateHeaderTags();
        statusLine.textContent = "";
      } catch (err) {
        console.error(err);
        statusLine.textContent = "Kh√¥ng g·ªçi ƒë∆∞·ª£c API /chat/message. Ki·ªÉm tra server.";
        statusLine.classList.add("error");
      } finally {
        sendBtn.disabled = false;
      }
    }

    async function sendMessage() {
      const text = inputEl.value.trim();
      if (!text) return;
      messages.push({ role: "user", content: text });
      inputEl.value = "";
      renderMessages();
      await callChatAPI();
    }

    // upload file
    uploadBtn.addEventListener("click", () => fileInput.click());
    fileInput.addEventListener("change", async () => {
      const file = fileInput.files[0];
      if (!file) return;

      statusLine.textContent = "ƒêang ƒë·ªçc file " + file.name + "‚Ä¶";
      statusLine.classList.remove("error");

      const formData = new FormData();
      formData.append("file", file);

      try {
        const res = await fetch(API_BASE + "/file/parse", {
          method: "POST",
          body: formData
        });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        const snippet = data.content.length > 600
          ? data.content.slice(0, 600) + "\n[...ƒë√£ c·∫Øt b·ªõt...]"
          : data.content;
        const text = `N·ªôi dung tr√≠ch t·ª´ file "${data.filename}":\n\n` + snippet;
        messages.push({ role: "user", content: text });
        renderMessages();
        await callChatAPI();
      } catch (err) {
        console.error(err);
        statusLine.textContent = "Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c file. Ki·ªÉm tra /file/parse.";
        statusLine.classList.add("error");
      } finally {
        fileInput.value = "";
      }
    });

    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
    sendBtn.addEventListener("click", sendMessage);

    // ==== TEST / QUIZ ====
    const btnRunInput = document.getElementById("btn-run-input");
    const btnRunOutput = document.getElementById("btn-run-output");
    const testPanel = document.getElementById("test-panel");
    const btnCloseTest = document.getElementById("btn-close-test");
    const testPanelTitle = document.getElementById("test-panel-title");
    const testSummary = document.getElementById("test-summary");
    const testProgress = document.getElementById("test-progress");
    const testQuestionEl = document.getElementById("test-question");
    const testStandardsEl = document.getElementById("test-standards");
    const testOptionsEl = document.getElementById("test-options");
    const testExplainEl = document.getElementById("test-explain");
    const testFeedbackEl = document.getElementById("test-feedback");
    const btnPrevQ = document.getElementById("btn-prev-q");
    const btnNextQ = document.getElementById("btn-next-q");
    const btnGradeTest = document.getElementById("btn-grade-test");
    const btnExportPdf = document.getElementById("btn-export-pdf");
    const btnExportPdfGlobal = document.getElementById("btn-export-pdf-global");

    let quizMode = "input";
    let quizData = null;   // {questions, answers, graded, perStandard, correctCount, total, styleStats}
    let lastTestResults = null;

    function classifyAnswerStyle(ans, q) {
      const expl = (ans.expl || "").trim();
      const len = expl.length;
      const choice = ans.choice;
      const isCorrect = choice === q.correct_index;

      if (choice == null) return "blank";
      if (isCorrect) {
        if (len < 15) return "correct_short";
        if (len < 40) return "correct_ok";
        return "correct_good";
      } else {
        if (!len) return "guess";
        if (len < 25) return "sloppy";
        return "wrong_explained";
      }
    }

    function feedbackFromStyle(ans, q) {
      const style = ans.style;
      const labelCorrect = String.fromCharCode(65 + (q.correct_index ?? 0));

      if (style === "blank") {
        return "Ch∆∞a l√†m / b·ªè tr·ªëng. H√£y th·ª≠ vi·∫øt m·ªôt h∆∞·ªõng gi·∫£i, d√π ch∆∞a ch·∫Øc.";
      }
      if (style === "correct_short") {
        return "ƒê√∫ng nh∆∞ng tr√¨nh b√†y r·∫•t ng·∫Øn. N√™n ghi r√µ h∆°n c√°c b∆∞·ªõc ƒë·ªÉ sau n√†y d·ªÖ xem l·∫°i.";
      }
      if (style === "correct_ok") {
        return "ƒê√∫ng v√† tr√¨nh b√†y t·∫°m ·ªïn. C√≥ th·ªÉ b·ªï sung l√Ω do / c√¥ng th·ª©c em d√πng.";
      }
      if (style === "correct_good") {
        return "ƒê√∫ng v√† tr√¨nh b√†y kh√° ƒë·∫ßy ƒë·ªß. Ti·∫øp t·ª•c gi·ªØ th√≥i quen n√†y üëå";
      }
      if (style === "guess") {
        return `Sai, c√≥ v·∫ª khoanh b·ª´a ho·∫∑c kh√¥ng tr√¨nh b√†y. ƒê√°p √°n ƒë√∫ng l√† ${labelCorrect}. H√£y th·ª≠ vi·∫øt suy nghƒ© c·ªßa m√¨nh.`;
      }
      if (style === "sloppy") {
        return `Sai v√† tr√¨nh b√†y c√≤n v·ªôi. ƒê√°p √°n ƒë√∫ng l√† ${labelCorrect}. H√£y l√†m ch·∫≠m h∆°n v√† ki·ªÉm tra t·ª´ng b∆∞·ªõc.`;
      }
      if (style === "wrong_explained") {
        return `Sai nh∆∞ng ƒë√£ c√≥ tr√¨nh b√†y. ƒê√°p √°n ƒë√∫ng l√† ${labelCorrect}. So s√°nh v·ªõi l·ªùi gi·∫£i chu·∫©n ƒë·ªÉ xem nh·∫ßm ·ªü ƒë√¢u.`;
      }
      return `ƒê√°p √°n ƒë√∫ng l√† ${labelCorrect}.`;
    }

    function describeStandardLevel(total, correct) {
      if (!total) return "Ch∆∞a c√≥ c√¢u h·ªèi nh√≥m n√†y.";
      const r = correct / total;
      if (r >= 0.8) return "M·∫°nh ‚Äì em l√†m t·ªët h·∫ßu h·∫øt c√¢u h·ªèi.";
      if (r >= 0.5) return "Trung b√¨nh ‚Äì ƒë√£ n·∫Øm ƒë∆∞·ª£c m·ªôt ph·∫ßn, n√™n luy·ªán th√™m.";
      return "C·∫ßn c·ªßng c·ªë ‚Äì n√™n √¥n l·∫°i l√Ω thuy·∫øt v√† l√†m th√™m b√†i m·∫´u.";
    }

    function overallText(total, correct) {
      if (!total) return "Ch∆∞a c√≥ ƒë·ªß d·ªØ li·ªáu ƒë·ªÉ ƒë√°nh gi√°.";
      const r = correct / total;
      if (r >= 0.8) {
        return "K·∫øt qu·∫£ kh√° t·ªët. Em c√≥ th·ªÉ b·∫Øt ƒë·∫ßu luy·ªán c√°c d·∫°ng b√†i n√¢ng cao, ƒë·ªìng th·ªùi √¥n nhanh c√°c d·∫°ng c∆° b·∫£n ƒë·ªÉ gi·ªØ phong ƒë·ªô.";
      } else if (r >= 0.5) {
        return "K·∫øt qu·∫£ ·ªü m·ª©c trung b√¨nh. Em ƒë√£ n·∫Øm ƒë∆∞·ª£c m·ªôt ph·∫ßn ki·∫øn th·ª©c nh∆∞ng v·∫´n c·∫ßn luy·ªán th√™m c√°c d·∫°ng c∆° b·∫£n, l√†m b√†i ch·∫≠m l·∫°i v√† ki·ªÉm tra c·∫©n th·∫≠n t·ª´ng b∆∞·ªõc.";
      }
      return "K·∫øt qu·∫£ cho th·∫•y em c·∫ßn t·∫≠p trung c·ªßng c·ªë l·∫°i ki·∫øn th·ª©c c∆° b·∫£n. N√™n xem l·∫°i l√Ω thuy·∫øt trong SGK, v·ªü ghi v√† l√†m th√™m b√†i t·∫≠p m·∫´u cho t·ª´ng chu·∫©n T1‚ÄìT15.";
    }

    function buildPresentationSummary(styleStats, totalQuestions) {
      if (!totalQuestions || !styleStats) {
        return "Ch∆∞a ƒë·ªß th√¥ng tin ƒë·ªÉ ƒë√°nh gi√° th√≥i quen tr√¨nh b√†y.";
      }
      const get = k => styleStats[k] || 0;
      const blank = get("blank");
      const guess = get("guess");
      const sloppy = get("sloppy");
      const correctShort = get("correct_short");
      const correctOk = get("correct_ok");
      const correctGood = get("correct_good");
      const wrongExpl = get("wrong_explained");

      const lines = [];
      if (correctGood + correctOk > 0) {
        lines.push(`C√≥ ${correctGood + correctOk}/${totalQuestions} c√¢u em tr√¨nh b√†y kh√° r√µ r√†ng. ƒê√¢y l√† ƒëi·ªÉm m·∫°nh, h√£y gi·ªØ th√≥i quen ghi ƒë·ªß b∆∞·ªõc.`);
      }
      if (correctShort > 0) {
        lines.push(`${correctShort} c√¢u ƒë√∫ng nh∆∞ng tr√¨nh b√†y c√≤n qu√° ng·∫Øn. Em n√™n ghi th√™m l√Ω do / c√¥ng th·ª©c ƒë·ªÉ khi xem l·∫°i kh√¥ng qu√™n c√°ch l√†m.`);
      }
      if (blank + guess > 0) {
        lines.push(`C√≥ ${blank + guess} c√¢u em b·ªè tr·ªëng ho·∫∑c ch·ªâ khoanh ƒë√°p √°n. H√£y c·ªë g·∫Øng vi·∫øt ra suy nghƒ© c·ªßa m√¨nh, k·ªÉ c·∫£ ch∆∞a ch·∫Øc ch·∫Øn.`);
      }
      if (sloppy + wrongExpl > 0) {
        lines.push(`${sloppy + wrongExpl} c√¢u sai nh∆∞ng v·∫´n c√≥ tr√¨nh b√†y. Em n√™n so s√°nh v·ªõi l·ªùi gi·∫£i chu·∫©n ƒë·ªÉ t√¨m ch√≠nh x√°c b∆∞·ªõc b·ªã nh·∫ßm.`);
      }
      if (!lines.length) {
        lines.push("Th√≥i quen tr√¨nh b√†y hi·ªán ch∆∞a r√µ r√†ng, c·∫ßn th√™m d·ªØ li·ªáu ƒë·ªÉ ƒë√°nh gi√°.");
      }
      return lines.join(" ");
    }

    function buildQuarterPlan(perStandard) {
      const codes = Object.keys(perStandard || {});
      if (!codes.length) {
        return [
          "Ch∆∞a c√≥ d·ªØ li·ªáu r√µ r√†ng cho t·ª´ng chu·∫©n. Em c√≥ th·ªÉ b·∫Øt ƒë·∫ßu √¥n l·∫ßn l∆∞·ª£t t·ª´ T1 ƒë·∫øn T5, m·ªói ng√†y l√†m 3‚Äì5 b√†i c∆° b·∫£n v√† nh·ªù Tr·ª£ l√Ω To√°n AI ph√¢n t√≠ch c√°c c√¢u sai."
        ];
      }

      const items = codes.map(code => {
        const info = perStandard[code];
        const ratio = info.total ? info.correct / info.total : 0;
        return { code, ratio, total: info.total };
      }).sort((a, b) => a.ratio - b.ratio);

      const focus = items.slice(0, 4);
      const focusCodes = focus.map(i => i.code);
      if (!focusCodes.length) focusCodes.push("T1", "T2", "T3");

      const lines = [];
      const TOTAL_WEEKS = 12;
      const WEEK_PER_MONTH = 4;

      for (let w = 1; w <= TOTAL_WEEKS; w++) {
        const month = Math.floor((w - 1) / WEEK_PER_MONTH) + 1;
        const weekInMonth = ((w - 1) % WEEK_PER_MONTH) + 1;
        const code = focusCodes[(w - 1) % focusCodes.length];
        const label = STANDARD_LABELS[code] || ("Chu·∫©n " + code);
        lines.push(
          `Th√°ng ${month}, tu·∫ßn ${weekInMonth}: t·∫≠p trung v√†o ${code} ‚Äì ${label}. √în l√Ω thuy·∫øt, l√†m 3‚Äì5 b√†i ti√™u bi·ªÉu, sau ƒë√≥ nh·ªù Tr·ª£ l√Ω To√°n AI gi·∫£i chi ti·∫øt c√°c c√¢u sai.`
        );
      }

      return lines;
    }

    function openTestPanel(mode) {
      quizMode = mode;
      testPanel.style.display = "flex";
      testSummary.textContent = "ƒêang t·∫£i c√¢u h·ªèi...";
      btnExportPdf.disabled = true;
      btnExportPdfGlobal.disabled = true;
      quizData = null;
      lastTestResults = null;
      loadQuiz();
    }

    function closeTestPanel() {
      testPanel.style.display = "none";
    }

    async function loadQuiz() {
      const endpoint = quizMode === "input" ? "/api/input_quiz" : "/api/output_quiz";
      try {
        const res = await fetch(API_BASE + endpoint);
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        const questions = data.questions || [];
        if (!questions.length) throw new Error("Kh√¥ng c√≥ c√¢u h·ªèi.");
        quizData = {
          questions,
          currentIndex: 0,
          answers: questions.map(() => ({ choice: null, expl: "", style: null, isCorrect: false })),
          graded: false,
          perStandard: {},
          correctCount: 0,
          total: questions.length,
          styleStats: {}
        };

        const modeLabel = quizMode === "input" ? "ƒë·∫ßu v√†o" : "ƒë·∫ßu ra";
        testPanelTitle.textContent = "B√†i ki·ªÉm tra " + modeLabel + " T1‚ÄìT15";
        testSummary.textContent = "Ch·ªçn ƒë√°p √°n A‚ÄìD v√† tr√¨nh b√†y c√°ch nghƒ©. Sau khi l√†m xong, b·∫•m \"Ch·∫•m b√†i\" ƒë·ªÉ nh·∫≠n b√°o c√°o & k·∫ø ho·∫°ch h·ªçc.";
        renderCurrentQuestion();
      } catch (err) {
        console.error(err);
        testSummary.textContent = "L·ªói t·∫£i c√¢u h·ªèi: " + err.message;
      }
    }

    function renderCurrentQuestion() {
      if (!quizData) return;
      const idx = quizData.currentIndex;
      const q = quizData.questions[idx];
      const ans = quizData.answers[idx];

      testProgress.textContent = `C√¢u ${idx + 1} / ${quizData.questions.length}`;
      testQuestionEl.textContent = q.text;
      testStandardsEl.textContent = "Chu·∫©n li√™n quan: " + (q.standards || []).join(", ");

      testOptionsEl.innerHTML = "";
      (q.options || []).forEach((opt, i) => {
        const label = document.createElement("label");
        const radio = document.createElement("input");
        radio.type = "radio";
        radio.name = "test-option";
        radio.value = String(i);
        if (ans.choice === i) radio.checked = true;
        label.appendChild(radio);
        label.appendChild(document.createTextNode(" " + String.fromCharCode(65 + i) + ". " + opt));
        testOptionsEl.appendChild(label);
      });

      testExplainEl.value = ans.expl || "";
      if (quizData.graded && ans.style) {
        testFeedbackEl.textContent = feedbackFromStyle(ans, q);
      } else {
        testFeedbackEl.textContent = "";
      }

      btnPrevQ.disabled = idx === 0;
      btnNextQ.disabled = idx === quizData.questions.length - 1;
    }

    function saveCurrentAnswer() {
      if (!quizData) return;
      const idx = quizData.currentIndex;
      const ans = quizData.answers[idx];
      const selected = document.querySelector('input[name="test-option"]:checked');
      ans.choice = selected ? parseInt(selected.value, 10) : null;
      ans.expl = testExplainEl.value.trim();
    }

    function goPrev() {
      if (!quizData) return;
      saveCurrentAnswer();
      if (quizData.currentIndex > 0) {
        quizData.currentIndex -= 1;
        renderCurrentQuestion();
      }
    }

    function goNext() {
      if (!quizData) return;
      saveCurrentAnswer();
      if (quizData.currentIndex < quizData.questions.length - 1) {
        quizData.currentIndex += 1;
        renderCurrentQuestion();
      }
    }

    function gradeTest() {
      if (!quizData) return;
      saveCurrentAnswer();

      const { questions, answers } = quizData;
      let correct = 0;
      const perStandard = {};
      const styleStats = {};
      const results = [];

      questions.forEach((q, idx) => {
        const ans = answers[idx];
        const isCorrect = ans.choice === q.correct_index;
        ans.isCorrect = isCorrect;

        const style = classifyAnswerStyle(ans, q);
        ans.style = style;
        styleStats[style] = (styleStats[style] || 0) + 1;

        if (isCorrect) correct++;

        (q.standards || []).forEach(code => {
          if (!perStandard[code]) perStandard[code] = { total: 0, correct: 0 };
          perStandard[code].total += 1;
          if (isCorrect) perStandard[code].correct += 1;
        });

        results.push({
          index: idx + 1,
          question: q.text,
          choice: ans.choice,
          explanation: ans.expl,
          standards: q.standards || [],
          isCorrect,
          style
        });
      });

      quizData.graded = true;
      quizData.perStandard = perStandard;
      quizData.correctCount = correct;
      quizData.styleStats = styleStats;

      const modeLabel = quizMode === "input" ? "ƒë·∫ßu v√†o" : "ƒë·∫ßu ra";
      testSummary.textContent = `ƒê√£ ch·∫•m xong b√†i ${modeLabel}. H√£y xem l·∫°i t·ª´ng c√¢u, sau ƒë√≥ xu·∫•t PDF ƒë·ªÉ l·∫•y k·∫ø ho·∫°ch h·ªçc theo qu√Ω.`;

      lastTestResults = {
        mode: quizMode,
        totalQuestions: questions.length,
        correctCount: correct,
        perStandard,
        results,
        styleStats
      };

      btnExportPdf.disabled = !questions.length;
      btnExportPdfGlobal.disabled = !questions.length;

      // ƒê·∫©y 1 t√≥m t·∫Øt v√†o c·ª≠a s·ªï chat cho vui
      const weakCodes = Object.keys(perStandard).filter(c => {
        const info = perStandard[c];
        return info.total && info.correct / info.total < 0.8;
      });
      const summaryLine =
        `T√≥m t·∫Øt b√†i ${modeLabel}: em l√†m ƒë√∫ng ${correct}/${questions.length} c√¢u. ` +
        (weakCodes.length
          ? `M·ªôt s·ªë chu·∫©n c·∫ßn ch√∫ √Ω th√™m: ${weakCodes.join(", ")}.`
          : "Ch∆∞a th·∫•y chu·∫©n n√†o qu√° y·∫øu, nh∆∞ng v·∫´n n√™n √¥n l·∫°i to√†n b·ªô T1‚ÄìT15.");
      messages.push({ role: "assistant", content: summaryLine });
      renderMessages();

      renderCurrentQuestion();
    }

        function exportPdfReport() {
      if (!lastTestResults) return;

      if (!window.pdfMake || !window.pdfMake.createPdf) {
        alert("Kh√¥ng t·∫£i ƒë∆∞·ª£c th∆∞ vi·ªán pdfMake ƒë·ªÉ xu·∫•t PDF.");
        return;
      }

      const s = lastTestResults;
      const modeLabel =
        s.mode === "input"
          ? "ƒë·∫ßu v√†o"
          : s.mode === "output"
          ? "ƒë·∫ßu ra"
          : "quiz luy·ªán t·∫≠p";

      const overall = overallText(s.totalQuestions, s.correctCount);
      const present = buildPresentationSummary(
        s.styleStats,
        s.totalQuestions
      );

      // 2. Theo t·ª´ng chu·∫©n
      const standardLines = [];
      const codes = Object.keys(s.perStandard || {}).sort();
      if (!codes.length) {
        standardLines.push(
          "Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªß r√µ ƒë·ªÉ ph√¢n t√≠ch theo t·ª´ng chu·∫©n."
        );
      } else {
        codes.forEach((code) => {
          const info = s.perStandard[code];
          const line =
            `${code} ‚Äì ${
              STANDARD_LABELS[code] || "Chu·∫©n " + code
            }: ` + describeStandardLevel(info.total, info.correct);
          standardLines.push(line);
        });
      }

      // 3. K·∫ø ho·∫°ch 3 th√°ng
      const scheduleLines = buildQuarterPlan(s.perStandard || {});

      // ==== Build n·ªôi dung pdfMake ====
      const content = [];

      content.push({
        text: `B√°o c√°o & k·∫ø ho·∫°ch h·ªçc theo qu√Ω ‚Äì B√†i ${modeLabel} T1‚ÄìT15 ‚Äì K9 Math AI Assistant`,
        style: "header",
      });

      content.push({
        text: `Th·ªùi gian: ${new Date().toLocaleString("vi-VN")}`,
        margin: [0, 4, 0, 10],
        fontSize: 10,
      });

      // 1. T·ªïng quan
      content.push({ text: "1. ƒê√°nh gi√° t·ªïng quan", style: "subheader" });
      content.push({
        text: overall,
        margin: [0, 2, 0, 10],
        fontSize: 10,
      });

      // 1b. Tr√¨nh b√†y
      content.push({
        text: "1.b. Nh·∫≠n x√©t v·ªÅ th√≥i quen tr√¨nh b√†y",
        style: "subheader",
      });
      content.push({
        text: present,
        margin: [0, 2, 0, 10],
        fontSize: 10,
      });

      // 2. Theo chu·∫©n
      content.push({
        text: "2. ƒê√°nh gi√° theo t·ª´ng nh√≥m chu·∫©n T1‚ÄìT15",
        style: "subheader",
      });
      standardLines.forEach((line) => {
        content.push({
          text: line,
          margin: [0, 1, 0, 2],
          fontSize: 10,
        });
      });

      // 3. K·∫ø ho·∫°ch
      content.push({
        text: "3. K·∫ø ho·∫°ch h·ªçc theo qu√Ω (3 th√°ng, 12 tu·∫ßn)",
        style: "subheader",
        margin: [0, 8, 0, 2],
      });
      scheduleLines.forEach((line) => {
        content.push({
          text: line,
          margin: [0, 1, 0, 2],
          fontSize: 10,
        });
      });

      const docDefinition = {
        content,
        defaultStyle: {
          font: "Roboto", // t·ª´ vfs_fonts.js ‚Äì h·ªó tr·ª£ Unicode
          fontSize: 11,
        },
        styles: {
          header: {
            fontSize: 14,
            bold: true,
            margin: [0, 0, 0, 6],
          },
          subheader: {
            fontSize: 12,
            bold: true,
            margin: [0, 6, 0, 3],
          },
        },
      };

      pdfMake
        .createPdf(docDefinition)
        .download(`Bao_cao_${modeLabel.replace(" ", "_")}_T1-T15.pdf`);
    }


    btnRunInput.addEventListener("click", () => openTestPanel("input"));
    btnRunOutput.addEventListener("click", () => openTestPanel("output"));
    btnCloseTest.addEventListener("click", closeTestPanel);
    btnPrevQ.addEventListener("click", goPrev);
    btnNextQ.addEventListener("click", goNext);
    btnGradeTest.addEventListener("click", gradeTest);
    btnExportPdf.addEventListener("click", exportPdfReport);
    btnExportPdfGlobal.addEventListener("click", exportPdfReport);

    // init
    renderMessages();
    statusText.textContent = "Server: " + window.location.origin;
  </script>
</body>
</html>


